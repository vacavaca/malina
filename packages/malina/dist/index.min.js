"use strict";Object.defineProperty(exports,"__esModule",{value:true});var h=require("malina-util");function m(e){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){m=function(e){return typeof e}}else{m=function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}}return m(e)}function l(e,t,n,r,i,a,o){try{var s=e[a](o);var l=s.value}catch(e){n(e);return}if(s.done){t(l)}else{Promise.resolve(l).then(r,i)}}function c(s){return function(){var e=this,o=arguments;return new Promise(function(t,n){var r=s.apply(e,o);function i(e){l(r,t,n,i,a,"next",e)}function a(e){l(r,t,n,i,a,"throw",e)}i(undefined)})}}function u(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function e(e,t,n){if(t)r(e.prototype,t);if(n)r(e,n);return e}function i(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function f(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};var r=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))}r.forEach(function(e){i(t,e,n[e])})}return t}function b(e,t){return n(e)||o(e,t)||d()}function A(e){return t(e)||a(e)||s()}function t(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function n(e){if(Array.isArray(e))return e}function a(e){if(Symbol.iterator in Object(e)||Object.prototype.toString.call(e)==="[object Arguments]")return Array.from(e)}function o(e,t){var n=[];var r=true;var i=false;var a=undefined;try{for(var o=e[Symbol.iterator](),s;!(r=(s=o.next()).done);r=true){n.push(s.value);if(t&&n.length===t)break}}catch(e){i=true;a=e}finally{try{if(!r&&o["return"]!=null)o["return"]()}finally{if(i)throw a}}return n}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function d(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var v=function e(t,n,r,i){u(this,e);this.template=t;this.state=n;this.actions=r;this.hooks=i};var y=function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;return new v(t instanceof Function?t:function(){return t},n,r,i)};var p=function(){function r(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];u(this,r);if(e==null)throw new Error("JSX tag empty ");this.tag=e;this.attrs=t;this.children=n}e(r,[{key:"toString",value:function e(){var t=typeof this.tag==="string"?this.tag:"View";return"".concat(t," ").concat(JSON.stringify(this.attrs||{})).concat(this.children.length>0?"\n".concat(this.children.map(function(e){if(e==null)return"\t''";var t=e.toString();return t.split("\n").map(function(e){return"\t".concat(e)}).join("\n")}).join("\n")):"")}}]);return r}();var N=function e(t){return t instanceof p&&t.tag instanceof v};var E=function e(t){return t instanceof p&&!N(t)};var w=function e(t){return typeof t==="string"};var g=function e(t,n){for(var r=arguments.length,i=new Array(r>2?r-2:0),a=2;a<r;a++){i[a-2]=arguments[a]}var o=i.length===1&&Array.isArray(i[0])?i[0]:i;return new p(t,n,o)};var k=function e(t){return"on".concat(t[0].toUpperCase()).concat(t.substr(1))};var V=function e(t){var n=t.toLowerCase();return n.startsWith("on")?n.substr(2):n};var x=function e(t){var n=t.isSvg,r=n===void 0?false:n;u(this,e);this.isSvg=r};var T=function e(t){return Array.isArray(t)&&t.length===2&&t[0]instanceof Function};var L=function e(t,n){return T(t)&&T(n)&&t[0]===n[0]&&t[1]===n[1]};var S=false;var P=[];var F=new x({});var I=new x({isSvg:true});var C=function e(t){return t.length===0};var z=function e(t,n){return t.tag===n.tag};var j=function e(n){return n.every(function(e,t){return t===0||!N(e)||!N(n[t-1])||e.attrs.key||!z(e,n[t-1])})};var O=function(){function l(e,t){u(this,l);var n=e.tag,r=e.attrs,i=e.children;var a=n.state instanceof Function?n.state(r):n.state;var o=n.actions instanceof Function?n.actions(r):n.actions;var s=n.hooks instanceof Function?n.hooks(r):n.hooks;this.template=n.template;this.state=f({},a||{},r||{});this.actions=this.bindActions(o||{});this.children=i;this.hooks=s||{};this.renderingContext=t||F;this.templateLock=false;this.updateLock=false;this.element=null;this.node=null;this.innerViews=new Map;this.parametrizedEventListeners=new Map;this.scheduledActions=[];this.mounted=false;this.destroyed=false;this.trackedActionUpdate=false;this.container=this.callHook("create")}e(l,[{key:"mount",value:function e(t,n){var r=this;var i=t.ownerDocument;if(this.destroyed)return;var a=false;if(!S){S=true;a=true}var o=this.renderTemplate();if(Array.isArray(o))throw new Error("View can only have one root element");if(E(o)){if(o.tag==="svg")this.renderingContext=I;var s=this.mountNodeElement(t,n,o,[]);this.element=s}else if(N(o)){var l=this.instantiateInnerView(o,[]);l.mount(t,n);this.element=l.element}else{var u=i.createTextNode("".concat(o!=null?o:""));this.element=u;var h=t.childNodes[n]||null;t.insertBefore(u,h)}this.node=o;this.mounted=true;var c=true;var f=false;var d=undefined;try{for(var v=this.scheduledActions[Symbol.iterator](),m;!(c=(m=v.next()).done);c=true){var y=b(m.value,2),p=y[0],w=y[1];this.callAction.apply(this,[p].concat(A(w)))}}catch(e){f=true;d=e}finally{try{if(!c&&v.return!=null){v.return()}}finally{if(f){throw d}}}this.scheduledActions=[];if(a){for(var g=0;g<P.length;g++){var k=P[g];k()}this.callHook("mount");S=false}else P.push(function(){return r.callHook("mount")})}},{key:"update",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(this.destroyed)throw new Error("View has been destroyed");var r=this.updateState(t);var i=this.updateChildrenState(n);var e=this.state!==r||this.children!==i;this.state=r;this.children=i;if(this.mounted&&e){this.refresh();this.callHook("update")}return e}},{key:"refresh",value:function e(){var t=this.renderTemplate();var n=this.node;this.node=t;this.patch(this.element,n,t,[])}},{key:"unmount",value:function e(t){this.mounted=false;if(E(this.node))this.destroyInnerViews(this.node,[]);else if(N(this.node))this.destroyInnerView([]);if(t)this.element.remove();this.callHook("unmount");this.element=null}},{key:"destroy",value:function e(t){this.unmount(t);this.callHook("destroy");this.destroyed=true}},{key:"renderTemplate",value:function e(){this.templateLock=true;var t=this.template(this.state,this.actions,this.children);if(Array.isArray(t))throw new Error("Only one root element must be rendered for a view");t=t!=null?t:"";this.templateLock=false;return t}},{key:"bindActions",value:function e(i){var a=this;var n={};var t=true;var r=false;var o=undefined;try{var s=function e(){var r=u.value;var t=i[r];if(t instanceof Function)n[r]=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++){t[n]=arguments[n]}return a.callAction.apply(a,[i[r]].concat(t))};else n[r]=a.bindActions(t)};for(var l=h.keys(i)[Symbol.iterator](),u;!(t=(u=l.next()).done);t=true){s()}}catch(e){r=true;o=e}finally{try{if(!t&&l.return!=null){l.return()}}finally{if(r){throw o}}}return n}},{key:"callAction",value:function e(t){var r=this;if(this.templateLock)throw new Error("Actions can't be called while rendering view template");for(var n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++){i[a-1]=arguments[a]}if(this.mounted){var o=!this.updateLock;this.updateLock=true;var s=t.apply(void 0,i)(this.state,this.actions);if(s instanceof Promise){this.updateLock=false;if(this.trackedActionUpdate)this.refresh();this.trackedActionUpdate=false;return c(regeneratorRuntime.mark(function e(){var n;return regeneratorRuntime.wrap(function e(t){while(1){switch(t.prev=t.next){case 0:t.next=2;return s;case 2:n=t.sent;if(!r.destroyed)r.update(n);return t.abrupt("return",r.state);case 5:case"end":return t.stop()}}},e,this)}))()}else{if(o){if(!this.destroyed&&this.mounted){var l=this.update(s);if(!l&&this.trackedActionUpdate)this.refresh();this.trackedActionUpdate=false}else if(!this.destroyed)this.state=this.updateState(s)}else{var u=this.updateState(s);this.trackedActionUpdate=this.trackedActionUpdate||this.state!==u;this.state=u}this.updateLock=false;return this.state}}else this.scheduledActions.push([t,i])}},{key:"updateState",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t==null||t===this.state)return this.state;var n=t!==null?f({},this.state,t):this.state;return!h.shallowEqual(this.state,n)?n:this.state}},{key:"updateChildrenState",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t===null||t===null)return this.children;var n=this.children==null||this.children.length===0;var r=t.length===0;if(n!==r)return t;else return!h.shallowEqual(this.children,t)?t:this.children}},{key:"callHook",value:function e(t){if(t in this.hooks)this.hooks[t](this.element,this.state,this.actions)}},{key:"patch",value:function e(t,n,r,i){if(n===r)return;if(E(n)){if(r==null)this.patchFromNodeToNone(t,n,i);else if(E(r))this.patchFromNodeToNode(t,n,r,i);else if(N(r))this.patchFromNodeToView(t,n,r,i);else this.patchFromNodeToText(t,n,r,i)}else if(N(n)){if(r==null)this.patchFromViewToNone(t,n,i);else if(E(r))this.patchFromViewToNode(t,n,r,i);else if(N(r))this.patchFromViewToView(t,n,r,i);else this.patchFromViewToText(t,n,r,i)}else{if(r==null)this.patchFromTextToNone(t,i);else if(E(r))this.patchFromTextToNode(t,r,i);else if(N(r))this.patchFromTextToView(t,r,i);else this.patchTextNodes(t,n,r,i)}}},{key:"patchFromTextToNone",value:function e(t,n){if(C(n))throw new Error("Root element deleted during patch");t.parentNode.removeChild(t)}},{key:"patchTextNodes",value:function e(t,n,r,i){if(n!==r){var a=t.ownerDocument.createTextNode("".concat(r));t.replaceWith(a);if(C(i))this.element=a}}},{key:"patchFromTextToNode",value:function e(t,n,r){var i=this.createNodeElement(t.ownerDocument,n,r);t.replaceWith(i);if(C(r))this.element=i}},{key:"patchFromTextToView",value:function e(t,n,r){var i=this.instantiateInnerView(n,r);var a=Array.from(t.parentNode.childNodes).findIndex(function(e){return e===t});var o=t.parentNode;t.remove();i.mount(o,a);if(C(r))this.element=i.element}},{key:"patchFromNodeToNone",value:function e(t,n,r){if(C(r))throw new Error("Root element deleted during patch");this.removeParametrizedListeners(n,r);this.destroyInnerViews(n,r);t.remove()}},{key:"patchFromNodeToText",value:function e(t,n,r,i){this.removeParametrizedListeners(n,i);this.destroyInnerViews(n,i);var a=t.ownerDocument.createTextNode("".concat(r));t.replaceWith(a);if(C(i))this.element=a}},{key:"patchFromNodeToNode",value:function e(t,n,r,i){if(n===r)return;if(n.tag===r.tag){this.updateAttributes(t,n,r,i);this.updateChildren(t,n,r,i)}else{this.removeParametrizedListeners(n,i);this.destroyInnerViews(n,i);var a=this.createNodeElement(t.ownerDocument,r,i);t.replaceWith(a);if(C(i))this.element=a}}},{key:"patchFromNodeToView",value:function e(t,n,r,i){this.removeParametrizedListeners(n,i);this.destroyInnerViews(n,i);var a=this.instantiateInnerView(r,i);var o=Array.from(t.parentNode.childNodes).findIndex(function(e){return e===t});var s=t.parentNode;t.remove();a.mount(s,o);if(C(i))this.element=a.element}},{key:"patchFromViewToNone",value:function e(t,n,r){if(C(r))throw new Error("Root element deleted during patch");this.destroyInnerView(r);t.remove()}},{key:"patchFromViewToText",value:function e(t,n,r,i){this.destroyInnerView(i);var a=t.ownerDocument.createTextNode("".concat(r));t.replaceWith(a);if(C(i))this.element=a}},{key:"patchFromViewToNode",value:function e(t,n,r,i){this.destroyInnerView(i);var a=this.createNodeElement(t.ownerDocument,r,i);t.replaceWith(a);if(C(i))this.element=a}},{key:"patchFromViewToView",value:function e(t,n,r,i){if(n===r)return;if(z(n,r)&&n.attrs.key===r.attrs.key){var a=this.getInstantiatedView(i);a.update(r.attrs,r.children)}else{this.destroyInnerView(i);var o=this.instantiateInnerView(r,i);var s=Array.from(t.parentNode.childNodes).findIndex(function(e){return e===t});var l=t.parentNode;t.remove();o.mount(l,s);if(C(i))this.element=o.element}}},{key:"unmountPatch",value:function e(){this.mounted=false;this.callHook("unmount");this.element=null}},{key:"destroyInnerViews",value:function e(t,n){for(var r in t.children){var i=n.concat([r]);var a=t.children[r];if(N(a))this.destroyInnerView(i);else if(E(a))this.destroyInnerViews(a,i)}}},{key:"destroyInnerView",value:function e(t){var n=this.getInstantiatedView(t);n.destroy(false);this.removeInstantiatedView(t)}},{key:"createNodeElement",value:function e(t,n,r){var i;if(this.renderingContext.isSvg)i=t.createElementNS("http://www.w3.org/2000/svg",n.tag);else i=t.createElement(n.tag);this.refreshAttributes(i,n,r);this.refreshChildren(i,n,r);return i}},{key:"mountNodeElement",value:function e(t,n,r,i){var a=t.ownerDocument;var o;if(this.renderingContext.isSvg)o=a.createElementNS("http://www.w3.org/2000/svg",r.tag);else o=a.createElement(r.tag);this.refreshAttributes(o,r,i);var s=t.childNodes[n]||null;t.insertBefore(o,s);this.refreshChildren(o,r,i,true);return o}},{key:"refreshAttributes",value:function e(t,n,r){for(var i in n.attrs){var a=n.attrs[i];this.addAttribute(t,i,a,r)}}},{key:"updateAttributes",value:function e(t,n,r,i){if(n===r)return;for(var a in r.attrs){var o=r.attrs[a];if(a in n.attrs){var s=n.attrs[a];this.updateAttribute(t,a,s,o,i)}else this.addAttribute(t,a,o,i)}for(var l in n.attrs){if(!(l in r.attrs))this.removeAttribute(t,l,n.attrs[l],i)}}},{key:"addAttribute",value:function e(t,n,r,i){if(n==="style"){for(var a in r){this.setStyleProp(t,a,r[a]||"")}}else if(r instanceof Function)this.addEventListener(t,V(n),r);else if(T(r)){var o=this.createParametrizedListener(r[0],r[1],i,n);var s=V(n);this.addEventListener(t,s,o)}else if(n==="data"&&r!=null&&m(r)==="object"){for(var l in r){t.dataset[l]=r[l]}}else if(n!=="focus"&&n in t&&!this.renderingContext.isSvg&&r!=null)t[n]=r;else if(typeof r==="boolean"){if(n==="focus"&&t.focus&&t.blur){if(r)t.focus();else t.blur()}else t.setattribute(n,n)}else if(r!=null)t.setAttribute(n,r)}},{key:"updateAttribute",value:function e(t,n,r,i,a){if(r===i)return;if(L(r,i))return;if(n==="style"){for(var o in r){if(!(o in i))this.removeStyleProp(t,o)}for(var s in i){var l=i[s]||"";this.setStyleProp(t,s,l)}}else if(i instanceof Function){this.removeAttribute(t,n,r,a);this.addAttribute(t,n,i,a)}else if(T(i)){this.removeAttribute(t,n,r,a);this.addAttribute(t,n,i,a)}else if(n==="data"){var u=r!=null&&m(r)==="object";var h=i!=null&&m(i)==="object";if(u&&h){for(var c in r){if(!(c in i))delete t.dataset[c]}for(var f in i){t.dataset[f]=i[f]}}else if(u&&!h){for(var d in t.dataset){delete t.dataset[d]}}else if(!u&&h){for(var v in i){t.dataset[v]=i[v]}}}else if(n!=="focus"&&n in t&&!this.renderingContext.isSvg)t[n]=i;else if(typeof r==="boolean"){if(n==="focus"){if(t.focus&&t.blur){if(i)t.focus();else t.blur()}}else{if(i)t.setAttribute(n,n);else t.removeAttribute(n)}}else{if(i!=null)t.setAttribute(n,i);else t.removeAttribute(i)}}},{key:"removeAttribute",value:function e(t,n,r,i){if(n==="style")t.style.cssText="";else if(r instanceof Function){var a=V(n);this.removeEventListener(t,a,r)}else if(T(r)){var o=this.getParametrizedListener(i,n);var s=V(n);this.removeEventListener(t,s,o)}else if(n==="data"&&r!=null&&m(r)==="object"){for(var l in t.dataset){delete t.dataset[l]}}else if(n!=="focus"&&n in t&&!this.renderingContext.isSvg)t[n]=undefined;else if(typeof r==="boolean"){if(n==="focus"&&t.blur)t.blur();else t.removeAttribute(n)}else if(r!=null)t.removeAttribute(n)}},{key:"setStyleProp",value:function e(t,n,r){if(n[0]==="-"){var i=r.indexOf("!important");var a=r;if(i!==-1)a=i!==r.slice(0,i)+r.slice(i+10);a=a.trim().replace(/;$/,"");t.style.setProperty(n,a)}else t.style[n]=r}},{key:"removeStyleProp",value:function e(t,n){if(n[0]==="-")t.style.removeProperty(n);else delete t.style[n]}},{key:"addEventListener",value:function e(i,a,t){if(i.addEventListener)i.addEventListener(a,t);else if(i.attachEvent)i.attachEvent(k(a),t);else{var n=i[a]&&i[a].listeners||[];if(i[a]!=null)i[a].listeners=n.concat(t);else{var r=function e(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++){n[r]=arguments[r]}return i[a].listeners.map(function(e){return e.apply(void 0,n)})};r.listeners=n.concat(t);i[a]=r}}}},{key:"removeEventListener",value:function e(t,n,r){if(t.removeEventListener)t.removeEventListener(n,r);else if(t.detachEvent)t.detachEvent(k(n),r);else{if(t[n]!=null&&t[n].listeners!=null)t[n].listeners=t[n].listener.filter(function(e){return e!==r})}}},{key:"refreshChildren",value:function e(t,n,r){var i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(!j(n.children))throw new Error("Every view node in an array must have an unique 'key' attribute");for(var a in n.children){var o=n.children[a];var s=r.concat([a]);this.addChildren(t,o,a,s,i)}}},{key:"addChildren",value:function e(t,n){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var i=arguments.length>3?arguments[3]:undefined;var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;if(E(n)){if(a)this.mountNodeElement(t,null,n,i);else{var o=this.createNodeElement(t.ownerDocument,n,i);t.appendChild(o)}}else if(N(n)){var s=this.instantiateInnerView(n,i);s.mount(t,r)}else if(n!=null){var l=t.ownerDocument.createTextNode("".concat(n));t.appendChild(l)}}},{key:"updateChildren",value:function e(t,n,r,i){if(n===r)return;if(!j(r.children))throw new Error("Every view node in an array must have an unique 'key' attribute");var a=Math.max(n.children.length,r.children.length);var o=0;for(var s=0;s<a;s++){var l=t.childNodes[s-o];var u=n.children[s];var h=s in r.children?r.children[s]:null;var c=i.concat([s]);if(u!=null){this.patch(l,u,h,c);if(h==null)o+=1}else{this.addChildren(t,h,s,c);o-=1}}}},{key:"instantiateInnerView",value:function e(t,n){var r=l.getPathKey(n);var i=l.instantiate(t,this.renderingContext);this.innerViews.set(r,{view:i,path:n.slice()});return i}},{key:"getInstantiatedView",value:function e(t){var n=l.getPathKey(t);var r=this.innerViews.get(n);return r!=null?r.view:null}},{key:"removeInstantiatedView",value:function e(t){var n=l.getPathKey(t);this.innerViews.delete(n)}},{key:"getParametrizedListener",value:function e(t,n){var r=l.getAttrKey(t,n);return this.parametrizedEventListeners.get(r)}},{key:"hasParametrizedListener",value:function e(t,n){var r=l.getAttrKey(t,n);return this.parametrizedEventListeners.has(r)}},{key:"createParametrizedListener",value:function e(i,a,t,n){var r=function e(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++){n[r]=arguments[r]}return i.apply(void 0,A(a).concat(n))};var o=l.getAttrKey(t,n);this.parametrizedEventListeners.set(o,r);return r}},{key:"removeParametrizedListeners",value:function e(t,n){for(var r in t.attrs){if(this.hasParametrizedListener(n,r))this.removeParametrizedListener(n,r)}for(var i in t.children){var a=n.concat([i]);var o=t.children[i];if(E(o))this.removeParametrizedListeners(o,a)}}},{key:"removeParametrizedListener",value:function e(t,n){var r=l.getAttrKey(t,n);this.parametrizedEventListeners.delete(r)}}],[{key:"instantiate",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!N(t))throw new Error("View can only be instantiated from view-nodes");return new l(t,n)}},{key:"getPathKey",value:function e(t){return t.join(".")}},{key:"getAttrKey",value:function e(t,n){return"".concat(n,".").concat(l.getPathKey(t))}}]);return l}();var D=function e(t,n){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var i=n;if(E(n))i=g(y(n));var a=t.ownerDocument.defaultView;var o=t instanceof a.SVGElement?I:F;var s=O.instantiate(i,o);s.mount(t,r);return s};var K=function e(n){return function(r){var e;if(r instanceof v)e=r;else if(typeof r==="string")e=y(function(e,t,n){return g(r,e,n)});else e=y(r);var t=n(e);if(t instanceof v)return t;else return y(t)}};exports.view=y;exports.h=g;exports.isElementNode=E;exports.isViewNode=N;exports.isTextNode=w;exports.Node=p;exports.mount=D;exports.decorator=K;
