"use strict";Object.defineProperty(exports,"__esModule",{value:true});var e=require("malina-util");var t=require("diff");class n{constructor(t,n,r,i){this.template=t;this.state=n;this.actions=r;this.hooks=i;this.id=e.genRandomId(8);this.originalId=null}static isViewDeclaration(e){return typeof e==="object"&&e!==null&&e.isViewDeclaration instanceof Function&&e.isViewDeclaration()}isViewDeclaration(){return true}decorate(...t){return e.compose(...t)(this)}}const r=(e,t=null,r=null,i=null)=>new n(e instanceof Function?e:()=>e,t,r,i);const i=n;class s{constructor(t,n={},r=[]){if(t==null)throw new Error("Node tag cannot be empty");this.tag=t;this.attrs=n||{};this.children=e.flatten(r)}static isNode(e){return typeof e==="object"&&e!==null&&e.isNode instanceof Function&&e.isNode()}isNode(){return true}toString(){const e=Object.keys(this.attrs).reduce((e,t)=>{const n=this.attrs[t];if(typeof n==="string")return`${e} ${t}="${n}"`;else if(n instanceof Function)return`${e} ${t}=[Function]`;else return`${e} ${t}={${typeof n!=="object"?JSON.stringify(n):"{...}"}}`},"");const t=typeof this.tag==="string"?this.tag:"[View]";if(this.children.length>0){return`<${t}${e}>\n${this.children.map(e=>{if(e==null)return'\t""';const t=e.toString();return t.split("\n").map(e=>`\t${e}`).join("\n")}).join("\n")}\n</${t}>`}else return`<${t}${e}/>`}}const o=e=>s.isNode(e)&&i.isViewDeclaration(e.tag);const a=e=>s.isNode(e)&&!i.isViewDeclaration(e.tag);const l=e=>!(e instanceof Object)&&typeof e!=="object";const c=(e,t,...n)=>{const r=n.length===1&&Array.isArray(n[0])?n[0]:n;return new s(e,t,r)};function u(e,t,n,r,i,s,o){try{var a=e[s](o);var l=a.value}catch(e){n(e);return}if(a.done){t(l)}else{Promise.resolve(l).then(r,i)}}function d(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var s=e.apply(t,n);function o(e){u(s,r,i,o,a,"next",e)}function a(e){u(s,r,i,o,a,"throw",e)}o(undefined)})}}function h(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function f(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};var r=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))}r.forEach(function(t){h(e,t,n[t])})}return e}function m(e,t){return v(e)||p(e,t)||y()}function v(e){if(Array.isArray(e))return e}function p(e,t){var n=[];var r=true;var i=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){n.push(a.value);if(t&&n.length===t)break}}catch(e){i=true;s=e}finally{try{if(!r&&o["return"]!=null)o["return"]()}finally{if(i)throw s}}return n}function y(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}const w=e=>`on${e[0].toUpperCase()}${e.substr(1)}`;const g=e=>{const t=e.toLowerCase();return t.startsWith("on")?t.substr(2):t};class b{constructor(e){this.options=e}get svg(){return this.options.isSvg}get mounting(){return this.options.mounting}get store(){return this.options.store}setSvg(e){return this.update({isSvg:e})}setMounting(e){return this.update({mounting:e})}update(e){return new b(f({},this.options,e))}}const x=e=>new b(e);let N="production";try{N=process.env.NODE_ENV}catch(e){}const A=N==="production";const E=!A;const V=typeof self==="object"&&self.self===self&&self||typeof global==="object"&&global.global===global&&global||this;const k="console"in V;const T=k&&"warn"in V.console;const L=e=>{if(E&&T)V.console.warn(e)};const P=e=>Array.isArray(e)&&e.length===2&&e[0]instanceof Function;const F=(e,t)=>P(e)&&P(t)&&e[0]===t[0]&&e[1]===t[1];const I=e=>e.length===0;const S=(e,t)=>e.tag.id===t.tag.id;const D=e=>{const t=e.children;if(!t.every((e,n)=>n===0||!o(e)||!o(t[n-1])||e.attrs.key||!S(e,t[n-1])))throw new Error("Every view node in an array must have a 'key' attribute");return e};const $=e=>{const t=e.children;let n={};var r=true;var i=false;var s=undefined;try{for(var a=t[Symbol.iterator](),l;!(r=(l=a.next()).done);r=true){const e=l.value;if(o(e)&&e.attrs.key){if(!(e.tag.id in n))n[e.tag.id]={};if(e.attrs.key in n[e.tag.id])throw new Error("Every view node in an array must have an unique 'key' attribute");n[e.tag.id][e.attrs.key]=true}}}catch(e){i=true;s=e}finally{try{if(!r&&a.return!=null){a.return()}}finally{if(i){throw s}}}return e};const z=e=>{const t=e.attrs,n=e.children;if("innerHtml"in t&&t.innerHtml!=null&&n!=null&&n.length>0)throw new Error('Nodes with "innerHtml" attribute must not have children');return e};const H=e.compose(D,$,z);class j{constructor(e,t){const n=e.tag,r=e.attrs,i=e.children;const s=n.state instanceof Function?f({},r,n.state(r)||{}):f({},n.state||{},r);const o=n.actions instanceof Function?n.actions(r):n.actions;const a=n.hooks instanceof Function?n.hooks(r):n.hooks;this.template=n.template;this.state=s;this.actions=this.bindActions(o||{});this.children=i;this.hooks=a||{};this.context=t.setMounting(false);this.templateLock=false;this.updateLock=false;this.element=null;this.node=null;this.innerViews=new Map;this.parametrizedEventListeners=new Map;this.scheduledActions=[];this.mounted=false;this.destroyed=false;this.trackedActionUpdate=false;this.callHook("create")}static instantiate(e,t){if(!o(e))throw new Error("View can only be instantiated from view-nodes");return new q(e,t)}mount(e,t){const n=e.ownerDocument;if(this.destroyed)return;let r=false;if(!this.context.store.mountLock){this.context.store.mountLock=true;r=true}const i=this.renderTemplate();if(Array.isArray(i))throw new Error("View can only have one root element");if(a(i)){const n=this.mountNodeElement(e,t,i,[],this.context);this.element=n}else if(o(i)){const n=this.instantiateInnerView(i,[],this.context);n.mount(e,t);this.element=n.element}else if(l(i)){const r=n.createTextNode(`${i!=null?i:""}`);this.element=r;const s=e.childNodes[t]||null;e.insertBefore(r,s)}else throw new Error("Invalid template type");this.node=i;this.mounted=true;var s=true;var c=false;var u=undefined;try{for(var d=this.scheduledActions[Symbol.iterator](),h;!(s=(h=d.next()).done);s=true){const e=m(h.value,2),t=e[0],n=e[1];this.callAction(t,...n)}}catch(e){c=true;u=e}finally{try{if(!s&&d.return!=null){d.return()}}finally{if(c){throw u}}}this.scheduledActions=[];if(r){const e=this.context.store.mountHookQueue;this.context.store.mountHookQueue=[];this.context.store.mountLock=false;var f=true;var v=false;var p=undefined;try{for(var y=e[Symbol.iterator](),w;!(f=(w=y.next()).done);f=true){const e=w.value;e()}}catch(e){v=true;p=e}finally{try{if(!f&&y.return!=null){y.return()}}finally{if(v){throw p}}}this.callHook("mount")}else this.context.store.mountHookQueue.push(()=>this.callHook("mount"))}move(e,t){const n=e.childNodes[t]||null;e.insertBefore(this.element,n);this.container=e;this.index=t}update(e=null,t=null){if(this.destroyed)throw new Error("View has been destroyed");const n=this.updateState(e);const r=this.updateChildrenState(t);const i=this.state!==n||this.children!==r;this.state=n;this.children=r;if(this.mounted&&i){this.refresh();this.callHook("update")}return i}refresh(){const e=this.renderTemplate();const t=this.node;this.node=e;this.patch(this.element,t,e,[],this.context)}unmount(e){this.mounted=false;if(a(this.node))this.destroyInnerViews(this.node,[]);else if(o(this.node))this.destroyInnerView([]);if(e)this.element.remove();this.callHook("unmount");this.element=null}destroy(e=true){this.unmount(e);this.callHook("destroy");this.destroyed=true}static getPathKey(e){return e.join(".")}static getAttrKey(e,t){return`${t}.${q.getPathKey(e)}`}renderTemplate(){this.templateLock=true;try{let e=this.template(this.state,this.actions,this.children);if(Array.isArray(e)){if(e.length!==1)throw new Error("Only one root element must be rendered for a view");e=e[0]}e=e!=null?e:"";return e}finally{this.templateLock=false}}bindActions(t){const n={};var r=true;var i=false;var s=undefined;try{for(var o=e.keys(t)[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){const e=a.value;const r=t[e];if(r instanceof Function)n[e]=((...n)=>this.callAction(t[e],...n));else n[e]=this.bindActions(r)}}catch(e){i=true;s=e}finally{try{if(!r&&o.return!=null){o.return()}}finally{if(i){throw s}}}return n}callAction(e,...t){var n=this;if(this.templateLock)throw new Error("Actions can't be called while rendering view template");const r=!this.updateLock;this.updateLock=true;let i=e(...t)(this.state,this.actions);if(i instanceof Promise){return d(function*(){n.finishAction(r);i=yield i;n.finishAction(r,i);return n.state})()}else{this.finishAction(r,i);return this.state}}finishAction(e,t=null){this.updateLock=false;if(e){if(!this.destroyed&&this.mounted){const e=this.update(t);if(!e&&this.trackedActionUpdate){this.trackedActionUpdate=false;this.refresh();this.callHook("update")}else this.trackedActionUpdate=false}else if(!this.destroyed)this.state=this.updateState(t)}else{const e=this.updateState(t);this.trackedActionUpdate=this.trackedActionUpdate||this.state!==e;this.state=e}}updateState(t=null){if(t==null||t===this.state)return this.state;const n=t!==null?f({},this.state,t):this.state;return!e.shallowEqual(this.state,n)?n:this.state}updateChildrenState(t=null){if(t===null||t===null)return this.children;const n=this.children==null||this.children.length===0;const r=t.length===0;if(n!==r)return t;else return!e.shallowEqual(this.children,t)?t:this.children}callHook(e){if(e in this.hooks)this.hooks[e](this.element,this.state,this.actions)}patch(e,t,n,r,i){if(t===n)return;if(a(t)){if(n==null)this.patchFromNodeToNone(e,t,r);else if(a(n))this.patchFromNodeToNode(e,t,n,r,i);else if(o(n))this.patchFromNodeToView(e,t,n,r,i);else if(l(n))this.patchFromNodeToText(e,t,n,r);else throw new Error("Invalid template type")}else if(o(t)){if(n==null)this.patchFromViewToNone(e,t,r);else if(a(n))this.patchFromViewToNode(e,t,n,r,i);else if(o(n))this.patchFromViewToView(e,t,n,r,i);else if(l(n))this.patchFromViewToText(e,t,n,r);else throw new Error("Invalid template type")}else{if(n==null)this.patchFromTextToNone(e,r);else if(a(n))this.patchFromTextToNode(e,n,r,i);else if(o(n))this.patchFromTextToView(e,n,r,i);else if(l(n))this.patchTextNodes(e,t,n,r);else throw new Error("Invalid template type")}}patchFromTextToNone(e,t){if(I(t))throw new Error("Root element deleted during patch");e.parentNode.removeChild(e)}patchTextNodes(e,t,n,r){if(t!==n){const t=e.ownerDocument.createTextNode(`${n}`);e.replaceWith(t);if(I(r))this.element=t}}patchFromTextToNode(e,t,n,r){const i=this.createNodeElement(e.ownerDocument,t,n,r);e.replaceWith(i);if(I(n))this.element=i}patchFromTextToView(e,t,n,r){const i=this.instantiateInnerView(t,n,r);const s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();i.mount(o,s);if(I(n))this.element=i.element}patchFromNodeToNone(e,t,n){if(I(n))throw new Error("Root element deleted during patch");this.removeParametrizedListeners(t,n);this.destroyInnerViews(t,n);e.remove()}patchFromNodeToText(e,t,n,r){this.removeParametrizedListeners(t,r);this.destroyInnerViews(t,r);const i=e.ownerDocument.createTextNode(`${n}`);e.replaceWith(i);if(I(r))this.element=i}patchFromNodeToNode(e,t,n,r,i){if(t===n)return;if(t.tag===n.tag){this.updateAttributes(e,t,n,r,i);this.updateChildren(e,t,n,r,i)}else{this.removeParametrizedListeners(t,r);this.destroyInnerViews(t,r);const s=this.createNodeElement(e.ownerDocument,n,r,i);e.replaceWith(s);if(I(r))this.element=s}}patchFromNodeToView(e,t,n,r,i){this.removeParametrizedListeners(t,r);this.destroyInnerViews(t,r);const s=this.instantiateInnerView(n,r,i);const o=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const a=e.parentNode;e.remove();s.mount(a,o);if(I(r))this.element=s.element}patchFromViewToNone(e,t,n){if(I(n))throw new Error("Root element deleted during patch");this.destroyInnerView(n);e.remove()}patchFromViewToText(e,t,n,r){this.destroyInnerView(r);const i=e.ownerDocument.createTextNode(`${n}`);e.replaceWith(i);if(I(r))this.element=i}patchFromViewToNode(e,t,n,r,i){this.destroyInnerView(r);const s=this.createNodeElement(e.ownerDocument,n,r,i);e.replaceWith(s);if(I(r))this.element=s}patchFromViewToView(e,t,n,r,i){if(t===n)return;if(S(t,n)&&t.attrs.key===n.attrs.key){const e=this.getInstantiatedView(r);e.update(n.attrs,n.children)}else{this.destroyInnerView(r);const t=this.instantiateInnerView(n,r,i);const s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();t.mount(o,s);if(I(r))this.element=t.element}}unmountPatch(){this.mounted=false;this.callHook("unmount");this.element=null}destroyInnerViews(e,t){for(const n in e.children){const r=t.concat([n]);const i=e.children[n];if(o(i))this.destroyInnerView(r);else if(a(i))this.destroyInnerViews(i,r)}}destroyInnerView(e){const t=this.getInstantiatedView(e);t.destroy(false);this.removeInstantiatedView(e)}createNodeElement(e,t,n,r){let i;r=r.setSvg(r.svg||t.tag==="svg");if(r.svg)i=e.createElementNS("http://www.w3.org/2000/svg",t.tag);else i=e.createElement(t.tag);this.refreshAttributes(i,t,n,r);this.refreshChildren(i,t,n,r);return i}mountNodeElement(e,t,n,r,i){const s=e.ownerDocument;let o;i=i.setSvg(i.svg||n.tag==="svg").setMounting(true);if(i.svg)o=s.createElementNS("http://www.w3.org/2000/svg",n.tag);else o=s.createElement(n.tag);this.refreshAttributes(o,n,r,i);const a=e.childNodes[t]||null;e.insertBefore(o,a);this.refreshChildren(o,n,r,i);return o}refreshAttributes(e,t,n,r){for(const i in t.attrs){if(i==="innerHtml")continue;const s=t.attrs[i];this.addAttribute(e,i,s,n,r)}}updateAttributes(e,t,n,r,i){if(t===n)return;for(const s in n.attrs){if(s==="innerHtml")continue;const o=n.attrs[s];if(s in t.attrs){const n=t.attrs[s];this.updateAttribute(e,s,n,o,r,i)}else this.addAttribute(e,s,o,r,i)}for(const s in t.attrs){if(s==="innerHtml")continue;if(!(s in n.attrs))this.removeAttribute(e,s,t.attrs[s],r,i)}}addAttribute(e,t,n,r,i){if(t==="style"){for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,g(t),n);else if(P(n)){const i=this.createParametrizedListener(n[0],n[1],r,t);const s=g(t);this.addEventListener(e,s,i)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t!=="focus"&&t in e&&!i.svg&&n!=null)e[t]=n;else if(typeof n==="boolean"){if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}else e.setAttribute(t,t)}else if(n!=null)e.setAttribute(t,n)}updateAttribute(e,t,n,r,i,s){if(n===r)return;if(F(n,r))return;if(t==="style"){for(const t in n){if(!(t in r))this.removeStyleProp(e,t)}for(const t in r){const n=r[t]||"";this.setStyleProp(e,t,n)}}else if(r instanceof Function){this.removeAttribute(e,t,n,i);this.addAttribute(e,t,r,i)}else if(P(r)){this.removeAttribute(e,t,n,i);this.addAttribute(e,t,r,i)}else if(t==="data"){const t=n!=null&&typeof n==="object";const i=r!=null&&typeof r==="object";if(t&&i){for(const t in n){if(!(t in r))delete e.dataset[t]}for(const t in r)e.dataset[t]=r[t]}else if(t&&!i){for(const t in e.dataset)delete e.dataset[t]}else if(!t&&i){for(const t in r)e.dataset[t]=r[t]}}else if(t!=="focus"&&t in e&&!s.svg)e[t]=r;else if(typeof n==="boolean"){if(t==="focus"){if(e.focus&&e.blur){if(r)e.focus();else e.blur()}}else{if(r)e.setAttribute(t,t);else e.removeAttribute(t)}}else{if(r!=null)e.setAttribute(t,r);else if(n!=null)e.removeAttribute(t)}}removeAttribute(e,t,n,r,i){if(t==="style")e.style.cssText="";else if(n instanceof Function){const r=g(t);this.removeEventListener(e,r,n)}else if(P(n)){const n=this.getParametrizedListener(r,t);const i=g(t);this.removeEventListener(e,i,n)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in e.dataset)delete e.dataset[t]}else if(t!=="focus"&&t in e&&!i.svg)e[t]=undefined;else if(typeof n==="boolean"){if(t==="focus"&&e.blur)e.blur();else e.removeAttribute(t)}else if(n!=null)e.removeAttribute(t)}setStyleProp(e,t,n){if(t[0]==="-"){const r=n.indexOf("!important");let i=n;if(r!==-1)i=r!==n.slice(0,r)+n.slice(r+10);i=i.trim().replace(/;$/,"");e.style.setProperty(t,i)}else e.style[t]=n}removeStyleProp(e,t){if(t[0]==="-")e.style.removeProperty(t);else delete e.style[t]}addEventListener(e,t,n){if(e.addEventListener)e.addEventListener(t,n);else if(e.attachEvent)e.attachEvent(w(t),n);else{const r=e[t]&&e[t].listeners||[];if(e[t]!=null)e[t].listeners=r.concat(n);else{const i=(...n)=>e[t].listeners.map(e=>e(...n));i.listeners=r.concat(n);e[t]=i}}}removeEventListener(e,t,n){if(e.removeEventListener)e.removeEventListener(t,n);else if(e.detachEvent)e.detachEvent(w(t),n);else{if(e[t]!=null&&e[t].listeners!=null)e[t].listeners=e[t].listener.filter(e=>e!==n)}}refreshChildren(e,t,n,r){if(!H(t))throw new Error("Every view node in an array must have an unique 'key' attribute");if("innerHtml"in t.attrs)e.innerHTML=t.attrs.innerHtml;else{for(const i in t.children){const s=t.children[i];const o=n.concat([i]);this.addChildren(e,s,i,o,r)}}}addChildren(e,t,n=null,r,i){if(a(t)){if(i.mounting)this.mountNodeElement(e,n,t,r,i);else{const n=this.createNodeElement(e.ownerDocument,t,r,i);e.appendChild(n)}}else if(o(t)){const s=this.instantiateInnerView(t,r,i);s.mount(e,n)}else if(t!=null){const n=e.ownerDocument.createTextNode(`${t}`);e.appendChild(n)}}updateChildren(e,t,n,r,i){if(t===n)return;if(!H(n))throw new Error("Every view node in an array must have an unique 'key' attribute");if("innerHtml"in n.attrs)e.innerHTML=n.attrs.innerHtml;else{i=i.setSvg(i.svg||n.tag==="svg");const s=Math.max(t.children.length,n.children.length);let o=0;for(let a=0;a<s;a++){const s=e.childNodes[a-o];const l=t.children[a];const c=a in n.children?n.children[a]:null;const u=r.concat([a]);if(l!=null){this.patch(s,l,c,u,i);if(c==null)o+=1}else{this.addChildren(e,c,a,u,i);o-=1}}}}instantiateInnerView(e,t,n){const r=q.getPathKey(t);const i=q.instantiate(e,n);this.innerViews.set(r,{view:i,path:t.slice()});return i}getInstantiatedView(e){const t=q.getPathKey(e);const n=this.innerViews.get(t);return n!=null?n.view:null}removeInstantiatedView(e){const t=q.getPathKey(e);this.innerViews.delete(t)}getParametrizedListener(e,t){const n=q.getAttrKey(e,t);return this.parametrizedEventListeners.get(n)}hasParametrizedListener(e,t){const n=q.getAttrKey(e,t);return this.parametrizedEventListeners.has(n)}createParametrizedListener(e,t,n,r){const i=(...n)=>e(...t,...n);const s=q.getAttrKey(n,r);this.parametrizedEventListeners.set(s,i);return i}removeParametrizedListeners(e,t){for(const n in e.attrs){if(this.hasParametrizedListener(t,n))this.removeParametrizedListener(t,n)}for(const n in e.children){const r=t.concat([n]);const i=e.children[n];if(a(i))this.removeParametrizedListeners(i,r)}}removeParametrizedListener(e,t){const n=q.getAttrKey(e,t);this.parametrizedEventListeners.delete(n)}}if(E){let e=false;var O=true;var C=false;var K=undefined;try{for(var M=Object.getOwnPropertyNames(j.prototype)[Symbol.iterator](),U;!(O=(U=M.next()).done);O=true){const t=U.value;if(j.prototype[t]instanceof Function){const n=j.prototype[t];j.prototype[t]=function(...t){const r=!e;e=true;try{return n.apply(this,t)}catch(e){if(r){if(this.node!=null)e.message=`${e.message}\n\tThis error has occurred in view:\n${this.node}`}throw e}finally{if(r)e=false}}}}}catch(e){C=true;K=e}finally{try{if(!O&&M.return!=null){M.return()}}finally{if(C){throw K}}}}const q=j;const W=(e,t,n=0,{insideSvg:i=false}={})=>{let s=t;if(a(t))s=c(r(t));const o={mountLock:false,mountHookQueue:[]};let l=x({store:o}).setSvg(i);if(!l.svg){const t=e.ownerDocument.defaultView;l=l.setSvg(e instanceof t.SVGElement)}const u=q.instantiate(s,l);u.mount(e,n);return u};const B=e=>t=>{let n;if(i.isViewDeclaration(t))n=t;else if(typeof t==="string")n=r((e,n,r)=>c(t,e,r));else n=r(t);let s=e(n);if(!i.isViewDeclaration(s))s=r(s);if(n.originalId!=null)s.originalId=n.originalId;else s.originalId=n.id;return s};const Q=e=>{if(e==null)return(e,t)=>t;if(e instanceof Function)return e;else return t=>t[e]};const R=e=>({data:e.data||[],accessor:Q(e.indexBy),render:e.render,path:e.path,mountPoint:null,initialized:false,views:{},index:[],prevData:[]});const _=r(({render:e})=>e);const Y={};const G=e=>{let t=0;const n=[];var r=true;var i=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){const e=a.value;if(e.added){var l=true;var c=false;var u=undefined;try{for(var d=e.value[Symbol.iterator](),h;!(l=(h=d.next()).done);l=true){const e=h.value;n.push({added:true,value:e,index:t});t+=1}}catch(e){c=true;u=e}finally{try{if(!l&&d.return!=null){d.return()}}finally{if(c){throw u}}}}else if(e.removed){var f=true;var m=false;var v=undefined;try{for(var p=e.value[Symbol.iterator](),y;!(f=(y=p.next()).done);f=true){const e=y.value;n.push({removed:true,value:e,index:t})}}catch(e){m=true;v=e}finally{try{if(!f&&p.return!=null){p.return()}}finally{if(m){throw v}}}}else{var w=true;var g=false;var b=undefined;try{for(var x=e.value[Symbol.iterator](),N;!(w=(N=x.next()).done);w=true){const e=N.value;n.push({value:e,index:t});t+=1}}catch(e){g=true;b=e}finally{try{if(!w&&x.return!=null){x.return()}}finally{if(g){throw b}}}}}}catch(e){i=true;s=e}finally{try{if(!r&&o.return!=null){o.return()}}finally{if(i){throw s}}}const A={};for(const e in n){const t=n[e];if(t.added)A[t.value]=e}for(let e=0;e<n.length;e++){const t=n[e];if(t.removed&&t.value in A){n.splice(e,1);e--}}return n};Y.initialize=(()=>e=>{const t=m(e.mountPoint,2),n=t[0],r=t[1];if(e.path.length===0)n.childNodes[r].remove();e.initialized=true;e.index=[];e.views={};for(const t in e.data){const i=+t;const s=e.data[i];const o=e.accessor(s,i,e.data);e.index.push(o);const a=c(_,{render:e.render(s,i,e.data)});const l=W(n,a,r+i);e.views[o]={view:l,index:r+i}}J(e.index);e.prevData=e.data});const J=e=>{const t={};var n=true;var r=false;var i=undefined;try{for(var s=e[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;if(e in t)throw new Error("Item keys must be unique");t[e]=true}}catch(e){r=true;i=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(r){throw i}}}return e};Y.diffUpdate=(()=>e=>{const n=m(e.mountPoint,2),r=n[0],i=n[1];const s=e.data.map(e.accessor);J(s);const o=t.diffArrays(e.index,s);const a=G(o);const l={};for(const t in a){const n=a[t];const s=n.value;const o=+n.index;const u=s in e.views;if(n.added&&s!==e.index[o]){if(u){const t=n.index;const i=e.index[t];const o=e.views[s],a=o.index,c=o.view;const u=e.views[i].view;c.move(r,t);if(e.prevData[a]!==e.data[t])c.update({render:e.render(e.data[t],t,e.data)});u.move(r,a+1);if(e.prevData[t]!==e.data[a])u.update({render:e.render(e.data[a],t,e.data)});e.views[s]={view:c,index:t};e.views[i]={view:u,index:a};l[s]=true;l[i]=true}else{const t=e.data[o];const n=c(_,{render:e.render(t,o,e.data)});const a=W(r,n,i+o);e.views[s]={view:a,index:i+o}}}else if(n.removed){const t=e.views[s].view;t.destroy();delete e.views[s]}else if(!(s in l)){const t=e.data[o];if(t!==e.prevData[o])e.views[s].view.update({render:e.render(t,o,e.data)})}}e.index=s;e.prevData=e.data});Y.update=(()=>(e,t)=>{if(e.mountPoint==null)return;if(e.initialized)t.diffUpdate();else t.initialize()});const X={};X.mount=((e,t,n)=>{if(t.path.length>0){let n=e;var r=true;var i=false;var s=undefined;try{for(var o=t.path.slice(0,-1)[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){const e=a.value;n=n.childNodes[e]}}catch(e){i=true;s=e}finally{try{if(!r&&o.return!=null){o.return()}}finally{if(i){throw s}}}t.mountPoint=[n,t.path[t.path.length-1]]}else t.mountPoint=[e.parentNode,Array.prototype.indexOf.call(e.parentNode.childNodes,e)];n.update()});X.update=((e,t,n)=>{n.update()});X.unmount=((e,t)=>{t.mountPoint=null;t.initialized=false;t.views={};t.index=[];t.prevData=[]});const Z=r((e,t,n)=>n,R,Y,X);const ee=(e,t=[])=>{if(e instanceof Function)return[t,e];if(a(e)){for(const n in e.children){const r=t.concat([+n]);const i=ee(e.children[n],r);if(i!=null)return i}}};const te=(e,t)=>{if(a(e)){let n;if(t.length===1){const r=t[t.length-1];n=e.children.slice(0,r).concat(e.children.slice(r+1))}else{const r=t[0];n=e.children.map((e,n)=>{if(n===r)return te(e,t.slice(1));else return e})}return c(e.tag,e.attrs,n)}else return e};const ne=r((e,t,n)=>{if(n.length!==0){if(n.length!==1)throw new Error("You must provide only one child to the List");let t;let s=[];let o;if(!(n[0]instanceof Function)){var r=ee(n[0]);var i=m(r,2);s=i[0];o=i[1];t=te(n[0],s)}else{o=n[0];t=null}return c(Z,f({},e,{path:s,render:o}),t)}else return null});const re=r((t,n,r)=>{if(r.length!==1)throw new Error("You must provide only one child to the List");let i=r;let s=[];let o;if(!(r[0]instanceof Function)){var a=ee(r[0]);var l=m(a,2);s=l[0];o=l[1];i=te(r[0],s)}else o=r[0];const u=([e,t],n,r)=>o(t,e,r,n);const d=e.keys(t.data||{}).map(e=>[e,t.data[e]]);const h=([e])=>e;return c(Z,{data:d,indexBy:h,path:s,render:u},i)},{data:{}});exports.view=r;exports.h=c;exports.isElementNode=a;exports.isViewNode=o;exports.isTextNode=l;exports.Node=s;exports.mount=W;exports.decorator=B;exports.List=ne;exports.Map=re;exports.isDevelopment=E;exports.isProduction=A;exports.warn=L;
