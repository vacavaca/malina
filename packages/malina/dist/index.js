"use strict";Object.defineProperty(exports,"__esModule",{value:true});var e=require("malina-util");var t=require("diff");function n(e,t,n,i,r,s,o){try{var a=e[s](o);var l=a.value}catch(e){n(e);return}if(a.done){t(l)}else{Promise.resolve(l).then(i,r)}}function i(e){return function(){var t=this,i=arguments;return new Promise(function(r,s){var o=e.apply(t,i);function a(e){n(o,r,s,a,l,"next",e)}function l(e){n(o,r,s,a,l,"throw",e)}a(undefined)})}}function r(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);if(t)i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable});n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};if(t%2){s(n,true).forEach(function(t){r(e,t,n[t])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(e,Object.getOwnPropertyDescriptors(n))}else{s(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}}return e}function a(e,t){return l(e)||c(e,t)||h()}function l(e){if(Array.isArray(e))return e}function c(e,t){var n=[];var i=true;var r=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){n.push(a.value);if(t&&n.length===t)break}}catch(e){r=true;s=e}finally{try{if(!i&&o["return"]!=null)o["return"]()}finally{if(r)throw s}}return n}function h(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}let u="production";try{u=process.env.NODE_ENV}catch(e){}const d=e=>e==="development"||e==="testing";const f=u==="development"||u==="testing";const p=!f;const m=typeof self==="object"&&self.self===self&&self||typeof global==="object"&&global.global===global&&global||this;const v="console"in m;const w=v&&"warn"in m.console;const y=v&&"log"in m.console;const g=e=>{if(f&&w)m.console.warn(e)};const x=(...e)=>{if(f&&y)m.console.log(...e)};const b=()=>m;const E=(e,t=null)=>{if(f&&w){if(!e())throw new Error(`Condition failed${t!=null?`: ${t}`:""}`)}};const N=(t,n)=>{const i=b();const r=Symbol.for(`__malina.env.id.${t}`);const s=`malina.seed.id.${t}`;let o;if(i!=null&&r in i)o=i[r];else{o={generator:new e.Random(s),counter:0};i[r]=o}return`${o.generator.id(n)}${++o.counter}`};class C{constructor(t,n={},i=[]){if(t==null)throw new Error("Node tag cannot be empty");this.tag=t;this.attrs=n||{};this.children=e.flatten(i);this.isDevOnly=typeof t==="object"&&t.isDevOnly}static isNode(e){return typeof e==="object"&&e!==null&&e.isNode instanceof Function&&e.isNode()}static isEqualNodes(e,t,n=true){const i=C.isNode(e);if(i!==C.isNode(t))return false;if(i)return e.isEqual(t);else return e===t}isNode(){return true}isDevOnly(){return this.isDevOnly}isEqual(t,n=true){if(this===t)return true;if(this.tag!==t.tag)return false;if(this.isDevOnly!==t.isDevOnly)return false;if(!e.shallowEqual(this.attrs,t.attrs))return false;if(n){if(this.children===t.children)return true;const e=this.children.length;if(e!==t.children.length)return false;for(let n=0;n<e;n++){if(!C.isEqualNodes(this.children[n],t.children[n]))return false}}return true}toString(){const e=Object.keys(this.attrs).reduce((e,t)=>{const n=this.attrs[t];if(typeof n==="string")return`${e} ${t}="${n}"`;else if(n instanceof Function)return`${e} ${t}=[Function]`;else return`${e} ${t}={${typeof n!=="object"?JSON.stringify(n):"{...}"}}`},"");const t=typeof this.tag==="string"?this.tag:"[View]";if(this.children.length>0){return`<${t}${e}>\n${this.children.map(e=>{if(e==null)return'\t""';const t=e.toString();return t.split("\n").map(e=>`\t${e}`).join("\n")}).join("\n")}\n</${t}>`}else return`<${t}${e}/>`}}const D=(e,t,...n)=>{const i=n.length===1&&Array.isArray(n[0])?n[0]:n;return new C(e,t,i)};const V=4;const A=6;const S=(e,t,n)=>{if(n.length>=V)return t;const i=C.isNode(e);if(i!==C.isNode(t))return t;if(!i)return t;const r=O(e);const s=O(t);if(r&&s){if(e.isEqual(t))return e}else if(r===s){const i=e.children.length;if(e.isEqual(t,false)&&i===t.children.length){for(let r=0;r<i;r++){const i=n.concat([r]);const s=e.children[r];const o=t.children[r];const a=S(s,o,i);if(a!==s)return t}return e}}return t};const T=e=>{let t=0;let n=null;return(...i)=>{const r=e(...i);if(n===r)return r;if(t>A)return r;const s=C.isNode(n);const o=C.isNode(r);if(s&&o){const e=S(n,r,[]);if(e!==n)t+=1;else t-=1;n=e;return e}else if(o){t+=1;n=r;return r}else{t+=1;n=null;return r}}};const F=e=>{const t=T(e);let n;let i;return e=>{if(n)return i;const r=t(e);if(n===undefined){n=e.constant;i=r}return r}};const k=e=>{if(e instanceof Function)return F(e);else return()=>e};class I{constructor(e,t,n){this.template=e instanceof Function?e:()=>e;this.behavior=t||(()=>{});this.actions=n||{};this.id=N("declaration",8);this.originalId=null;this.isDevOnly=false;this.decorators={}}static isViewDeclaration(e){return typeof e==="object"&&e!==null&&e.isViewDeclaration instanceof Function&&e.isViewDeclaration()}isViewDeclaration(){return true}setDevelopmentOnly(e){const t=this.copy();t.isDevOnly=e;return t}is(e){return this===e||this.id===e.id||this.originalId===e.originalId}decorateWith(e){const t=this.copy();t.decorators=o({},this.decorators,{[e]:true});return t}copy(){const e=new I(null);e.template=this.template;e.behavior=this.behavior;e.actions=o({},this.actions);e.id=this.id;e.originalId=this.originalId;e.isDevOnly=this.isDevOnly;e.decorators=o({},this.decorators);return e}}const O=e=>C.isNode(e)&&I.isViewDeclaration(e.tag);const P=e=>C.isNode(e)&&!I.isViewDeclaration(e.tag);const L=e=>!(e instanceof Object)&&typeof e!=="object";const U=(...t)=>{if(t.length>1)return e.compose(...t)(new I(null));else if(t.length===1){const e=t[0];if(e instanceof Function)return e(new I(null));else return new I(e)}else return new I(null)};const $=e=>new I(e);class j{constructor(){this.resolvers={};this.listeners={}}notify(e,t=[]){if(e in this.listeners){const a=this.listeners[e];var n=true;var i=false;var r=undefined;try{for(var s=a[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;e(...t)}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}}if(e in this.resolvers){const n=this.resolvers[e];delete this.resolvers[e];var l=true;var c=false;var h=undefined;try{for(var u=n[Symbol.iterator](),d;!(l=(d=u.next()).done);l=true){const e=a(d.value,2),n=e[0],i=e[1];const r=i&&t.length===1?t[0]:t;n(r)}}catch(e){c=true;h=e}finally{try{if(!l&&u.return!=null){u.return()}}finally{if(c){throw h}}}}}wait(e,t=true){return new Promise(n=>{if(!(e in this.resolvers))this.resolvers[e]=[[n,t]];else this.resolvers[e].push([n,t])})}waitFor(e,t){return new Promise(n=>{const i=(...e)=>{if(t(...e))n(...e)};if(!(e in this.resolvers))this.resolvers[e]=[[i]];else this.resolvers[e].push([i])})}on(e,t){if(!(e in this.listeners))this.listeners[e]=[t];else this.listeners[e].push(t);return()=>this.off(e,t)}off(e,t){if(e in this.listeners){this.listeners[e].splice(this.listeners[e].indexOf(t),1);if(this.listeners[e].length===0)delete this.listeners[e]}}}class K{constructor(e){this.view=e;this.constant=true}get state(){this.constant=false;return this.view.state}get actions(){return this.view.actions}get children(){this.constant=false;return this.view.children||[]}}class Q extends K{get state(){return this.view.state}set state(e){this.view.state=e}get isMounted(){return this.view.mounted}get isDestroyed(){return this.view.destroyed}get element(){return this.view.element}}class H extends Q{update(e){if(!this.isDestroyed)return this.view.update(e);else return this.state}mount(){return this.view.dispatcher.wait("mount",true)}onMount(e){return this.view.dispatcher.on("mount",()=>e(this))}nextUpdate(){return this.view.dispatcher.wait("update",true)}onUpdate(e){return this.view.dispatcher.on("update",()=>e(this))}unmount(){return this.view.dispatcher.wait("unmount",true)}onUnmount(e){return this.view.dispatcher.on("unmount",()=>e(this))}onDestroy(e){return this.view.dispatcher.on("destroy",()=>e(this))}waitFor(e,t){var n=this;return i(function*(){if(e(n.state))return true;while(yield n.updating()){if(e(n.state))return true}if(e(n.state))return true;return false})()}updating(){var e=this;return i(function*(){return Promise.race([e.nextUpdate().then(()=>true),e.unmount().then(()=>false)])})()}setTimeout(e,t){const n=setTimeout(e,t);this.onDestroy(()=>clearTimeout(n))}setInterval(e,t){const n=setInterval(e,t);this.onDestroy(()=>clearInterval(n))}}class M extends Q{render(){return this.view.render()}attach(e=null){this.view.attach(e)}update(e=null,t=null){if(!this.isDestroyed)return this.view.update(e,t);else return this.state}move(e,t){return this.view.move(e,t)}unmount(){this.view.unmount()}destroy(e=true){this.view.destroy(e)}onMount(e){return this.view.dispatcher.on("mount",()=>e(this))}onUpdate(e){return this.view.dispatcher.on("update",()=>e(this))}onUnmount(e){return this.view.dispatcher.on("unmount",()=>e(this))}onDestroy(e){return this.view.dispatcher.on("destroy",()=>e(this))}}class W{constructor(e,t,n){this.document=e;this.store=t;this.globalStore=n}static initialize(e,t){return new W(e,t,{})}isLocked(){return this.getOrCreate("lock",false,true)}lock(){return this.update("lock",true,true)}unlock(){return this.update("lock",false,true)}getCallbackQueue(e){return this.getOrCreate(`callback-queue.${e}`,[],true)}setSvg(e){if(this.isSvg()===e)return this;const t={};for(const e in this.store){if(Object.prototype.hasOwnProperty.call(this.store,e))t[e]=this.store[e]}t["svg"]=e;return new W(this.document,t,this.globalStore)}isSvg(){return this.getOrCreate("svg",false)}setInProduction(e){return this.update("production",e)}isInProduction(){return this.getOrCreate("production",true)}isUpdating(){return this.getOrCreate("updating",false)}setUpdating(e){if(this.isUpdating()===e)return this;const t={};for(const e in this.store){if(Object.prototype.hasOwnProperty.call(this.store,e))t[e]=this.store[e]}t["updating"]=e;return new W(this.document,t,this.globalStore)}getDocument(){return this.document}update(e,t,n=false){const i=n?this.globalStore:this.store;i[e]=t;return this}getOrCreate(e,t,n=false){const i=n?this.globalStore:this.store;if(e in i)return i[e];else{i[e]=t;return i[e]}}}class z{constructor(e={}){this.value=e;this.dispatcher=new j}subscribe(e){return this.dispatcher.on("update",e)}update(t,n=false){if(t==null)return;if(e.keys(t).length===0)return;const i=o({},this.value,{},t);if(e.shallowEqual(this.value,i))return;this.value=i;if(!n)this.dispatcher.notify("update",[this.value])}get(){return this.value}}const q=e=>e instanceof e.ownerDocument.defaultView.HTMLTemplateElement;const B=(e,t)=>{for(let n=0;n<Math.min(e.length,t.length);n++){const i=e[n]-t[n];if(i!==0)return i}return e.length-t.length};const G=(e,t=1)=>e.length?e.slice(0,-1).concat([e[e.length-1]+t]):e;const _=e=>e.length===0;class R{constructor(e){this.view=e;this.deleted=false}delete(){this.deleted=true}}class Y{constructor(){this.views={};this.index=[]}hasView(e){return Y.getPathKey(e)in this.views}getView(e){const t=Y.getPathKey(e);return t in this.views?this.views[t].view:null}*iterateViews(e=[],t=false){let n=0;if(!_(e)){const t=this.searchPath(e);n=t>=0?t:-t-1}let i=null;if(!_(e)){const t=this.searchPath(G(e));i=t>=0?t+1:-t-1}i=i!=null?Math.min(i,this.index.length):this.index.length;if(!t){for(let e=n;e<i;e++){const t=this.index[e],n=t.view,r=t.key;const s=new R(n);yield s;if(s.deleted){this.index.splice(e,1);e-=1;i-=1;delete this.views[r]}}}else{for(let e=Math.max(i-1,0);e>=n;e--){const t=this.index[e],n=t.view,i=t.key;const r=new R(n);yield r;if(r.deleted){this.index.splice(e,1);delete this.views[i]}}}}addView(e,t){const n=this.searchPath(e);const i=n>=0?n:-n-1;const r=Y.getPathKey(e);const s={view:t,path:e,key:r};this.views[r]=s;this.index.splice(i,0,s)}removeView(e){const t=Y.getPathKey(e);if(!(t in this.views))return null;const n=this.searchPath(e);const i=this.views[t].view;this.index.splice(n,1);delete this.views[t];return i}isEmpty(){return this.index.length===0}static getPathKey(e){return e.join(".")}searchPath(t){return e.binarySearch(t,this.index,(e,t)=>{const n="path"in e?e.path:e;const i="path"in t?t.path:t;return B(n,i)})}}const J=e=>`on${e[0].toUpperCase()}${e.substr(1)}`;const X=e=>{const t=e.toLowerCase();return t.startsWith("on")?t.substr(2):t};const Z=e=>e.length===0;const ee=(e,t)=>e.tag.id===t.tag.id;const te=(e,t)=>{const n=e.children;if(e.attrs.ignoreKeys||t.noWarnKeys)return;if(!n.every((e,t)=>t===0||!O(e)||!O(n[t-1])||e.attrs.key||!ee(e,n[t-1])))throw new Error("Every view node in an array must have a 'key' attribute")};const ne=(e,t)=>{const n=e.children;if(e.attrs.ignoreKeys||t.noWarnKeys)return;let i={};var r=true;var s=false;var o=undefined;try{for(var a=n[Symbol.iterator](),l;!(r=(l=a.next()).done);r=true){const e=l.value;if(O(e)&&e.attrs.key){if(!(e.tag.id in i))i[e.tag.id]={};if(e.attrs.key in i[e.tag.id])throw new Error("Every view node in an array must have an unique 'key' attribute");i[e.tag.id][e.attrs.key]=true}}}catch(e){s=true;o=e}finally{try{if(!r&&a.return!=null){a.return()}}finally{if(s){throw o}}}};const ie=e=>{const t=e.attrs,n=e.children;if("innerHtml"in t&&t.innerHtml!=null&&n!=null&&n.length>0)throw new Error('Nodes with "innerHtml" attribute must not have children')};const re=(e,t={})=>{te(e,t);ne(e,t);ie(e);return e};const se=(e,t,n)=>{const i=q(e)?e.content:e;const r=i.childNodes[t];i.insertBefore(n,r)};const oe=(e,t)=>{const n=q(e)?e.content:e;n.removeChild(t)};const ae=/^[a-z][a-z0-9.-_]*-[a-z0-9.-_]*$/;const le=["annotation-xml","color-profile","font-face","font-face-src","font-face-uri","font-face-format","font-face-name","missing-glyph"];const ce=e=>P(e)&&!le.includes(e.tag)&&(ae.test(e.tag)||"is"in e.attrs&&ae.test(e.attrs.is));const he=(e,t)=>t instanceof e.getDocument().defaultView.Element||t instanceof e.getDocument().defaultView.Text;class ue{constructor(e,t){this.view=e;this.renderingContext=t;this.element=null;this.eventListeners=new Map;this.eventListenerDelegates=new Map;this.attachQueue=[];this.isDeferElementAttach=false}render(e){return this.createNode(e,[],this.renderingContext)}hydrate(e,t){if(this.element!==null)throw new Error("Already attached");this.hydrateNode(e,t,[],this.renderingContext);this.attach(e)}attach(e,t){if(this.element!==null)throw new Error("Already attached");this.element=e;this.attachNode(e,t,[],this.renderingContext)}mount(e,t,n){se(t,n,e)}move(e,t){se(e,t,this.element)}update(e,t){this.renderingContext=this.renderingContext.setUpdating(true);this.patch(this.element,e,t,[],this.renderingContext);this.renderingContext.setUpdating(false)}detach(e){if(this.element===null)throw new Error("Already detached");this.detachNode(this.element,e,[],this.renderingContext);E(()=>this.eventListeners.size===0,"Event listeners map is empty after detach");E(()=>this.eventListenerDelegates.size===0,"Event listener delegates map is empty after detach");this.element=null}deferElementAttach(){this.isDeferElementAttach=true}flushAttachQueue(){const e=this.attachQueue;this.attachQueue=[];var t=true;var n=false;var i=undefined;try{for(var r=e[Symbol.iterator](),s;!(t=(s=r.next()).done);t=true){const e=s.value,t=e.element,n=e.name,i=e.value,r=e.path,o=e.renderingContext;this.attachAttribute(t,n,i,r,o)}}catch(e){n=true;i=e}finally{try{if(!t&&r.return!=null){r.return()}}finally{if(n){throw i}}}}static getAttrKey(e,t){return`${t}.${e.join(".")}`}patch(e,t,n,i,r){if(t===n)return;if(P(t)){if(n==null)this.patchFromNodeToNone(e,t,i,r);else if(P(n))this.patchFromNodeToNode(e,t,n,i,r);else if(O(n))this.patchFromNodeToView(e,t,n,i,r);else if(L(n))this.patchFromNodeToText(e,t,n,i);else if(he(r,n))this.patchFromElementNodeToDom(e,n,i);else throw new Error("Invalid template type")}else if(O(t)){if(n==null)this.patchFromViewToNone(e,t,i);else if(P(n))this.patchFromViewToNode(e,t,n,i,r);else if(O(n))this.patchFromViewToView(e,t,n,i,r);else if(L(n))this.patchFromViewToText(e,t,n,i);else if(he(r,n))this.patchFromViewToDom(e,n,i);else throw new Error("Invalid template type")}else if(he(r,t)){if(n==null)this.patchFromDomToNone(e,i);else if(P(n))this.patchFromDomToNode(e,n,i,r);else if(O(n))this.patchFromDomToView(e,n,i,r);else if(L(n))this.patchFromDomToText(e,n,i);else if(he(r,n))this.patchFromDomToDom(e,n,i);else throw new Error("Invalid template type")}else{if(n==null)this.patchFromTextToNone(e,i);else if(P(n))this.patchFromTextToNode(e,n,i,r);else if(O(n))this.patchFromTextToView(e,n,i,r);else if(L(n))this.patchTextNodes(e,t,n,i);else if(he(r,n))this.patchFromTextToDom(e,n,i);else throw new Error("Invalid template type")}}patchFromElementNodeToDom(e,t,n){if(e!==t){this.view.destroyInnerViews(n,false);e.replaceWith(t);if(Z(n))this.element=t}}patchFromViewToDom(e,t,n){this.view.destroyInnerView(n,false);e.replaceWith(t);if(Z(n))this.element=t}patchFromDomToNone(e,t){if(Z(t))throw new Error("Root element deleted during patch");oe(e.parentNode,e)}patchFromDomToNode(e,t,n,i){const r=this.createElementNode(t,n,i.setUpdating(false));e.replaceWith(r);if(i.isUpdating())this.attachElementNode(e,t,n,i);if(Z(n))this.element=r}patchFromDomToView(e,t,n,i){const r=this.view.instantiateInnerView(t,n,i.setUpdating(false));let s;if(n.length>0)s=n[n.length-1];else s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();if(i.isUpdating()){const e=r.render();se(o,s,e);r.attach(e)}else throw new Error("Unreachable");if(Z(n))this.element=r.element}patchFromDomToText(e,t,n){const i=this.renderingContext.getDocument().createTextNode(`${t}`);e.replaceWith(i);if(Z(n))this.element=i}patchFromDomToDom(e,t,n){if(e!==t){e.replaceWith(t);if(Z(n))this.element=t}}patchFromTextToDom(e,t,n){e.replaceWith(t);if(Z(n))this.element=t}patchFromTextToNone(e,t){if(Z(t))throw new Error("Root element deleted during patch");oe(e.parentNode,e)}patchTextNodes(e,t,n,i){if(t!==n){const t=this.createTextNode(n);e.replaceWith(t);if(Z(i))this.element=t}}patchFromTextToNode(e,t,n,i){const r=this.createElementNode(t,n,i.setUpdating(false));e.replaceWith(r);if(i.isUpdating())this.attachElementNode(e,t,n,i);if(Z(n))this.element=r}patchFromTextToView(e,t,n,i){const r=this.view.instantiateInnerView(t,n,i.setUpdating(false));let s;if(n.length>0)s=n[n.length-1];else s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();if(i.isUpdating()){const e=r.render();se(o,s,e);r.attach(e)}else throw new Error("Unreachable");if(Z(n))this.element=r.element}patchFromNodeToNone(e,t,n,i){if(Z(n))throw new Error("Root element deleted during patch");this.detachElementNode(e,t,n,i);this.view.destroyInnerViews(n,false);e.remove()}patchFromNodeToText(e,t,n,i){this.view.destroyInnerViews(i,false);const r=this.renderingContext.getDocument().createTextNode(`${n}`);e.replaceWith(r);if(Z(i))this.element=r}patchFromNodeToNode(e,t,n,i,r){if(t===n)return;const s=ce(t);const o=ce(n);if(t.tag===n.tag){if(s&&o){this.updateAttributes(e,t,n,i,r);e.innerHTML="";this.createChildren(e,n,i,r)}else if(s||o){this.view.destroyInnerViews(i,false);const t=this.createElementNode(n,i,r.setUpdating(false));e.replaceWith(t);if(r.isUpdating())this.attachElementNode(e,n,i,r);if(Z(i))this.element=t}else{this.updateAttributes(e,t,n,i,r);this.updateChildren(e,t,n,i,r)}}else{this.view.destroyInnerViews(i,false);const t=this.createElementNode(n,i,r.setUpdating(false));e.replaceWith(t);if(r.isUpdating())this.attachElementNode(e,n,i,r);if(Z(i))this.element=t}}patchFromNodeToView(e,t,n,i,r){this.view.destroyInnerViews(i,false);const s=this.view.instantiateInnerView(n,i,r.setUpdating(false));let o;if(i.length>0)o=i[i.length-1];else o=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const a=e.parentNode;e.remove();if(r.isUpdating()){const e=s.render();se(a,o,e);s.attach(e)}else throw new Error("Unreachable");if(Z(i))this.element=s.element}patchFromViewToNone(e,t,n){if(Z(n))throw new Error("Root element deleted during patch");this.view.destroyInnerView(n)}patchFromViewToText(e,t,n,i){this.view.destroyInnerView(i,false);const r=this.renderingContext.getDocument().createTextNode(`${n}`);e.replaceWith(r);if(Z(i))this.element=r}patchFromViewToNode(e,t,n,i,r){this.view.destroyInnerView(i,false);const s=this.createElementNode(n,i,r.setUpdating(false));e.replaceWith(s);if(r.isUpdating())this.attachElementNode(e,n,i,r);if(Z(i))this.element=s}patchFromViewToView(e,t,n,i,r){if(t===n)return;if(ee(t,n)&&t.attrs.key===n.attrs.key){const e=this.view.getInstantiatedInnerView(i);e.update(n.attrs,n.children)}else{const t=e.parentNode;let s;if(i.length>0)s=i[i.length-1];else s=Array.from(t.childNodes).findIndex(t=>t===e);this.view.destroyInnerView(i);const o=this.view.instantiateInnerView(n,i,r.setUpdating(false));e.remove();if(r.isUpdating()){const e=o.render();se(t,s,e);o.attach(e)}else throw new Error("Unreachable");if(Z(i))this.element=o.element}}createNode(e,t,n){if(P(e))return this.createElementNode(e,t,n);else if(O(e))return this.createViewNode(e,t,n);else if(he(n,e))return e;else if(e===null||L(e))return this.createTextNode(e)}hydrateNode(e,t,n,i){if(P(t))return this.hydrateElementNode(e,t,n,i);else if(O(t))return this.hydrateViewNode(e,t,n,i)}attachNode(e,t,n,i){if(P(t))return this.attachElementNode(e,t,n,i);else if(O(t))return this.attachViewNode(e,n)}detachNode(e,t,n,i){if(P(t))return this.detachElementNode(e,t,n,i);else if(O(t))return this.detachViewNode(e,n)}createElementNode(e,t,n){let i=n.isSvg();let r;if(!i&&e.tag==="svg"){n=n.setSvg(true);i=true}if(i)r=n.getDocument().createElementNS("http://www.w3.org/2000/svg",e.tag);else r=n.getDocument().createElement(e.tag);this.addAttributes(r,e,t,n);this.createChildren(r,e,t,n);return r}hydrateElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.hydrateAttributes(e,t,n,i);this.hydrateChildren(e,t,n,i)}attachElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.attachAttributes(e,t,n,i);this.attachChildren(e,t,n,i)}detachElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.detachAttributes(e,t,n,i);this.detachChildren(e,t,n,i)}createViewNode(e,t,n){const i=this.view.instantiateInnerView(e,t,n.setUpdating(false));let r;if(n.isUpdating()){r=i.render(this.document);i.attach(r)}else r=i.render(this.document);return r}hydrateViewNode(e,t,n,i){const r=this.view.getOrInstantiateInnerView(t,n,i);return r.hydrate(e)}attachViewNode(e,t){const n=this.view.getInstantiatedInnerView(t);return n.attach(e)}detachViewNode(e,t){const n=this.view.getInstantiatedInnerView(t);n.unmount()}createTextNode(e){return this.renderingContext.getDocument().createTextNode(`${e!=null?e:""}`)}createChildren(e,t,n,i){re(t);const r=[];if("innerHtml"in t.attrs)e.innerHTML=t.attrs.innerHtml;else{const a=i.getDocument().createDocumentFragment();for(const e in t.children){const s=t.children[e];if(s===null||i.isInProduction()&&s.isDevOnly)continue;const o=n.concat([e]);const l=this.createNode(s,o,i.setUpdating(false));a.appendChild(l);if(i.isUpdating())r.push({element:l,node:s,path:o})}if(t.children.length>0){const t=q(e)?e.content:e;t.appendChild(a);for(var s=0,o=r;s<o.length;s++){const e=o[s],t=e.element,n=e.node,r=e.path;if(P(n))this.attachElementNode(t,n,r,i);else if(O(n))this.attachViewNode(t,r)}}}}hydrateChildren(e,t,n,i){re(t,{noWarnKeys:true});if(ce(t))return;const r=q(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(ce(o))continue;const a=n.concat([e]);const l=r.childNodes[e-s];this.hydrateNode(l,o,a,i)}}}attachChildren(e,t,n,i){re(t,{noWarnKeys:true});if(ce(t))return;const r=q(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(ce(o))continue;const a=n.concat([e]);const l=r.childNodes[e-s];this.attachNode(l,o,a,i)}}}detachChildren(e,t,n,i){if(ce(t))return;const r=q(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(ce(o))continue;const a=n.concat([e]);const l=r.childNodes[e-s];this.detachNode(l,o,a,i)}}}updateChildren(e,t,n,i,r){if(t===n)return;re(n);if("innerHtml"in n.attrs)e.innerHTML=n.attrs.innerHtml;else{if(n.tag==="svg"&&!r.isSvg())r=r.setSvg(true);const s=Math.max(t.children.length,n.children.length);let o=0;for(let a=0;a<s;a++){let s=t.children[a];let l=a in n.children?n.children[a]:null;if(r.isInProduction()){if(s!=null&&l!=null&&s.isDevOnly&&l.isDevOnly)continue;else if(s!=null&&s.isDevOnly)s=null;else if(l!=null&&l.isDevOnly)l=null}const c=i.concat([a]);if(s!=null){const t=e.childNodes[a-o];this.patch(t,s,l,c,r);if(l==null)o+=1}else{if(l!=null){const t=this.createNode(l,c,r.setUpdating(false));const n=q(e)?e.content:e;const i=n.childNodes[a];n.insertBefore(t,i);if(r.isUpdating()){if(P(l))this.attachElementNode(t,l,c,r);else if(O(l))this.attachViewNode(t,c)}}else o+=1}}}}addAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.addAttribute(e,r,s,n,i)}}hydrateAttributes(e,t,n,i){if(!("style"in t.attrs))e.removeAttribute("style");for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.hydrateAttribute(e,r,s,n,i)}}attachAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];if(!this.isDeferElementAttach)this.attachAttribute(e,r,s,n,i);else this.attachQueue.push({element:e,name:r,value:s,path:n,renderingContext:i})}}detachAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.detachAttribute(e,r,s,n,i)}}addAttribute(e,t,n,i,r){if(t==="style"){for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,i,X(t),n);else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t!=="focus"&&t in e&&!r.isSvg()&&n!=null)e[t]=n;else if(typeof n==="boolean"){if(t!=="focus")e.setAttribute(t,t)}else if(n!=null)e.setAttribute(t!=="htmlFor"?t:"for",n)}hydrateAttribute(e,t,n,i,r){if(t==="style"){e.removeAttribute("style");for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,i,X(t),n);else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}}attachAttribute(e,t,n,i,r){if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}}detachAttribute(e,t,n,i,r){if(n instanceof Function){const n=X(t);this.removeEventListener(e,i,n)}}updateAttributes(e,t,n,i,r){if(t===n)return;for(const s in n.attrs){if(s==="innerHtml"||s==="ignoreKeys")continue;const o=n.attrs[s];if(s in t.attrs){const n=t.attrs[s];this.updateAttribute(e,s,n,o,i,r)}else this.addAttribute(e,s,o,i,r)}for(const s in t.attrs){if(s==="innerHtml"||s==="ignoreKeys")continue;if(!(s in n.attrs))this.removeAttribute(e,s,t.attrs[s],i,r)}}updateAttribute(e,t,n,i,r,s){if(n===i)return;const o=i instanceof Function;const a=n instanceof Function;if(t==="style"){for(const t in n){if(!(t in i))this.removeStyleProp(e,t)}for(const t in i){const n=i[t]||"";this.setStyleProp(e,t,n)}}else if(o||a){if(o&&a){if(i!==n)this.updateEventListener(r,X(t),i)}else if(o){this.removeAttribute(e,t,n,r,s);this.addEventListener(e,r,X(t),i)}else if(a){this.removeEventListener(e,r,X(t));this.addAttribute(e,t,i,r,s)}}else if(t==="data"){const t=n!=null&&typeof n==="object";const r=i!=null&&typeof i==="object";if(t&&r){for(const t in n){if(!(t in i))delete e.dataset[t]}for(const t in i)e.dataset[t]=i[t]}else if(t&&!r){for(const t in e.dataset)delete e.dataset[t]}else if(!t&&r){for(const t in i)e.dataset[t]=i[t]}}else if(t!=="focus"&&t in e&&!s.isSvg())e[t]=i;else if(typeof n==="boolean"){if(t==="focus"){if(e.focus&&e.blur){if(i)e.focus();else e.blur()}}else{if(i)e.setAttribute(t,t);else e.removeAttribute(t)}}else{if(i!=null)e.setAttribute(t!=="htmlFor"?t:"for",i);else if(n!=null)e.removeAttribute(t!=="hmtlFor"?t:"for")}}removeAttribute(e,t,n,i,r){if(t==="style")e.removeAttribute("style");else if(n instanceof Function){const n=X(t);this.removeEventListener(e,i,n)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in e.dataset)delete e.dataset[t]}else if(t!=="focus"&&t in e&&!r.isSvg())e[t]=undefined;else if(typeof n==="boolean"){if(t==="focus"&&e.blur)e.blur();else e.removeAttribute(t)}else if(n!=null)e.removeAttribute(t!=="hmtlFor"?t:"for")}setStyleProp(e,t,n){if(t[0]==="-"){const i=n.indexOf("!important");let r=n;if(i!==-1)r=i!==n.slice(0,i)+n.slice(i+10);r=r.trim().replace(/;$/,"");e.style.setProperty(t,r)}else e.style[t]=n}removeStyleProp(e,t){if(t[0]==="-")e.style.removeProperty(t);else delete e.style[t]}addEventListener(e,t,n,i){const r=this.createEventListenerDelegate(i,t,n);if(e.addEventListener)e.addEventListener(n,r);else if(e.attachEvent)e.attachEvent(J(n),r);else{const t=e[n]&&e[n].listeners||[];if(e[n]!=null)e[n].listeners=t.concat([r]);else{const i=(...t)=>e[n].listeners.map(e=>e(...t));i.listeners=t.concat([r]);e[n]=i}}}updateEventListener(e,t,n){this.updateEventListenerDelegate(n,e,t)}removeEventListener(e,t,n){const i=this.getEventListenerDelegate(t,n);this.removeEventListenerDelegate(t,n);if(e.removeEventListener)e.removeEventListener(n,i);else if(e.detachEvent)e.detachEvent(J(n),i);else{if(e[n]!=null&&e[n].listeners!=null)e[n].listeners=e[n].listener.filter(e=>e!==i)}}getEventListenerDelegate(e,t){const n=ue.getAttrKey(e,t);return this.eventListenerDelegates.get(n)}hasEventListenerDelegate(e,t){const n=ue.getAttrKey(e,t);return this.eventListenerDelegates.has(n)}createEventListenerDelegate(e,t,n){const i=ue.getAttrKey(t,n);this.eventListeners.set(i,e);const r=(...e)=>{const t=this.eventListeners.get(i);if(t==null)throw new Error("Event listener not found");t(...e)};this.eventListenerDelegates.set(i,r);return r}updateEventListenerDelegate(e,t,n){const i=ue.getAttrKey(t,n);this.eventListeners.set(i,e)}removeEventListenerDelegate(e,t){const n=ue.getAttrKey(e,t);this.eventListenerDelegates.delete(n);this.eventListeners.delete(n)}}class de{constructor(e,t,n=null){const i=t.tag,r=t.attrs,s=t.children;this.template=k(i.template);this.state=r;this.actions=this.bindActions(i.actions);this.behavior=i.behavior;this.dispatcher=new j;this.templateFacade=new K(this);this.actionFacade=new Q(this);this.children=s;this.id=i.id;this.renderContext=e;this.tree=new Y;this.renderer=new ue(this,e);this.node=null;this.destroyed=false;this.templateLock=false;this.updateLock=false;this.trackedActionUpdate=false;this.tmpElement=null;this.stateContext=n!=null?n:null;this.stateContextSubscription=null;this.stateContextProvider=null;this.stateContextConsumer=null;this.runBehavior()}get element(){return this.renderer.element||this.tmpElement}render(){if(this.destroyed)throw new Error("View is destroyed");this.tmpElement=null;this.node=this.renderTemplate();return this.renderer.render(this.node)}hydrate(e){if(this.destroyed)throw new Error("View is destroyed");if(this.element!=null)throw new Error("View is already hydrated");this.tmpElement=null;if(this.node==null)this.node=this.renderTemplate();const t=!this.renderContext.isLocked();if(t)this.renderContext.lock();this.renderer.deferElementAttach();this.renderer.hydrate(e,this.node);if(t){this.renderContext.unlock();const e=this.renderContext.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element]);this.renderer.flushAttachQueue()}else{const e=this.renderContext.getCallbackQueue("mount");e.push(()=>{this.dispatcher.notify("mount",[this.element]);this.renderer.flushAttachQueue()})}}attach(e){if(this.destroyed)throw new Error("View is destroyed");if(this.element!=null)throw new Error("View is already attached");this.tmpElement=null;if(this.node==null)this.node=this.renderTemplate();const t=!this.renderContext.isLocked();if(t)this.renderContext.lock();this.renderer.deferElementAttach();this.renderer.attach(e,this.node);if(t){this.renderContext.unlock();const e=this.renderContext.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element]);this.renderer.flushAttachQueue()}else{const e=this.renderContext.getCallbackQueue("mount");e.push(()=>{this.dispatcher.notify("mount",[this.element]);this.renderer.flushAttachQueue()})}}mount(e,t){if(this.destroyed)throw new Error("View is destroyed");this.tmpElement=null;const n=!this.renderContext.isLocked();if(n)this.renderContext.lock();if(this.node==null)this.node=this.renderTemplate();const i=this.renderer.render(this.node);this.renderer.deferElementAttach();this.renderer.mount(i,e,t);this.renderer.attach(i,this.node);if(n){this.renderContext.unlock();const e=this.renderContext.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element]);this.renderer.flushAttachQueue()}else{const e=this.renderContext.getCallbackQueue("mount");e.push(()=>{this.dispatcher.notify("mount",[this.element]);this.renderer.flushAttachQueue()})}}move(e,t){this.tmpElement=null;this.renderer.move(e,t)}update(e=null,t=null){let n=false;if(this.destroyed)throw new Error("View has been destroyed");const i=this.updateState(e);const r=this.updateChildrenState(t);n=this.state!==i||this.children!==r;this.state=i;this.children=r;if(this.element!==null&&n)this.refresh();this.updateContext(n);if(this.element!==null&&n)this.dispatcher.notify("update",[this.state]);return n}unmount(){if(this.destroyed)throw new Error("View has been destroyed");if(this.element===null)throw new Error("View has been already unmounted");const e=!this.renderContext.isLocked();if(e)this.renderContext.lock();this.tmpElement=this.element;this.renderer.detach(this.node);if(e){this.renderContext.unlock();const e=this.renderContext.getCallbackQueue("unmount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("unmount");this.tmpElement=null}else{const e=this.renderContext.getCallbackQueue("unmount");e.push(()=>{this.dispatcher.notify("unmount");this.tmpElement=null})}}destroy(e=true){if(this.destroyed)throw new Error("View has been destroyed");const t=this.element;if(t!==null)this.unmount();const n=!this.renderContext.isLocked();if(n)this.renderContext.lock();if(this.stateContextSubscription!==null){this.stateContextSubscription();this.stateContextSubscription=null}this.destroyInnerViews([],false);if(e&&t!=null)t.remove();this.node=null;this.destroyed=true;E(()=>this.tree.isEmpty(),"View tree is empty after destroy");if(n){this.renderContext.unlock();const e=this.renderContext.getCallbackQueue("destroy");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("destroy")}else{const e=this.renderContext.getCallbackQueue("destroy");e.push(()=>this.dispatcher.notify("destroy"))}}getOrInstantiateInnerView(e,t,n){if(!this.tree.hasView(t))return this.instantiateInnerView(e,t,n);return this.tree.getView(t)}instantiateInnerView(e,t,n){E(()=>!this.tree.hasView(t),"View tree overwrite");const i=new de(n,e,this.stateContext);this.tree.addView(t,i);return i}getInstantiatedInnerView(e){return this.tree.getView(e)}destroyInnerViews(e,t=true){var n=true;var i=false;var r=undefined;try{for(var s=this.tree.iterateViews(e)[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;const n=e.view;n.destroy(t);e.delete()}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}}destroyInnerView(e,t=true){const n=this.tree.getView(e);this.tree.removeView(e);n.destroy(t)}initializeContext(e){const t=e(this);if(t==null)return;if(this.stateContext!=null)this.stateContext.update(t);else this.stateContext=new z(t);this.stateContextProvider=e}subscribeContext(e){if(this.stateContext!=null){this.state=o({},this.state,{},e(this.stateContext.value)||{});if(this.stateContextSubscription!==null)this.stateContextSubscription();this.stateContextSubscription=this.stateContext.subscribe(t=>this.update(e(t)))}this.stateContextConsumer=e}updateContext(e){if(this.stateContext==null)return;if(e&&this.stateContextProvider!=null)this.stateContext.update(this.stateContextProvider(this));if(e&&this.stateContextConsumer!=null)this.state=o({},this.state,{},this.stateContextConsumer(this.stateContext.value)||{})}runBehavior(){if(this.behavior instanceof Function)this.behavior(new H(this))}refresh(){const e=this.renderTemplate();const t=this.node;this.node=e;this.renderer.update(t,e)}renderTemplate(){this.templateLock=true;try{let e=this.template(this.templateFacade);if(Array.isArray(e)){if(e.length!==1)throw new Error("Only one root element must be rendered for a view");e=e[0]}e=e!=null?e:"";return e}finally{this.templateLock=false}}bindActions(t){const n={};var i=true;var r=false;var s=undefined;try{for(var o=e.keys(t)[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){const e=a.value;const i=t[e];if(i instanceof Function)n[e]=((...n)=>this.callAction(t[e],...n));else n[e]=this.bindActions(i)}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}return n}callAction(e,...t){var n=this;if(this.templateLock)throw new Error("Actions can't be called during template render");const r=!this.updateLock;this.updateLock=true;let s=e(...t);if(s instanceof Function)s=s(this.actionFacade);else if(s instanceof Promise){return i(function*(){n.finishAction(r);s=yield s;if(s instanceof Function)s=s(n.actionFacade);if(s instanceof Promise){n.finishAction(r);s=yield s;n.finishAction(r,s);return n.state}else{n.finishAction(r,s);return n.state}})()}if(s instanceof Promise){return i(function*(){n.finishAction(r);s=yield s;n.finishAction(r,s);return n.state})()}else{this.finishAction(r,s);return this.state}}finishAction(e,t=null){this.updateLock=false;if(e){if(!this.destroyed&&this.element!==null){let e=false;const n=this.update(t);if(!n&&this.trackedActionUpdate){this.trackedActionUpdate=false;this.refresh();this.updateContext(true);e=true}else this.trackedActionUpdate=false;if(e)this.dispatcher.notify("update",[this.state])}else if(!this.destroyed)this.state=this.updateState(t)}else{const e=this.updateState(t);this.trackedActionUpdate=this.trackedActionUpdate||this.state!==e;this.state=e}}updateState(t=null){if(t==null||t===this.state)return this.state;const n={};let i=false;var r=true;var s=false;var o=undefined;try{for(var a=e.keys(t)[Symbol.iterator](),l;!(r=(l=a.next()).done);r=true){const e=l.value;if(typeof e==="symbol")this.state[e]=t[e];else{n[e]=t[e];i=i||t[e]!==this.state[e]}}}catch(e){s=true;o=e}finally{try{if(!r&&a.return!=null){a.return()}}finally{if(s){throw o}}}if(!i)return this.state;var c=true;var h=false;var u=undefined;try{for(var d=e.keys(this.state)[Symbol.iterator](),f;!(c=(f=d.next()).done);c=true){const e=f.value;if(!(e in n))n[e]=this.state[e]}}catch(e){h=true;u=e}finally{try{if(!c&&d.return!=null){d.return()}}finally{if(h){throw u}}}return n}updateChildrenState(t=null){if(t===null||t===null)return this.children;const n=this.children==null||this.children.length===0;const i=t.length===0;if(n!==i)return t;else return!e.shallowEqual(this.children,t)?t:this.children}}const fe=(e,t,n,{insideSvg:i,hydrate:r,isProduction:s})=>{const o=C.isNode(t)?t:D(t);const a=e.ownerDocument;let l=W.initialize(a,{production:s,svg:i});if(!l.isSvg()){const t=a.defaultView;if(e instanceof t.SVGElement)l=l.setSvg(true)}const c=new de(l,o);const h=q(e)?e.content:e;if(r)c.hydrate(h.childNodes[n]);else c.mount(h,n);return new M(c)};const pe=(e,t,n=0,{insideSvg:i=false,env:r=(p?"production":"development")}={})=>fe(e,t,n,{insideSvg:i,hydrate:false,isProduction:!d(r)});const me=(e,t,n=0,{insideSvg:i=false,env:r=(p?"production":"development")}={})=>fe(e,t,n,{insideSvg:i,hydrate:true,isProduction:!d(r)});const ve=(e,t,{insideSvg:n=false,env:i=(p?"production":"development")}={})=>{const r=C.isNode(t)?t:D(t);const s=W.initialize(e,{production:p,svg:n});const o=new de(s,r);return new M(o)};const we=(e,t,{insideSvg:n=false,env:i=(p?"production":"development")}={})=>{const r=ve(e,t,{insideSvg:n,env:i});r.render();return new M(r)};const ye=e=>e===null||C.isNode(e)||typeof e!=="object"&&Object.getPrototypeOf(e)===Function.prototype;const ge=(e,t)=>I.isViewDeclaration(t)&&t.decorateWith(e);var xe=e=>{const t=N("decorator",8);return n=>{let i;if(I.isViewDeclaration(n))i=n;else if(typeof n==="string")i=new I(({state:e,children:t})=>D(n,e,t));else if(ye(n))i=new I(n);else throw new Error("Nothing to decorate");if(i.decorators[t])return i;let r=e(i);if(!I.isViewDeclaration(r)){if(ye(r))r=new I(r);else return ge(t,r)}if(i.originalId!=null)r.originalId=i.originalId;else r.originalId=i.id;return ge(t,r)}};const be=e=>e;const Ee=e=>t=>{if(e instanceof Function)return e(t)||{};else return e||{}};const Ne=(...e)=>xe(t=>new I(t.template,n=>{if(t.behavior instanceof Function)t.behavior(n);for(var i=0,r=e;i<r.length;i++){const e=r[i];e(n)}},t.actions));const Ce=e=>Ne(t=>{t.state=o({},Ee(e)(t.state),{},t.state)});const De=e=>xe(t=>new I(t.template,t.behavior,o({},t.actions||{},{},e||{})));const Ve=(t,n)=>e.compose(Ce(t),De(n));const Ae=e=>Ne(t=>{if("create"in e)e.create(t);if("mount"in e)t.onMount(e.mount);if("update"in e)t.onUpdate(e.update);if("unmount"in e)t.onUnmount(e.unmount);if("destroy"in e)t.onDestroy(e.destroy)});const Se=e=>xe(t=>new I(e,t.behavior,t.actions));const Te=e=>xe(t=>new I(n=>{const i=()=>{return t.template(n)};return e(i)(n)},t.behavior,t.actions));const Fe=(e=be)=>xe(t=>$(({state:n,children:i})=>D(t,e(n),i)));const ke=(t={})=>Fe(n=>{const i={};var r=true;var s=false;var o=undefined;try{for(var a=e.keys(t)[Symbol.iterator](),l;!(r=(l=a.next()).done);r=true){const e=l.value;if(e in n)i[t[e]]=n[e]}}catch(e){s=true;o=e}finally{try{if(!r&&a.return!=null){a.return()}}finally{if(s){throw o}}}return i});const Ie=e=>e;const Oe=(e=Ie)=>{const t=t=>{const n=e instanceof Function?e(t):e;const i=typeof n;if(i!=="object")throw new Error(`Context must be an object, got ${i}`);return n};return Ne(e=>{e.view.initializeContext(t)})};const Pe=e=>({context:e});const Le=(...e)=>{const t=t=>{if(e.length===0)return Pe(t);else if(e.length===1){const n=e[0];return n instanceof Function?n(t):{[n]:t[n]}}else{const r={};for(var n=0,i=e;n<i.length;n++){const e=i[n];r[e]=t[e]}return r}};return Ne(e=>{e.view.subscribeContext(t)})};const Ue=e=>{if(e==null)return(e,t)=>t;if(e instanceof Function)return e;else return t=>t[e]};const $e=e=>({data:e.data||[],accessor:Ue(e.indexBy),render:e.render,mountPoint:null,initialized:false,reverse:false,views:{},index:[],prevData:[]});const je=new I(({state:{render:e}})=>e);const Ke=e=>{let t=0;const n=[];var i=true;var r=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){const e=a.value;if(e.added){var l=true;var c=false;var h=undefined;try{for(var u=e.value[Symbol.iterator](),d;!(l=(d=u.next()).done);l=true){const e=d.value;n.push({added:true,value:e,index:t});t+=1}}catch(e){c=true;h=e}finally{try{if(!l&&u.return!=null){u.return()}}finally{if(c){throw h}}}}else if(e.removed){var f=true;var p=false;var m=undefined;try{for(var v=e.value[Symbol.iterator](),w;!(f=(w=v.next()).done);f=true){const e=w.value;n.push({removed:true,value:e,index:t})}}catch(e){p=true;m=e}finally{try{if(!f&&v.return!=null){v.return()}}finally{if(p){throw m}}}}else{var y=true;var g=false;var x=undefined;try{for(var b=e.value[Symbol.iterator](),E;!(y=(E=b.next()).done);y=true){const e=E.value;n.push({value:e,index:t});t+=1}}catch(e){g=true;x=e}finally{try{if(!y&&b.return!=null){b.return()}}finally{if(g){throw x}}}}}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}const N={};for(const e in n){const t=n[e];if(t.added)N[t.value]=e}for(let e=0;e<n.length;e++){const t=n[e];if(t.removed&&t.value in N){n.splice(e,1);e--}}return n};const Qe=({state:e})=>{const t=a(e.mountPoint,2),n=t[0],i=t[1];n.childNodes[i].remove();e.initialized=true;e.index=[];e.views={};for(const t in e.data){const r=+t;const s=e.data[r];const o=e.accessor(s,r,e.data);e.index.push(o);const a=D(je,{render:e.render(s,r,e.data)});const l=pe(n,a,i+r);e.views[o]={view:l,index:i+r}}He(e.index);e.prevData=e.data};const He=e=>{const t={};var n=true;var i=false;var r=undefined;try{for(var s=e[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;if(e in t)throw new Error("Item keys must be unique");t[e]=true}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}return e};const Me=({state:e})=>{const n=a(e.mountPoint,2),i=n[0],r=n[1];const s=e.data.map(e.accessor);He(s);const o=t.diffArrays(e.index,s);const l=Ke(o);const c={};for(const t in l){const n=l[t];const s=n.value;const o=+n.index;const a=s in e.views;if(n.added&&s!==e.index[o]){if(a){const t=n.index;const r=e.index[t];const o=e.views[s],a=o.index,l=o.view;const h=e.views[r].view;l.move(i,t);if(e.prevData[a]!==e.data[t])l.update({render:e.render(e.data[t],t,e.data)});h.move(i,a+1);if(e.prevData[t]!==e.data[a])h.update({render:e.render(e.data[a],t,e.data)});e.views[s]={view:l,index:t};e.views[r]={view:h,index:a};c[s]=true;c[r]=true}else{const t=e.data[o];const n=D(je,{render:e.render(t,o,e.data)});const a=pe(i,n,r+o);e.views[s]={view:a,index:r+o}}}else if(n.removed){const t=e.views[s].view;t.destroy();delete e.views[s]}else if(!(s in c)){const t=e.data[o];if(t!==e.prevData[o])e.views[s].view.update({render:e.render(t,o,e.data)})}}e.index=s;e.prevData=e.data};const We=e=>{if(e.state.mountPoint==null)return;if(e.state.initialized)Me(e);else Qe(e)};const ze=e=>{const t=e.state,n=e.element;t.mountPoint=[n.parentNode,Array.prototype.indexOf.call(n.parentNode.childNodes,n)];We(e)};const qe=({state:e})=>{for(var t=0,n=Object.values(e.views);t<n.length;t++){const e=n[t].view;e.destroy(false)}const i=a(e.mountPoint,2),r=i[0],s=i[1];for(let t=0;t<e.data.length;t++)r.childNodes[s].remove();e.mountPoint=null;e.initialized=false;e.views={};e.index=[];e.prevData=[]};const Be=function(){var e=i(function*(e){e.state=o({},e.state,{},$e(e.state));e.onMount(ze);e.onUpdate(We);e.onDestroy(qe)});return function t(n){return e.apply(this,arguments)}}();const Ge=new I(null,Be);const _e=new I(({state:e,children:t})=>{if(t.length!==0){if(t.length!==1||!(t[0]instanceof Function))throw new Error("You must provide a render function as the only children to the List");const n=t[0];return D(Ge,o({},e,{render:n}))}else return null});const Re=new I(({state:t,children:n})=>{if(n.length!==1||!(n[0]instanceof Function))throw new Error("You must provide a render function as the only children to the Map");const i=n[0];const r=([e,t],n,r)=>i(t,e,r,n);const s=e.keys(t.data||{}).map(e=>[e,t.data[e]]);const o=([e])=>e;return D(Ge,{data:s,indexBy:o,render:r})});const Ye=(e,t,n=null)=>e?t:n;const Je=new I(({state:{when:e=false},children:t})=>Ye(e,t,null));const Xe=new I(({state:{when:e=true},children:t})=>Ye(e,null,t));const Ze=t=>{const n=t!=null?t:x;return(t,i=null)=>{const r=i!=null?o({},i):null;if(r!=null&&"state"in r)r.state=o({},e.omit(["logger"],r.state));let s=r!=null?[t,r]:[t];n(...s)}};const et=e=>{const t={parent:e.element.parentNode,index:Array.prototype.indexOf.call(e.element.parentNode.childNodes,e.element)};if(e.children!=null&&e.children.length>0)t.element=e.element;return t};const tt=(e,t)=>{e.prev={state:t.state,children:t.children}};const nt=(t,n)=>{let i=null;const r={};var s=true;var a=false;var l=undefined;try{for(var c=e.keys(t.prev.state)[Symbol.iterator](),h;!(s=(h=c.next()).done);s=true){const e=h.value;r[e]=true}}catch(e){a=true;l=e}finally{try{if(!s&&c.return!=null){c.return()}}finally{if(a){throw l}}}var u=true;var d=false;var f=undefined;try{for(var p=e.keys(n.state)[Symbol.iterator](),m;!(u=(m=p.next()).done);u=true){const e=m.value;r[e]=true}}catch(e){d=true;f=e}finally{try{if(!u&&p.return!=null){p.return()}}finally{if(d){throw f}}}for(const e in r){const r=t.prev.state[e];const s=n.state[e];if(r!==s){if(i===null)i={};i[e]=s}}return{previousState:t.prev.state,nextState:o({},n.state),previousChildren:t.prev.children,nextChildren:n.children,update:i,childrenUpdated:t.prev.children!==n.children}};const it=e=>t=>{const n="DEBUG: created "+(t.state.info?`"${t.state.info}"`:"");const i={state:t.state};e(n,i)};const rt=(e,t)=>n=>{const i="DEBUG: mounted "+(n.state.info?`"${n.state.info}"`:"");const r={state:n.state,element:et(n)};tt(t,n);e(i,r)};const st=(e,t)=>n=>{const i="DEBUG: updated "+(n.state.info?`"${n.state.info}"`:"");const r={state:n.state,element:et(n)};const s=nt(t,n);if(s!=null)r.update=s;tt(t,n);e(i,r)};const ot=e=>t=>{const n="DEBUG: unmounted "+(t.state.info?`"${t.state.info}"`:"");const i={state:t.state,element:et(t)};e(n,i)};const at=e=>t=>{const n="DEBUG: destroyed "+(t.state.info?`"${t.state.info}"`:"");e(n)};const lt=e=>t=>{const n={prev:{}};it(e)(t);t.onMount(rt(e,n));t.onUpdate(st(e,n));t.onUnmount(ot(e));t.onDestroy(at(e))};const ct=new Map;const ht=1e4;const ut=(e=null)=>{if(ct.has(e))return ct.get(e);else{const t=new I(null,lt(Ze(e)));if(ct.size<ht)ct.set(e,t);return t}};var dt=new I(({state:t,children:n})=>D(ut(t.logger),e.omit(["logger"],t),n)).setDevelopmentOnly(true);var ft=new I(({children:e})=>e);exports.compose=e.compose;exports.shallowEqual=e.shallowEqual;exports.memoize=e.memoize;exports.h=D;exports.isElementNode=P;exports.isViewNode=O;exports.isTextNode=L;exports.Node=C;exports.view=U;exports.template=$;exports.instantiate=ve;exports.render=we;exports.hydrate=me;exports.mount=pe;exports.decorator=xe;exports.withBehavior=Ne;exports.withState=Ce;exports.withActions=De;exports.withStateActions=Ve;exports.withLifecycle=Ae;exports.withTemplate=Se;exports.mapTemplate=Te;exports.mapState=Fe;exports.renameState=ke;exports.withContext=Oe;exports.getContext=Le;exports.isDevelopment=f;exports.isProduction=p;exports.getGlobal=b;exports.warn=g;exports.Debug=dt;exports.Id=ft;exports.None=ft;exports.Show=Je;exports.Hide=Xe;exports.List=_e;exports.Map=Re;exports.branch=Ye;
