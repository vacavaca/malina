"use strict";Object.defineProperty(exports,"__esModule",{value:true});var e=require("malina-util");var t=require("diff");const n="123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ";const r=e=>{let t="";for(let r=0;r<e;r++)t+=n[Math.round(Math.random()*(n.length-1))];return t};class i{constructor(e,t,n,i){this.template=e;this.state=t;this.actions=n;this.hooks=i;this.id=r(8)}static isViewDeclaration(e){return typeof e==="object"&&e!==null&&e.isViewDeclaration instanceof Function&&e.isViewDeclaration()}isViewDeclaration(){return true}decorate(...t){return e.compose(...t)(this)}}const s=(e,t=null,n=null,r=null)=>new i(e instanceof Function?e:()=>e,t,n,r);const o=i;class a{constructor(t,n={},r=[]){if(t==null)throw new Error("JSX tag empty ");this.tag=t;this.attrs=n;this.children=e.flatten(r)}static isNode(e){return typeof e==="object"&&e!==null&&e.isNode instanceof Function&&e.isNode()}isNode(){return true}toString(){const e=typeof this.tag==="string"?this.tag:"View";return`${e} ${JSON.stringify(this.attrs||{})}${this.children.length>0?`\n${this.children.map(e=>{if(e==null)return"\t''";const t=e.toString();return t.split("\n").map(e=>`\t${e}`).join("\n")}).join("\n")}`:""}`}}const l=e=>a.isNode(e)&&o.isViewDeclaration(e.tag);const c=e=>a.isNode(e)&&!o.isViewDeclaration(e.tag);const d=e=>!(e instanceof Object)&&typeof e!=="object";const u=(e,t,...n)=>{const r=n.length===1&&Array.isArray(n[0])?n[0]:n;return new a(e,t,r)};function h(e,t,n,r,i,s,o){try{var a=e[s](o);var l=a.value}catch(e){n(e);return}if(a.done){t(l)}else{Promise.resolve(l).then(r,i)}}function f(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var s=e.apply(t,n);function o(e){h(s,r,i,o,a,"next",e)}function a(e){h(s,r,i,o,a,"throw",e)}o(undefined)})}}function m(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function v(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};var r=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))}r.forEach(function(t){m(e,t,n[t])})}return e}function p(e,t){return w(e)||y(e,t)||g()}function w(e){if(Array.isArray(e))return e}function y(e,t){var n=[];var r=true;var i=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){n.push(a.value);if(t&&n.length===t)break}}catch(e){i=true;s=e}finally{try{if(!r&&o["return"]!=null)o["return"]()}finally{if(i)throw s}}return n}function g(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}const b=e=>`on${e[0].toUpperCase()}${e.substr(1)}`;const x=e=>{const t=e.toLowerCase();return t.startsWith("on")?t.substr(2):t};class N{constructor({isSvg:e=false}){this.isSvg=e}}const E=e=>Array.isArray(e)&&e.length===2&&e[0]instanceof Function;const A=(e,t)=>E(e)&&E(t)&&e[0]===t[0]&&e[1]===t[1];let V=false;let k=[];const T=()=>new N({});const L=()=>new N({isSvg:true});const P=e=>e.length===0;const S=(e,t)=>e.tag.id===t.tag.id;const F=e=>{if(!e.every((t,n)=>n===0||!l(t)||!l(e[n-1])||t.attrs.key||!S(t,e[n-1])))throw new Error("Every view node in an array must have a 'key' attribute");return e};const I=e=>{let t={};var n=true;var r=false;var i=undefined;try{for(var s=e[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;if(l(e)&&e.attrs.key){if(!(e.tag.id in t))t[e.tag.id]={};if(e.attrs.key in t[e.tag.id])throw new Error("Every view node in an array must have an unique 'key' attribute")}}}catch(e){r=true;i=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(r){throw i}}}return e};const D=e.compose(F,I);class C{constructor(e,t){const n=e.tag,r=e.attrs,i=e.children;const s=n.state instanceof Function?n.state(r):n.state;const o=n.actions instanceof Function?n.actions(r):n.actions;const a=n.hooks instanceof Function?n.hooks(r):n.hooks;this.template=n.template;this.state=v({},s||{},r||{});this.actions=this.bindActions(o||{});this.children=i;this.hooks=a||{};this.renderingContext=t||T();this.templateLock=false;this.updateLock=false;this.element=null;this.node=null;this.innerViews=new Map;this.parametrizedEventListeners=new Map;this.scheduledActions=[];this.mounted=false;this.destroyed=false;this.trackedActionUpdate=false;this.callHook("create")}static instantiate(e,t=null){if(!l(e))throw new Error("View can only be instantiated from view-nodes");return new C(e,t)}mount(e,t){const n=e.ownerDocument;if(this.destroyed)return;let r=false;if(!V){V=true;r=true}const i=this.renderTemplate();if(Array.isArray(i))throw new Error("View can only have one root element");if(c(i)){if(i.tag==="svg")this.renderingContext=L();const n=this.mountNodeElement(e,t,i,[]);this.element=n}else if(l(i)){const n=this.instantiateInnerView(i,[]);n.mount(e,t);this.element=n.element}else if(d(i)){const r=n.createTextNode(`${i!=null?i:""}`);this.element=r;const s=e.childNodes[t]||null;e.insertBefore(r,s)}else throw new Error("Invalid template type");this.node=i;this.mounted=true;var s=true;var o=false;var a=undefined;try{for(var u=this.scheduledActions[Symbol.iterator](),h;!(s=(h=u.next()).done);s=true){const e=p(h.value,2),t=e[0],n=e[1];this.callAction(t,...n)}}catch(e){o=true;a=e}finally{try{if(!s&&u.return!=null){u.return()}}finally{if(o){throw a}}}this.scheduledActions=[];if(r){const e=k;k=[];for(var f=0;f<e.length;f++){const t=e[f];t()}this.callHook("mount");V=false}else k.push(()=>this.callHook("mount"))}move(e,t){const n=e.childNodes[t]||null;e.insertBefore(this.element,n);this.container=e;this.index=t}update(e=null,t=null){if(this.destroyed)throw new Error("View has been destroyed");const n=this.updateState(e);const r=this.updateChildrenState(t);const i=this.state!==n||this.children!==r;this.state=n;this.children=r;if(this.mounted&&i){this.refresh();this.callHook("update")}return i}refresh(){const e=this.renderTemplate();const t=this.node;this.node=e;this.patch(this.element,t,e,[])}unmount(e){this.mounted=false;if(c(this.node))this.destroyInnerViews(this.node,[]);else if(l(this.node))this.destroyInnerView([]);if(e)this.element.remove();this.callHook("unmount");this.element=null}destroy(e=true){this.unmount(e);this.callHook("destroy");this.destroyed=true}static getPathKey(e){return e.join(".")}static getAttrKey(e,t){return`${t}.${C.getPathKey(e)}`}renderTemplate(){this.templateLock=true;try{let e=this.template(this.state,this.actions,this.children);if(Array.isArray(e)){if(e.length!==1)throw new Error("Only one root element must be rendered for a view");e=e[0]}e=e!=null?e:"";return e}finally{this.templateLock=false}}bindActions(t){const n={};var r=true;var i=false;var s=undefined;try{for(var o=e.keys(t)[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){const e=a.value;const r=t[e];if(r instanceof Function)n[e]=((...n)=>this.callAction(t[e],...n));else n[e]=this.bindActions(r)}}catch(e){i=true;s=e}finally{try{if(!r&&o.return!=null){o.return()}}finally{if(i){throw s}}}return n}callAction(e,...t){var n=this;if(this.templateLock)throw new Error("Actions can't be called while rendering view template");if(this.mounted){const r=!this.updateLock;this.updateLock=true;const i=e(...t)(this.state,this.actions);if(i instanceof Promise){this.updateLock=false;if(this.trackedActionUpdate)this.refresh();this.trackedActionUpdate=false;return f(function*(){const e=yield i;if(!n.destroyed)n.update(e);return n.state})()}else{if(r){if(!this.destroyed&&this.mounted){const e=this.update(i);if(!e&&this.trackedActionUpdate)this.refresh();this.trackedActionUpdate=false}else if(!this.destroyed)this.state=this.updateState(i)}else{const e=this.updateState(i);this.trackedActionUpdate=this.trackedActionUpdate||this.state!==e;this.state=e}this.updateLock=false;return this.state}}else this.scheduledActions.push([e,t])}updateState(t=null){if(t==null||t===this.state)return this.state;const n=t!==null?v({},this.state,t):this.state;return!e.shallowEqual(this.state,n)?n:this.state}updateChildrenState(t=null){if(t===null||t===null)return this.children;const n=this.children==null||this.children.length===0;const r=t.length===0;if(n!==r)return t;else return!e.shallowEqual(this.children,t)?t:this.children}callHook(e){if(e in this.hooks)this.hooks[e](this.element,this.state,this.actions)}patch(e,t,n,r){if(t===n)return;if(c(t)){if(n==null)this.patchFromNodeToNone(e,t,r);else if(c(n))this.patchFromNodeToNode(e,t,n,r);else if(l(n))this.patchFromNodeToView(e,t,n,r);else if(d(n))this.patchFromNodeToText(e,t,n,r);else throw new Error("Invalid template type")}else if(l(t)){if(n==null)this.patchFromViewToNone(e,t,r);else if(c(n))this.patchFromViewToNode(e,t,n,r);else if(l(n))this.patchFromViewToView(e,t,n,r);else if(d(n))this.patchFromViewToText(e,t,n,r);else throw new Error("Invalid template type")}else{if(n==null)this.patchFromTextToNone(e,r);else if(c(n))this.patchFromTextToNode(e,n,r);else if(l(n))this.patchFromTextToView(e,n,r);else if(d(n))this.patchTextNodes(e,t,n,r);else throw new Error("Invalid template type")}}patchFromTextToNone(e,t){if(P(t))throw new Error("Root element deleted during patch");e.parentNode.removeChild(e)}patchTextNodes(e,t,n,r){if(t!==n){const t=e.ownerDocument.createTextNode(`${n}`);e.replaceWith(t);if(P(r))this.element=t}}patchFromTextToNode(e,t,n){const r=this.createNodeElement(e.ownerDocument,t,n);e.replaceWith(r);if(P(n))this.element=r}patchFromTextToView(e,t,n){const r=this.instantiateInnerView(t,n);const i=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const s=e.parentNode;e.remove();r.mount(s,i);if(P(n))this.element=r.element}patchFromNodeToNone(e,t,n){if(P(n))throw new Error("Root element deleted during patch");this.removeParametrizedListeners(t,n);this.destroyInnerViews(t,n);e.remove()}patchFromNodeToText(e,t,n,r){this.removeParametrizedListeners(t,r);this.destroyInnerViews(t,r);const i=e.ownerDocument.createTextNode(`${n}`);e.replaceWith(i);if(P(r))this.element=i}patchFromNodeToNode(e,t,n,r){if(t===n)return;if(t.tag===n.tag){this.updateAttributes(e,t,n,r);this.updateChildren(e,t,n,r)}else{this.removeParametrizedListeners(t,r);this.destroyInnerViews(t,r);const i=this.createNodeElement(e.ownerDocument,n,r);e.replaceWith(i);if(P(r))this.element=i}}patchFromNodeToView(e,t,n,r){this.removeParametrizedListeners(t,r);this.destroyInnerViews(t,r);const i=this.instantiateInnerView(n,r);const s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();i.mount(o,s);if(P(r))this.element=i.element}patchFromViewToNone(e,t,n){if(P(n))throw new Error("Root element deleted during patch");this.destroyInnerView(n);e.remove()}patchFromViewToText(e,t,n,r){this.destroyInnerView(r);const i=e.ownerDocument.createTextNode(`${n}`);e.replaceWith(i);if(P(r))this.element=i}patchFromViewToNode(e,t,n,r){this.destroyInnerView(r);const i=this.createNodeElement(e.ownerDocument,n,r);e.replaceWith(i);if(P(r))this.element=i}patchFromViewToView(e,t,n,r){if(t===n)return;if(S(t,n)&&t.attrs.key===n.attrs.key){const e=this.getInstantiatedView(r);e.update(n.attrs,n.children)}else{this.destroyInnerView(r);const t=this.instantiateInnerView(n,r);const i=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const s=e.parentNode;e.remove();t.mount(s,i);if(P(r))this.element=t.element}}unmountPatch(){this.mounted=false;this.callHook("unmount");this.element=null}destroyInnerViews(e,t){for(const n in e.children){const r=t.concat([n]);const i=e.children[n];if(l(i))this.destroyInnerView(r);else if(c(i))this.destroyInnerViews(i,r)}}destroyInnerView(e){const t=this.getInstantiatedView(e);t.destroy(false);this.removeInstantiatedView(e)}createNodeElement(e,t,n){let r;if(this.renderingContext.isSvg)r=e.createElementNS("http://www.w3.org/2000/svg",t.tag);else r=e.createElement(t.tag);this.refreshAttributes(r,t,n);this.refreshChildren(r,t,n);return r}mountNodeElement(e,t,n,r){const i=e.ownerDocument;let s;if(this.renderingContext.isSvg)s=i.createElementNS("http://www.w3.org/2000/svg",n.tag);else s=i.createElement(n.tag);this.refreshAttributes(s,n,r);const o=e.childNodes[t]||null;e.insertBefore(s,o);this.refreshChildren(s,n,r,true);return s}refreshAttributes(e,t,n){for(const r in t.attrs){const i=t.attrs[r];this.addAttribute(e,r,i,n)}}updateAttributes(e,t,n,r){if(t===n)return;for(const i in n.attrs){const s=n.attrs[i];if(i in t.attrs){const n=t.attrs[i];this.updateAttribute(e,i,n,s,r)}else this.addAttribute(e,i,s,r)}for(const i in t.attrs){if(!(i in n.attrs))this.removeAttribute(e,i,t.attrs[i],r)}}addAttribute(e,t,n,r){if(t==="style"){for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,x(t),n);else if(E(n)){const i=this.createParametrizedListener(n[0],n[1],r,t);const s=x(t);this.addEventListener(e,s,i)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t!=="focus"&&t in e&&!this.renderingContext.isSvg&&n!=null)e[t]=n;else if(typeof n==="boolean"){if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}else e.setattribute(t,t)}else if(n!=null)e.setAttribute(t,n)}updateAttribute(e,t,n,r,i){if(n===r)return;if(A(n,r))return;if(t==="style"){for(const t in n){if(!(t in r))this.removeStyleProp(e,t)}for(const t in r){const n=r[t]||"";this.setStyleProp(e,t,n)}}else if(r instanceof Function){this.removeAttribute(e,t,n,i);this.addAttribute(e,t,r,i)}else if(E(r)){this.removeAttribute(e,t,n,i);this.addAttribute(e,t,r,i)}else if(t==="data"){const t=n!=null&&typeof n==="object";const i=r!=null&&typeof r==="object";if(t&&i){for(const t in n){if(!(t in r))delete e.dataset[t]}for(const t in r)e.dataset[t]=r[t]}else if(t&&!i){for(const t in e.dataset)delete e.dataset[t]}else if(!t&&i){for(const t in r)e.dataset[t]=r[t]}}else if(t!=="focus"&&t in e&&!this.renderingContext.isSvg)e[t]=r;else if(typeof n==="boolean"){if(t==="focus"){if(e.focus&&e.blur){if(r)e.focus();else e.blur()}}else{if(r)e.setAttribute(t,t);else e.removeAttribute(t)}}else{if(r!=null)e.setAttribute(t,r);else if(n!=null)e.removeAttribute(t)}}removeAttribute(e,t,n,r){if(t==="style")e.style.cssText="";else if(n instanceof Function){const r=x(t);this.removeEventListener(e,r,n)}else if(E(n)){const n=this.getParametrizedListener(r,t);const i=x(t);this.removeEventListener(e,i,n)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in e.dataset)delete e.dataset[t]}else if(t!=="focus"&&t in e&&!this.renderingContext.isSvg)e[t]=undefined;else if(typeof n==="boolean"){if(t==="focus"&&e.blur)e.blur();else e.removeAttribute(t)}else if(n!=null)e.removeAttribute(t)}setStyleProp(e,t,n){if(t[0]==="-"){const r=n.indexOf("!important");let i=n;if(r!==-1)i=r!==n.slice(0,r)+n.slice(r+10);i=i.trim().replace(/;$/,"");e.style.setProperty(t,i)}else e.style[t]=n}removeStyleProp(e,t){if(t[0]==="-")e.style.removeProperty(t);else delete e.style[t]}addEventListener(e,t,n){if(e.addEventListener)e.addEventListener(t,n);else if(e.attachEvent)e.attachEvent(b(t),n);else{const r=e[t]&&e[t].listeners||[];if(e[t]!=null)e[t].listeners=r.concat(n);else{const i=(...n)=>e[t].listeners.map(e=>e(...n));i.listeners=r.concat(n);e[t]=i}}}removeEventListener(e,t,n){if(e.removeEventListener)e.removeEventListener(t,n);else if(e.detachEvent)e.detachEvent(b(t),n);else{if(e[t]!=null&&e[t].listeners!=null)e[t].listeners=e[t].listener.filter(e=>e!==n)}}refreshChildren(e,t,n,r=false){if(!D(t.children))throw new Error("Every view node in an array must have an unique 'key' attribute");for(const i in t.children){const s=t.children[i];const o=n.concat([i]);this.addChildren(e,s,i,o,r)}}addChildren(e,t,n=null,r,i=false){if(c(t)){if(i)this.mountNodeElement(e,null,t,r);else{const n=this.createNodeElement(e.ownerDocument,t,r);e.appendChild(n)}}else if(l(t)){const i=this.instantiateInnerView(t,r);i.mount(e,n)}else if(t!=null){const n=e.ownerDocument.createTextNode(`${t}`);e.appendChild(n)}}updateChildren(e,t,n,r){if(t===n)return;if(!D(n.children))throw new Error("Every view node in an array must have an unique 'key' attribute");const i=Math.max(t.children.length,n.children.length);let s=0;for(let o=0;o<i;o++){const i=e.childNodes[o-s];const a=t.children[o];const l=o in n.children?n.children[o]:null;const c=r.concat([o]);if(a!=null){this.patch(i,a,l,c);if(l==null)s+=1}else{this.addChildren(e,l,o,c);s-=1}}}instantiateInnerView(e,t){const n=C.getPathKey(t);const r=C.instantiate(e,this.renderingContext);this.innerViews.set(n,{view:r,path:t.slice()});return r}getInstantiatedView(e){const t=C.getPathKey(e);const n=this.innerViews.get(t);return n!=null?n.view:null}removeInstantiatedView(e){const t=C.getPathKey(e);this.innerViews.delete(t)}getParametrizedListener(e,t){const n=C.getAttrKey(e,t);return this.parametrizedEventListeners.get(n)}hasParametrizedListener(e,t){const n=C.getAttrKey(e,t);return this.parametrizedEventListeners.has(n)}createParametrizedListener(e,t,n,r){const i=(...n)=>e(...t,...n);const s=C.getAttrKey(n,r);this.parametrizedEventListeners.set(s,i);return i}removeParametrizedListeners(e,t){for(const n in e.attrs){if(this.hasParametrizedListener(t,n))this.removeParametrizedListener(t,n)}for(const n in e.children){const r=t.concat([n]);const i=e.children[n];if(c(i))this.removeParametrizedListeners(i,r)}}removeParametrizedListener(e,t){const n=C.getAttrKey(e,t);this.parametrizedEventListeners.delete(n)}}const z=(e,t,n=0)=>{let r=t;if(c(t))r=u(s(t));const i=e.ownerDocument.defaultView;const o=e instanceof i.SVGElement?L():T();const a=C.instantiate(r,o);a.mount(e,n);return a};const j=e=>t=>{let n;if(o.isViewDeclaration(t))n=t;else if(typeof t==="string")n=s((e,n,r)=>u(t,e,r));else n=s(t);const r=e(n);if(o.isViewDeclaration(r))return r;else return s(r)};const $=e=>{if(e==null)throw new Error("'indexBy' attribute of the List view must be defined as a string or function");if(e instanceof Function)return e;else return t=>t[e]};const O=e=>({data:e.data||[],accessor:$(e.indexBy),render:e.render,mountPoint:null,initialized:false,views:[],index:[],prevData:[]});const K=s(({render:e})=>e);const U={};const q=e=>{let t=0;const n=[];var r=true;var i=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(r=(a=o.next()).done);r=true){const e=a.value;if(e.added){var l=true;var c=false;var d=undefined;try{for(var u=e.value[Symbol.iterator](),h;!(l=(h=u.next()).done);l=true){const e=h.value;n.push({added:true,value:e,index:t});t+=1}}catch(e){c=true;d=e}finally{try{if(!l&&u.return!=null){u.return()}}finally{if(c){throw d}}}}else if(e.removed){var f=true;var m=false;var v=undefined;try{for(var p=e.value[Symbol.iterator](),w;!(f=(w=p.next()).done);f=true){const e=w.value;n.push({removed:true,value:e,index:t})}}catch(e){m=true;v=e}finally{try{if(!f&&p.return!=null){p.return()}}finally{if(m){throw v}}}}else{var y=true;var g=false;var b=undefined;try{for(var x=e.value[Symbol.iterator](),N;!(y=(N=x.next()).done);y=true){const e=N.value;n.push({value:e,index:t});t+=1}}catch(e){g=true;b=e}finally{try{if(!y&&x.return!=null){x.return()}}finally{if(g){throw b}}}}}}catch(e){i=true;s=e}finally{try{if(!r&&o.return!=null){o.return()}}finally{if(i){throw s}}}const E={};for(const e in n){const t=n[e];if(t.added)E[t.value]=e}for(let e=0;e<n.length;e++){const t=n[e];if(t.removed&&t.value in E){n.splice(e,1);e--}}return n};U.initialize=(()=>e=>{const t=p(e.mountPoint,2),n=t[0],r=t[1];while(n.firstChild)n.firstChild.remove();e.initialized=true;e.index=[];e.views={};for(const t in e.data){const i=+t;const s=e.data[i];const o=e.accessor(s);e.index.push(o);const a=u(K,{render:e.render(s,i,e.data)});const l=z(n,a,r+i);e.views[o]={view:l,index:r+i}}H(e.index);e.prevData=e.data});const H=e=>{const t={};var n=true;var r=false;var i=undefined;try{for(var s=e[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;if(e in t)throw new Error("Item keys must be unique");t[e]=true}}catch(e){r=true;i=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(r){throw i}}}return e};U.diffUpdate=(()=>e=>{const n=p(e.mountPoint,2),r=n[0],i=n[1];const s=e.data.map(e.accessor);H(s);const o=t.diffArrays(e.index,s);const a=q(o);const l={};for(const t in a){const n=a[t];const s=n.value;const o=+n.index;const c=s in e.views;if(n.added&&s!==e.index[o]){if(c){const t=n.index;const i=e.index[t];const o=e.views[s],a=o.index,c=o.view;const d=e.views[i].view;c.move(r,t);if(e.prevData[a]!==e.data[t])c.update({render:e.render(e.data[t],t,e.data)});d.move(r,a+1);if(e.prevData[t]!==e.data[a])d.update({render:e.render(e.data[a],t,e.data)});e.views[s]={view:c,index:t};e.views[i]={view:d,index:a};l[s]=true;l[i]=true}else{const t=e.data[o];const n=u(K,{render:e.render(t,o,e.data)});const a=z(r,n,i+o);e.views[s]={view:a,index:i+o}}}else if(n.removed){const t=e.views[s].view;t.destroy();delete e.views[s]}else if(!(s in l)){const t=e.data[o];if(t!==e.prevData[o])e.views[s].view.update({render:e.render(t,o,e.data)})}}e.index=s;e.prevData=e.data});U.update=(()=>(e,t)=>{if(e.mountPoint==null)return;if(e.initialized)t.diffUpdate();else t.initialize()});const M={};M.mount=((e,t,n)=>{t.mountPoint=[e.parentNode,Array.prototype.indexOf.call(e.parentNode.childNodes,e)];n.update()});M.update=((e,t,n)=>{n.update()});M.unmount=((e,t)=>{t.mountPoint=null;t.views=[];t.index=[]});const W=s(null,O,U,M);const B=s((e,t,n)=>{let r=n[0];if(n.length>1)throw new Error("You must provide only one child to the List, it can be a render function or a jsx node");if(r==null)return null;r=r instanceof Function?r:()=>r;return u(W,v({},e,{render:r}))});const R=s((t,n,r)=>{let i=r[0];if(r.length>1)throw new Error("You must provide only one child to the Map, it can be a render function or a jsx node");if(i==null)return null;i=i instanceof Function?i:()=>i;const s=([e,t])=>i(t);const o=e.keys(t.data||{}).map(e=>[e,t.data[e]]);const a=([e])=>e;return u(W,{data:o,indexBy:a,render:s})},{data:{}});exports.view=s;exports.h=u;exports.isElementNode=c;exports.isViewNode=l;exports.isTextNode=d;exports.Node=a;exports.mount=z;exports.decorator=j;exports.List=B;exports.Map=R;
