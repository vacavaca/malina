"use strict";Object.defineProperty(exports,"__esModule",{value:true});var e=require("malina-util");var t=require("diff");let n="production";try{n=process.env.NODE_ENV}catch(e){}const i=e=>e==="development"||e==="testing";const r=n==="development"||n==="testing";const s=!r;const o=typeof self==="object"&&self.self===self&&self||typeof global==="object"&&global.global===global&&global||this;const a="console"in o;const l=a&&"warn"in o.console;const c=a&&"log"in o.console;const h=e=>{if(r&&l)o.console.warn(e)};const u=(...e)=>{if(r&&c)o.console.log(...e)};const d=()=>o;const f=(e,t=null)=>{if(r&&l){if(!e())throw new Error(`Condition failed${t!=null?`: ${t}`:""}`)}};class m{constructor(t,n={},i=[]){if(t==null)throw new Error("Node tag cannot be empty");this.tag=t;this.attrs=n||{};this.children=e.flatten(i);this.isDevOnly=typeof t==="object"&&t.isDevOnly}static isNode(e){return typeof e==="object"&&e!==null&&e.isNode instanceof Function&&e.isNode()}static isEqualNodes(e,t,n=true){const i=m.isNode(e);if(i!==m.isNode(t))return false;if(i)return e.isEqual(t);else return e===t}isNode(){return true}isDevOnly(){return this.isDevOnly}isEqual(t,n=true){if(this===t)return true;if(this.tag!==t.tag)return false;if(this.isDevOnly!==t.isDevOnly)return false;if(!e.shallowEqual(this.attrs,t.attrs))return false;if(n){if(this.children===t.children)return true;const e=this.children.length;if(e!==t.children.length)return false;for(let n=0;n<e;n++){if(!m.isEqualNodes(this.children[n],t.children[n]))return false}}return true}toString(){const e=Object.keys(this.attrs).reduce((e,t)=>{const n=this.attrs[t];if(typeof n==="string")return`${e} ${t}="${n}"`;else if(n instanceof Function)return`${e} ${t}=[Function]`;else return`${e} ${t}={${typeof n!=="object"?JSON.stringify(n):"{...}"}}`},"");const t=typeof this.tag==="string"?this.tag:"[View]";if(this.children.length>0){return`<${t}${e}>\n${this.children.map(e=>{if(e==null)return'\t""';const t=e.toString();return t.split("\n").map(e=>`\t${e}`).join("\n")}).join("\n")}\n</${t}>`}else return`<${t}${e}/>`}}const v=(e,t,...n)=>{const i=n.length===1&&Array.isArray(n[0])?n[0]:n;return new m(e,t,i)};const p=d();const w=Symbol.for("__malina.declaration.random");let y;if(p!=null&&w in p)y=p[w];else{y={generator:new e.Random("malina.view-id-seed"),counter:9};if(p!=null)p[w]=y}const g=4;const b=(e,t,n)=>{if(n.length>=g)return t;const i=m.isNode(e);if(i!==m.isNode(t))return t;if(!i)return t;const r=D(e);const s=D(t);if(r&&s){if(e.isEqual(t))return e}else if(r===s){const i=e.children.length;if(e.isEqual(t,false)&&i===t.children.length){for(let r=0;r<i;r++){const i=n.concat([r]);const s=e.children[r];const o=t.children[r];const a=b(s,o,i);if(a!==s)return t}return e}}return t};const x=e=>{let t=null;return(...n)=>{const i=e(...n);if(t===i)return i;const r=m.isNode(t);const s=m.isNode(i);if(r&&s){const e=b(t,i,[]);t=e;return e}else if(s){t=i;return i}else{t=null;return i}}};const E=e=>{if(e instanceof Function)return x(e);else return E(()=>e)};class N{constructor(e,t,n){this.template=E(e);this.behavior=t||(()=>{});this.actions=n||{};this.id=`${y.generator.id(8)}${++y.counter}`;this.originalId=null;this.isDevOnly=false}static isViewDeclaration(e){return typeof e==="object"&&e!==null&&e.isViewDeclaration instanceof Function&&e.isViewDeclaration()}isViewDeclaration(){return true}setDevelopmentOnly(e){this.isDevOnly=e;return this}is(e){return this===e||this.id===e.id||this.originalId===e.originalId}}const D=e=>m.isNode(e)&&N.isViewDeclaration(e.tag);const V=e=>m.isNode(e)&&!N.isViewDeclaration(e.tag);const A=e=>!(e instanceof Object)&&typeof e!=="object";var T=new N(({children:e})=>e);var k=new N(null);function F(e,t,n,i,r,s,o){try{var a=e[s](o);var l=a.value}catch(e){n(e);return}if(a.done){t(l)}else{Promise.resolve(l).then(i,r)}}function S(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function o(e){F(s,i,r,o,a,"next",e)}function a(e){F(s,i,r,o,a,"throw",e)}o(undefined)})}}function L(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function I(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};var i=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))}i.forEach(function(t){L(e,t,n[t])})}return e}function P(e,t){return O(e)||U(e,t)||C()}function O(e){if(Array.isArray(e))return e}function U(e,t){var n=[];var i=true;var r=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){n.push(a.value);if(t&&n.length===t)break}}catch(e){r=true;s=e}finally{try{if(!i&&o["return"]!=null)o["return"]()}finally{if(r)throw s}}return n}function C(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}class ${constructor(){this.resolvers={};this.listeners={}}notify(e,t=[]){if(e in this.listeners){const a=this.listeners[e];var n=true;var i=false;var r=undefined;try{for(var s=a[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;e(...t)}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}}if(e in this.resolvers){const n=this.resolvers[e];delete this.resolvers[e];var a=true;var l=false;var c=undefined;try{for(var h=n[Symbol.iterator](),u;!(a=(u=h.next()).done);a=true){const e=P(u.value,2),n=e[0],i=e[1];const r=i&&t.length===1?t[0]:t;n(r)}}catch(e){l=true;c=e}finally{try{if(!a&&h.return!=null){h.return()}}finally{if(l){throw c}}}}}wait(e,t=true){return new Promise(n=>{if(!(e in this.resolvers))this.resolvers[e]=[[n,t]];else this.resolvers[e].push([n,t])})}waitFor(e,t){return new Promise(n=>{const i=(...e)=>{if(t(...e))n(...e)};if(!(e in this.resolvers))this.resolvers[e]=[[i]];else this.resolvers[e].push([i])})}on(e,t){if(!(e in this.listeners))this.listeners[e]=[t];else this.listeners[e].push(t);return()=>this.off(e,t)}off(e,t){if(e in this.listeners)this.listeners.splice(this.listeners.indexOf(t),1)}}class j{constructor(e){this.view=e}get state(){return this.view.state}set state(e){this.view.state=e}get actions(){return this.view.actions}get children(){return this.view.children||[]}}class q extends j{get isMounted(){return this.view.mounted}get isDestroyed(){return this.view.destroyed}get element(){return this.view.element}update(e){if(!this.isDestroyed)return this.view.update(e);else return this.state}mount(){return this.view.dispatcher.wait("mount",true)}onMount(e){return this.view.dispatcher.on("mount",()=>e(this))}nextUpdate(){return this.view.dispatcher.wait("update",true)}onUpdate(e){return this.view.dispatcher.on("update",()=>e(this))}unmount(){return this.view.dispatcher.wait("unmount",true)}onUnmount(e){return this.view.dispatcher.on("unmount",()=>e(this))}onDestroy(e){return this.view.dispatcher.on("destroy",()=>e(this))}waitFor(e,t){var n=this;return S(function*(){if(e(n.state))return true;while(yield n.updating()){if(e(n.state))return true}if(e(n.state))return true;return false})()}updating(){var e=this;return S(function*(){return Promise.race([e.nextUpdate().then(()=>true),e.unmount().then(()=>false)])})()}setTimeout(e,t){const n=setTimeout(e,t);this.onDestroy(()=>clearTimeout(n))}setInterval(e,t){const n=setInterval(e,t);this.onDestroy(()=>clearInterval(n))}}class H extends j{get isMounted(){return this.view.mounted}get isDestroyed(){return this.view.destroyed}get element(){return this.view.element}render(){return this.view.render()}attach(e=null){this.view.attach(e)}update(e=null,t=null){if(!this.isDestroyed)return this.view.update(e,t);else return this.state}move(e,t){return this.view.move(e,t)}unmount(){this.view.unmount()}destroy(e=true){this.view.destroy(e)}onMount(e){return this.view.dispatcher.on("mount",()=>e(this))}onUpdate(e){return this.view.dispatcher.on("update",()=>e(this))}onUnmount(e){return this.view.dispatcher.on("unmount",()=>e(this))}onDestroy(e){return this.view.dispatcher.on("destroy",()=>e(this))}}class M{constructor(e,t,n){this.document=e;this.store=I({},t);this.globalStore=n}static initialize(e,t){return new M(e,t,{})}isLocked(){return this.getOrCreate("lock",false)}lock(){return this.update("lock",true)}unlock(){return this.update("lock",false)}getCallbackQueue(e){return this.getOrCreate(`callback-queue.${e}`,[],true)}setSvg(e){return this.copyWith({svg:e})}isSvg(){return this.getOrCreate("svg",false)}setInProduction(e){return this.update("production",e)}isInProduction(){return this.getOrCreate("production",true)}isUpdating(){return this.getOrCreate("updating",false)}setUpdating(e){return this.update("updating",e)}getDocument(){return this.document}update(e,t){this.store[e]=t;return this}copy(e){return new M(this.document,I({},this.store,e),this.globalStore)}getOrCreate(e,t,n=false){const i=n?this.globalStore:this.store;if(e in i)return i[e];else{i[e]=t;return i[e]}}}const W=e=>e instanceof e.ownerDocument.defaultView.HTMLTemplateElement;const z=(e,t)=>{const n=e.length-t.length;if(n!==0)return-n;for(const n in e){const i=e[n]-t[n];if(i!==0)return i}return 0};const B=(e,t=1)=>e.length?e.slice(0,-1).concat([e[e.length-1]+t]):e;const K=e=>e.length===0;class Q{constructor(e){this.view=e;this.deleted=false}delete(){this.deleted=true}}class _{constructor(){this.views={};this.index=[]}hasView(e){return _.getPathKey(e)in this.views}getView(e){const t=_.getPathKey(e);return t in this.views?this.views[t].view:null}*iterateViews(e=[],t=false){let n=0;if(!K(e)){const t=this.searchPath(e);n=t>=0?t:-t-1}let i=null;if(!K(e)){const t=this.searchPath(B(e));i=t>=0?t+1:-t}i=i!=null?Math.min(i,this.index.length):i;for(let e=n;e<(i!==null?i:this.index.length);e++){const n=!t?e:this.index.length-e-1;const i=this.index[n],r=i.view,s=i.key;const o=new Q(r);yield o;if(o.deleted){this.index.splice(n,1);if(!t)e-=1;delete this.views[s]}}}addView(e,t){const n=this.searchPath(e);const i=n>=0?n:-n-1;const r=_.getPathKey(e);const s={view:t,path:e,key:r};this.views[r]=s;this.index.splice(i,0,s)}removeView(e){const t=_.getPathKey(e);if(!(t in this.views))return null;const n=this.searchPath(e);const i=this.views[t].view;this.index.splice(n,1);delete this.views[t];return i}isEmpty(){return this.index.length===0}static getPathKey(e){return e.join(".")}searchPath(t){return e.binarySearch(t,this.index,(e,t)=>{const n="path"in e?e.path:e;const i="path"in t?t.path:t;return z(n,i)})}}const G=e=>`on${e[0].toUpperCase()}${e.substr(1)}`;const R=e=>{const t=e.toLowerCase();return t.startsWith("on")?t.substr(2):t};const Y=e=>e.length===0;const J=(e,t)=>e.tag.id===t.tag.id;const X=e=>{const t=e.children;if(!t.every((e,n)=>n===0||!D(e)||!D(t[n-1])||e.attrs.key||!J(e,t[n-1])))throw new Error("Every view node in an array must have a 'key' attribute");return e};const Z=e=>{const t=e.children;let n={};var i=true;var r=false;var s=undefined;try{for(var o=t[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){const e=a.value;if(D(e)&&e.attrs.key){if(!(e.tag.id in n))n[e.tag.id]={};if(e.attrs.key in n[e.tag.id])throw new Error("Every view node in an array must have an unique 'key' attribute");n[e.tag.id][e.attrs.key]=true}}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}return e};const ee=e=>{const t=e.attrs,n=e.children;if("innerHtml"in t&&t.innerHtml!=null&&n!=null&&n.length>0)throw new Error('Nodes with "innerHtml" attribute must not have children');return e};const te=e.compose(X,Z,ee);const ne=(e,t,n)=>{const i=W(e)?e.content:e;const r=i.childNodes[t];i.insertBefore(n,r)};const ie=(e,t)=>{const n=W(e)?e.content:e;n.removeChild(t)};const re=/^[a-z][a-z0-9.-_]*-[a-z0-9.-_]*$/;const se=["annotation-xml","color-profile","font-face","font-face-src","font-face-uri","font-face-format","font-face-name","missing-glyph"];const oe=e=>V(e)&&!se.includes(e.tag)&&(re.test(e.tag)||"is"in e.attrs&&re.test(e.attrs.is));const ae=(e,t)=>t instanceof e.getDocument().defaultView.Element||t instanceof e.getDocument().defaultView.Text;class le{constructor(e,t){this.view=e;this.context=t;this.element=null;this.eventListeners=new Map;this.eventListenerDelegates=new Map}render(e){return this.createNode(e,[],this.context)}hydrate(e,t){if(this.element!==null)throw new Error("Already attached");this.hydrateNode(e,t,[],this.context);this.attach(e)}attach(e,t){if(this.element!==null)throw new Error("Already attached");this.element=e;this.attachNode(e,t,[],this.context)}mount(e,t){ne(e,t,this.element)}move(e,t){ne(e,t,this.element)}update(e,t){const n=this.context.setUpdating(true);this.patch(this.element,e,t,[],n);this.context=n.setUpdating(false)}detach(e){if(this.element===null)throw new Error("Already detached");this.detachNode(this.element,e,[],this.context);f(()=>this.eventListeners.size===0,"Event listeners map is empty after detach");f(()=>this.eventListenerDelegates.size===0,"Event listener delegates map is empty after detach");this.element=null}static getAttrKey(e,t){return`${t}.${e.join(".")}`}patch(e,t,n,i,r){if(t===n)return;if(V(t)){if(n==null)this.patchFromNodeToNone(e,t,i,r);else if(V(n))this.patchFromNodeToNode(e,t,n,i,r);else if(D(n))this.patchFromNodeToView(e,t,n,i,r);else if(A(n))this.patchFromNodeToText(e,t,n,i);else if(ae(r,n))this.patchFromElementNodeToDom(e,n,i);else throw new Error("Invalid template type")}else if(D(t)){if(n==null)this.patchFromViewToNone(e,t,i);else if(V(n))this.patchFromViewToNode(e,t,n,i,r);else if(D(n))this.patchFromViewToView(e,t,n,i,r);else if(A(n))this.patchFromViewToText(e,t,n,i);else if(ae(r,n))this.patchFromViewToDom(e,n,i);else throw new Error("Invalid template type")}else if(ae(r,t)){if(n==null)this.patchFromDomToNone(e,i);else if(V(n))this.patchFromDomToNode(e,n,i,r);else if(D(n))this.patchFromDomToView(e,n,i,r);else if(A(n))this.patchFromDomToText(e,n,i);else if(ae(r,n))this.patchFromDomToDom(e,n,i);else throw new Error("Invalid template type")}else{if(n==null)this.patchFromTextToNone(e,i);else if(V(n))this.patchFromTextToNode(e,n,i,r);else if(D(n))this.patchFromTextToView(e,n,i,r);else if(A(n))this.patchTextNodes(e,t,n,i);else if(ae(r,n))this.patchFromTextToDom(e,n,i);else throw new Error("Invalid template type")}}patchFromElementNodeToDom(e,t,n){if(e!==t){e.replaceWith(t);if(Y(n))this.element=t}}patchFromViewToDom(e,t,n){this.view.destroyInnerView(n,false);e.replaceWith(t);if(Y(n))this.element=t}patchFromDomToNone(e,t){if(Y(t))throw new Error("Root element deleted during patch");ie(e.parentNode,e)}patchFromDomToNode(e,t,n,i){const r=this.createElementNode(t,n,i);e.replaceWith(r);if(Y(n))this.element=r}patchFromDomToView(e,t,n,i){const r=this.view.instantiateInnerView(t,n,i);let s;if(n.length>0)s=n[n.length-1];else s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();if(i.isUpdating()){i.setUpdating(false);const e=r.render();i.setUpdating(true);ne(o,s,e);r.attach(e)}else throw new Error("Unreachable");if(Y(n))this.element=r.element}patchFromDomToText(e,t,n){const i=this.context.getDocument().createTextNode(`${t}`);e.replaceWith(i);if(Y(n))this.element=i}patchFromDomToDom(e,t,n){if(e!==t){e.replaceWith(t);if(Y(n))this.element=t}}patchFromTextToDom(e,t,n){e.replaceWith(t);if(Y(n))this.element=t}patchFromTextToNone(e,t){if(Y(t))throw new Error("Root element deleted during patch");ie(e.parentNode,e)}patchTextNodes(e,t,n,i){if(t!==n){const t=this.createTextNode(n);e.replaceWith(t);if(Y(i))this.element=t}}patchFromTextToNode(e,t,n,i){const r=this.createElementNode(t,n,i);e.replaceWith(r);if(Y(n))this.element=r}patchFromTextToView(e,t,n,i){const r=this.view.instantiateInnerView(t,n,i);let s;if(n.length>0)s=n[n.length-1];else s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();if(i.isUpdating()){i.setUpdating(false);const e=r.render();i.setUpdating(true);ne(o,s,e);r.attach(e)}else throw new Error("Unreachable");if(Y(n))this.element=r.element}patchFromNodeToNone(e,t,n,i){if(Y(n))throw new Error("Root element deleted during patch");this.detachElementNode(e,t,n,i);e.remove()}patchFromNodeToText(e,t,n,i){const r=this.context.getDocument().createTextNode(`${n}`);e.replaceWith(r);if(Y(i))this.element=r}patchFromNodeToNode(e,t,n,i,r){if(t===n)return;const s=oe(t);const o=oe(n);if(t.tag===n.tag){if(s&&o){this.updateAttributes(e,t,n,i,r);e.innerHTML="";this.createChildren(e,n,i,r)}else if(s||o){const t=this.createElementNode(n,i,r);e.replaceWith(t);if(Y(i))this.element=t}else{this.updateAttributes(e,t,n,i,r);this.updateChildren(e,t,n,i,r)}}else{const t=this.createElementNode(n,i,r);e.replaceWith(t);if(Y(i))this.element=t}}patchFromNodeToView(e,t,n,i,r){const s=this.view.instantiateInnerView(n,i,r);let o;if(i.length>0)o=i[i.length-1];else o=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const a=e.parentNode;e.remove();if(r.isUpdating()){r.setUpdating(false);const e=s.render();r.setUpdating(true);ne(a,o,e);s.attach(e)}else throw new Error("Unreachable");if(Y(i))this.element=s.element}patchFromViewToNone(e,t,n){if(Y(n))throw new Error("Root element deleted during patch");this.view.destroyInnerView(n)}patchFromViewToText(e,t,n,i){this.view.destroyInnerView(i,false);const r=this.context.getDocument().createTextNode(`${n}`);e.replaceWith(r);if(Y(i))this.element=r}patchFromViewToNode(e,t,n,i,r){this.view.destroyInnerView(i,false);const s=this.createElementNode(n,i,r);e.replaceWith(s);if(Y(i))this.element=s}patchFromViewToView(e,t,n,i,r){if(t===n)return;if(J(t,n)&&t.attrs.key===n.attrs.key){const e=this.view.getInstantiatedInnerView(i);e.update(n.attrs,n.children)}else{const t=e.parentNode;let s;if(i.length>0)s=i[i.length-1];else s=Array.from(t.childNodes).findIndex(t=>t===e);this.view.destroyInnerView(i);const o=this.view.instantiateInnerView(n,i,r);e.remove();if(r.isUpdating()){r.setUpdating(false);const e=o.render();r.setUpdating(true);ne(t,s,e);o.attach(e)}else throw new Error("Unreachable");if(Y(i))this.element=o.element}}createNode(e,t,n){if(V(e))return this.createElementNode(e,t,n);else if(D(e))return this.createViewNode(e,t,n);else if(ae(n,e))return e;else if(e===null||A(e))return this.createTextNode(e)}hydrateNode(e,t,n,i){if(V(t))return this.hydrateElementNode(e,t,n,i);else if(D(t))return this.hydrateViewNode(e,t,n,i)}attachNode(e,t,n,i){if(V(t))return this.attachElementNode(e,t,n,i);else if(D(t))return this.attachViewNode(e,n)}detachNode(e,t,n,i){if(V(t))return this.detachElementNode(e,t,n,i);else if(D(t))return this.detachViewNode(e,n)}createElementNode(e,t,n){let i=n.isSvg();let r;if(!i&&e.tag==="svg"){n=n.setSvg(true);i=true}if(i)r=n.getDocument().createElementNS("http://www.w3.org/2000/svg",e.tag);else r=n.getDocument().createElement(e.tag);this.addAttributes(r,e,t,n);this.createChildren(r,e,t,n);return r}hydrateElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.hydrateAttributes(e,t,n,i);this.hydrateChildren(e,t,n,i)}attachElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.attachAttributes(e,t,n,i);this.attachChildren(e,t,n,i)}detachElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.detachAttributes(e,t,n,i);this.detachChildren(e,t,n,i)}createViewNode(e,t,n){const i=n.isUpdating();const r=this.view.instantiateInnerView(e,t,n);let s;if(i){n=n.setUpdating(false);s=r.render(this.document);n=n.setUpdating(true);r.attach(s)}else s=r.render(this.document);return s}hydrateViewNode(e,t,n,i){const r=this.view.getOrInstantiateInnerView(t,n,i);return r.hydrate(e)}attachViewNode(e,t){const n=this.view.getInstantiatedInnerView(t);return n.attach(e)}detachViewNode(e,t){const n=this.view.getInstantiatedInnerView(t);n.unmount()}createTextNode(e){return this.context.getDocument().createTextNode(`${e!=null?e:""}`)}createChildren(e,t,n,i){if(!te(t))throw new Error("Every view node in an array must have an unique 'key' attribute");if("innerHtml"in t.attrs)e.innerHTML=t.attrs.innerHtml;else{const r=i.getDocument().createDocumentFragment();let s=0;for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}const a=n.concat([e-s]);const l=this.createNode(o,a,i);r.appendChild(l)}if(t.children.length>0){const t=W(e)?e.content:e;t.appendChild(r)}}}hydrateChildren(e,t,n,i){if(!te(t))throw new Error("Every view node in an array must have an unique 'key' attribute");if(oe(t))return;const r=W(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(oe(o))continue;const a=n.concat([e-s]);const l=r.childNodes[e];this.hydrateNode(l,o,a,i)}}}attachChildren(e,t,n,i){if(!te(t))throw new Error("Every view node in an array must have an unique 'key' attribute");if(oe(t))return;const r=W(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(oe(o))continue;const a=n.concat([e-s]);const l=r.childNodes[e];this.attachNode(l,o,a,i)}}}detachChildren(e,t,n,i){if(!te(t))throw new Error("Every view node in an array must have an unique 'key' attribute");if(oe(t))return;const r=W(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(oe(o))continue;const a=n.concat([e-s]);const l=r.childNodes[e];this.detachNode(l,o,a,i)}}}updateChildren(e,t,n,i,r){if(t===n)return;if(!te(n))throw new Error("Every view node in an array must have an unique 'key' attribute");if("innerHtml"in n.attrs)e.innerHTML=n.attrs.innerHtml;else{if(n.tag==="svg"&&!r.isSvg())r=r.setSvg(true);const s=Math.max(t.children.length,n.children.length);let o=0;for(let a=0;a<s;a++){let s=t.children[a];let l=a in n.children?n.children[a]:null;if(r.isInProduction()){if(s!=null&&l!=null&&s.isDevOnly&&l.isDevOnly)continue;else if(s!=null&&s.isDevOnly)s=null;else if(l!=null&&l.isDevOnly)l=null}const c=e.childNodes[a-o];const h=i.concat([a]);if(s!=null){this.patch(c,s,l,h,r);if(l==null)o+=1}else{const t=this.createNode(l,h,r);const n=W(e)?e.content:e;const i=n.childNodes[a];n.insertBefore(t,i);o-=1}}}}addAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml")continue;const s=t.attrs[r];this.addAttribute(e,r,s,n,i)}}hydrateAttributes(e,t,n,i){if(!("style"in t.attrs))e.removeAttribute("style");for(const r in t.attrs){if(r==="innerHtml")continue;const s=t.attrs[r];this.hydrateAttribute(e,r,s,n,i)}}attachAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml")continue;const s=t.attrs[r];this.attachAttribute(e,r,s,n,i)}}detachAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml")continue;const s=t.attrs[r];this.detachAttribute(e,r,s,n,i)}}addAttribute(e,t,n,i,r){if(t==="style"){for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,i,R(t),n);else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t!=="focus"&&t in e&&!r.isSvg()&&n!=null)e[t]=n;else if(typeof n==="boolean"){if(t!=="focus")e.setAttribute(t,t)}else if(n!=null)e.setAttribute(t!=="htmlFor"?t:"for",n)}hydrateAttribute(e,t,n,i,r){if(t==="style"){e.removeAttribute("style");for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,i,R(t),n);else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}}attachAttribute(e,t,n,i,r){if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}}detachAttribute(e,t,n,i,r){if(n instanceof Function){const n=R(t);this.removeEventListener(e,i,n)}}updateAttributes(e,t,n,i,r){if(t===n)return;for(const s in n.attrs){if(s==="innerHtml")continue;const o=n.attrs[s];if(s in t.attrs){const n=t.attrs[s];this.updateAttribute(e,s,n,o,i,r)}else this.addAttribute(e,s,o,i,r)}for(const s in t.attrs){if(s==="innerHtml")continue;if(!(s in n.attrs))this.removeAttribute(e,s,t.attrs[s],i,r)}}updateAttribute(e,t,n,i,r,s){if(n===i)return;const o=i instanceof Function;const a=n instanceof Function;if(t==="style"){for(const t in n){if(!(t in i))this.removeStyleProp(e,t)}for(const t in i){const n=i[t]||"";this.setStyleProp(e,t,n)}}else if(o||a){if(o&&a){if(i!==n)this.updateEventListener(r,R(t),i)}else if(o){this.removeAttribute(e,t,n,r,s);this.addEventListener(e,r,R(t),i)}else if(a){this.removeEventListener(e,r,R(t));this.addAttribute(e,t,i,r,s)}}else if(t==="data"){const t=n!=null&&typeof n==="object";const r=i!=null&&typeof i==="object";if(t&&r){for(const t in n){if(!(t in i))delete e.dataset[t]}for(const t in i)e.dataset[t]=i[t]}else if(t&&!r){for(const t in e.dataset)delete e.dataset[t]}else if(!t&&r){for(const t in i)e.dataset[t]=i[t]}}else if(t!=="focus"&&t in e&&!s.isSvg())e[t]=i;else if(typeof n==="boolean"){if(t==="focus"){if(e.focus&&e.blur){if(i)e.focus();else e.blur()}}else{if(i)e.setAttribute(t,t);else e.removeAttribute(t)}}else{if(i!=null)e.setAttribute(t!=="htmlFor"?t:"for",i);else if(n!=null)e.removeAttribute(t!=="hmtlFor"?t:"for")}}removeAttribute(e,t,n,i,r){if(t==="style")e.removeAttribute("style");else if(n instanceof Function){const n=R(t);this.removeEventListener(e,i,n)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in e.dataset)delete e.dataset[t]}else if(t!=="focus"&&t in e&&!r.isSvg())e[t]=undefined;else if(typeof n==="boolean"){if(t==="focus"&&e.blur)e.blur();else e.removeAttribute(t)}else if(n!=null)e.removeAttribute(t!=="hmtlFor"?t:"for")}setStyleProp(e,t,n){if(t[0]==="-"){const i=n.indexOf("!important");let r=n;if(i!==-1)r=i!==n.slice(0,i)+n.slice(i+10);r=r.trim().replace(/;$/,"");e.style.setProperty(t,r)}else e.style[t]=n}removeStyleProp(e,t){if(t[0]==="-")e.style.removeProperty(t);else delete e.style[t]}addEventListener(e,t,n,i){const r=this.createEventListenerDelegate(i,t,n);if(e.addEventListener)e.addEventListener(n,r);else if(e.attachEvent)e.attachEvent(G(n),r);else{const t=e[n]&&e[n].listeners||[];if(e[n]!=null)e[n].listeners=t.concat([r]);else{const i=(...t)=>e[n].listeners.map(e=>e(...t));i.listeners=t.concat([r]);e[n]=i}}}updateEventListener(e,t,n){this.updateEventListenerDelegate(n,e,t)}removeEventListener(e,t,n){const i=this.getEventListenerDelegate(t,n);this.removeEventListenerDelegate(t,n);if(e.removeEventListener)e.removeEventListener(n,i);else if(e.detachEvent)e.detachEvent(G(n),i);else{if(e[n]!=null&&e[n].listeners!=null)e[n].listeners=e[n].listener.filter(e=>e!==i)}}getEventListenerDelegate(e,t){const n=le.getAttrKey(e,t);return this.eventListenerDelegates.get(n)}hasEventListenerDelegate(e,t){const n=le.getAttrKey(e,t);return this.eventListenerDelegates.has(n)}createEventListenerDelegate(e,t,n){const i=le.getAttrKey(t,n);this.eventListeners.set(i,e);const r=(...e)=>{const t=this.eventListeners.get(i);if(t==null)throw new Error("Event listener not found");t(...e)};this.eventListenerDelegates.set(i,r);return r}updateEventListenerDelegate(e,t,n){const i=le.getAttrKey(t,n);this.eventListeners.set(i,e)}removeEventListenerDelegate(e,t){const n=le.getAttrKey(e,t);this.eventListenerDelegates.delete(n);this.eventListeners.delete(n)}}class ce{constructor(e,t){const n=t.tag,i=t.attrs,r=t.children;this.template=n.template;this.state=i;this.actions=this.bindActions(n.actions);this.behavior=n.behavior;this.dispatcher=new $;this.innerFacade=new j(this);this.children=r;this.id=n.id;this.context=e;this.tree=new _;this.renderer=new le(this,e);this.node=null;this.destroyed=false;this.templateLock=false;this.updateLock=false;this.trackedActionUpdate=false;this.tmpElement=null;this.runBehavior()}get element(){return this.renderer.element||this.tmpElement}render(){if(this.destroyed)throw new Error("View is destroyed");this.tmpElement=null;this.node=this.renderTemplate();return this.renderer.render(this.node)}hydrate(e){if(this.destroyed)throw new Error("View is destroyed");if(this.element!=null)throw new Error("View is already hydrated");this.tmpElement=null;if(this.node==null)this.node=this.renderTemplate();const t=!this.context.isLocked();if(t)this.context.lock();this.renderer.hydrate(e,this.node);if(t){this.context.unlock();const e=this.context.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element])}else{const e=this.context.getCallbackQueue("mount");e.push(()=>this.dispatcher.notify("mount",[this.element]))}}attach(e){if(this.destroyed)throw new Error("View is destroyed");if(this.element!=null)throw new Error("View is already attached");this.tmpElement=null;if(this.node==null)this.node=this.renderTemplate();const t=!this.context.isLocked();if(t)this.context.lock();this.renderer.attach(e,this.node);if(t){this.context.unlock();const e=this.context.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element])}else{const e=this.context.getCallbackQueue("mount");e.push(()=>this.dispatcher.notify("mount",[this.element]))}}mount(e,t){if(this.destroyed)throw new Error("View is destroyed");this.tmpElement=null;const n=!this.context.isLocked();if(n)this.context.lock();if(this.node==null)this.node=this.renderTemplate();const i=this.renderer.render(this.node);this.renderer.attach(i,this.node);this.renderer.mount(e,t);if(n){this.context.unlock();const e=this.context.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element])}else{const e=this.context.getCallbackQueue("mount");window._queues=[...window._queues||[],e];e.push(()=>this.dispatcher.notify("mount",[this.element]))}}move(e,t){this.tmpElement=null;this.renderer.move(e,t)}update(e=null,t=null){let n=false;if(this.destroyed)throw new Error("View has been destroyed");const i=this.updateState(e);const r=this.updateChildrenState(t);n=this.state!==i||this.children!==r;this.state=i;this.children=r;if(this.element!==null&&n)this.refresh();if(this.element!==null&&n)this.dispatcher.notify("update",[this.state]);return n}unmount(){if(this.destroyed)throw new Error("View has been destroyed");if(this.element===null)throw new Error("View has been already unmounted");const e=!this.context.isLocked();if(e)this.context.lock();this.tmpElement=this.element;this.renderer.detach(this.node);if(e){this.context.unlock();const e=this.context.getCallbackQueue("unmount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("unmount");this.tmpElement=null}else{const e=this.context.getCallbackQueue("unmount");e.push(()=>{this.dispatcher.notify("unmount");this.tmpElement=null})}}destroy(e=true){if(this.destroyed)throw new Error("View has been destroyed");const t=this.element;if(t!==null)this.unmount();const n=!this.context.isLocked();if(n)this.context.lock();this.destroyInnerViews([],false);if(e&&t!=null)t.remove();this.node=null;this.destroyed=true;f(()=>this.tree.isEmpty(),"View tree is empty after destroy");if(n){this.context.unlock();const e=this.context.getCallbackQueue("destroy");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("destroy")}else{const e=this.context.getCallbackQueue("destroy");e.push(()=>this.dispatcher.notify("destroy"))}}getOrInstantiateInnerView(e,t,n){if(!this.tree.hasView(t))return this.instantiateInnerView(e,t,n);return this.tree.getView(t)}instantiateInnerView(e,t,n){f(()=>!this.tree.hasView(t),"View tree overwrite");const i=new ce(n,e);this.tree.addView(t,i);return i}getInstantiatedInnerView(e){return this.tree.getView(e)}destroyInnerViews(e,t=true){var n=true;var i=false;var r=undefined;try{for(var s=this.tree.iterateViews(e)[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;const n=e.view;n.destroy(t);e.delete()}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}}destroyInnerView(e,t=true){const n=this.tree.getView(e);this.tree.removeView(e);n.destroy(t)}runBehavior(){if(this.behavior instanceof Function)this.behavior(new q(this))}refresh(){const e=this.renderTemplate();const t=this.node;this.node=e;this.renderer.update(t,e)}renderTemplate(){this.templateLock=true;try{let e=this.template(this.innerFacade);if(Array.isArray(e)){if(e.length!==1)throw new Error("Only one root element must be rendered for a view");e=e[0]}e=e!=null?e:"";return e}finally{this.templateLock=false}}bindActions(t){const n={};var i=true;var r=false;var s=undefined;try{for(var o=e.keys(t)[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){const e=a.value;const i=t[e];if(i instanceof Function)n[e]=((...n)=>this.callAction(t[e],...n));else n[e]=this.bindActions(i)}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}return n}callAction(e,...t){var n=this;if(this.templateLock)throw new Error("Actions can't be called during template render");const i=!this.updateLock;this.updateLock=true;let r=e(...t);if(r instanceof Function)r=r(this.innerFacade);else if(r instanceof Promise){return S(function*(){n.finishAction(i);r=yield r;if(r instanceof Function)r=r(n.innerFacade);if(r instanceof Promise){n.finishAction(i);r=yield r;n.finishAction(i,r);return n.state}else{n.finishAction(i,r);return n.state}})()}if(r instanceof Promise){return S(function*(){n.finishAction(i);r=yield r;n.finishAction(i,r);return n.state})()}else{this.finishAction(i,r);return this.state}}finishAction(e,t=null){this.updateLock=false;if(e){if(!this.destroyed&&this.element!==null){let e=false;const n=this.update(t);if(!n&&this.trackedActionUpdate){this.trackedActionUpdate=false;this.refresh();e=true}else this.trackedActionUpdate=false;if(e)this.dispatcher.notify("update",[this.state])}else if(!this.destroyed)this.state=this.updateState(t)}else{const e=this.updateState(t);this.trackedActionUpdate=this.trackedActionUpdate||this.state!==e;this.state=e}}updateState(t=null){if(t==null||t===this.state)return this.state;const n=t!==null?I({},this.state,t):this.state;return!e.shallowEqual(this.state,n)?n:this.state}updateChildrenState(t=null){if(t===null||t===null)return this.children;const n=this.children==null||this.children.length===0;const i=t.length===0;if(n!==i)return t;else return!e.shallowEqual(this.children,t)?t:this.children}}const he=(e,t,n,{insideSvg:i,hydrate:r,isProduction:s})=>{let o=t;if(V(t))o=v(new N(t));const a=e.ownerDocument;let l=M.initialize(a,{production:s,svg:i});if(!l.isSvg()){const t=a.defaultView;if(e instanceof t.SVGElement)l=l.setSvg(true)}if(!D(o))throw new Error("View can only be instantiated from view-nodes");const c=new ce(l,o);const h=W(e)?e.content:e;if(r)c.hydrate(h.childNodes[n]);else c.mount(h,n);return new H(c)};const ue=(e,t,n=0,{insideSvg:r=false,env:o=(s?"production":"development")}={})=>he(e,t,n,{insideSvg:r,hydrate:false,isProduction:!i(o)});const de=(e,t,n=0,{insideSvg:r=false,env:o=(s?"production":"development")}={})=>he(e,t,n,{insideSvg:r,hydrate:true,isProduction:!i(o)});const fe=(e,t,{insideSvg:n=false,env:i=(s?"production":"development")}={})=>{let r=t;if(V(t))r=v(new N(t));const o=M.initialize(e,{production:s,svg:n});if(!D(r))throw new Error("View can only be instantiated from view-nodes");const a=new ce(o,r);return new H(a)};const me=(e,t,{insideSvg:n=false,env:i=(s?"production":"development")}={})=>{const r=fe(e,t,{insideSvg:n,env:i});r.render();return new H(r)};const ve=e=>{if(e==null)return(e,t)=>t;if(e instanceof Function)return e;else return t=>t[e]};const pe=e=>({data:e.data||[],accessor:ve(e.indexBy),render:e.render,mountPoint:null,initialized:false,views:{},index:[],prevData:[]});const we=new N(({state:{render:e}})=>e);const ye=e=>{let t=0;const n=[];var i=true;var r=false;var s=undefined;try{for(var o=e[Symbol.iterator](),a;!(i=(a=o.next()).done);i=true){const e=a.value;if(e.added){var l=true;var c=false;var h=undefined;try{for(var u=e.value[Symbol.iterator](),d;!(l=(d=u.next()).done);l=true){const e=d.value;n.push({added:true,value:e,index:t});t+=1}}catch(e){c=true;h=e}finally{try{if(!l&&u.return!=null){u.return()}}finally{if(c){throw h}}}}else if(e.removed){var f=true;var m=false;var v=undefined;try{for(var p=e.value[Symbol.iterator](),w;!(f=(w=p.next()).done);f=true){const e=w.value;n.push({removed:true,value:e,index:t})}}catch(e){m=true;v=e}finally{try{if(!f&&p.return!=null){p.return()}}finally{if(m){throw v}}}}else{var y=true;var g=false;var b=undefined;try{for(var x=e.value[Symbol.iterator](),E;!(y=(E=x.next()).done);y=true){const e=E.value;n.push({value:e,index:t});t+=1}}catch(e){g=true;b=e}finally{try{if(!y&&x.return!=null){x.return()}}finally{if(g){throw b}}}}}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}const N={};for(const e in n){const t=n[e];if(t.added)N[t.value]=e}for(let e=0;e<n.length;e++){const t=n[e];if(t.removed&&t.value in N){n.splice(e,1);e--}}return n};const ge=({state:e})=>{const t=P(e.mountPoint,2),n=t[0],i=t[1];n.childNodes[i].remove();e.initialized=true;e.index=[];e.views={};for(const t in e.data){const r=+t;const s=e.data[r];const o=e.accessor(s,r,e.data);e.index.push(o);const a=v(we,{render:e.render(s,r,e.data)});const l=ue(n,a,i+r);e.views[o]={view:l,index:i+r}}be(e.index);e.prevData=e.data};const be=e=>{const t={};var n=true;var i=false;var r=undefined;try{for(var s=e[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;if(e in t)throw new Error("Item keys must be unique");t[e]=true}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}return e};const xe=({state:e})=>{const n=P(e.mountPoint,2),i=n[0],r=n[1];const s=e.data.map(e.accessor);be(s);const o=t.diffArrays(e.index,s);const a=ye(o);const l={};for(const t in a){const n=a[t];const s=n.value;const o=+n.index;const c=s in e.views;if(n.added&&s!==e.index[o]){if(c){const t=n.index;const r=e.index[t];const o=e.views[s],a=o.index,c=o.view;const h=e.views[r].view;c.move(i,t);if(e.prevData[a]!==e.data[t])c.update({render:e.render(e.data[t],t,e.data)});h.move(i,a+1);if(e.prevData[t]!==e.data[a])h.update({render:e.render(e.data[a],t,e.data)});e.views[s]={view:c,index:t};e.views[r]={view:h,index:a};l[s]=true;l[r]=true}else{const t=e.data[o];const n=v(we,{render:e.render(t,o,e.data)});const a=ue(i,n,r+o);e.views[s]={view:a,index:r+o}}}else if(n.removed){const t=e.views[s].view;t.destroy();delete e.views[s]}else if(!(s in l)){const t=e.data[o];if(t!==e.prevData[o])e.views[s].view.update({render:e.render(t,o,e.data)})}}e.index=s;e.prevData=e.data};const Ee=e=>{if(e.state.mountPoint==null)return;if(e.state.initialized)xe(e);else ge(e)};const Ne=e=>{const t=e.state,n=e.element;t.mountPoint=[n.parentNode,Array.prototype.indexOf.call(n.parentNode.childNodes,n)];Ee(e)};const De=({state:e})=>{var t=Object.values(e.views);for(var n=0;n<t.length;n++){const e=t[n].view;e.destroy(false)}const i=P(e.mountPoint,2),r=i[0],s=i[1];for(let t=0;t<e.data.length;t++)r.childNodes[s].remove();e.mountPoint=null;e.initialized=false;e.views={};e.index=[];e.prevData=[]};const Ve=function(){var e=S(function*(e){e.state=I({},e.state,pe(e.state));e.onMount(Ne);e.onUpdate(Ee);e.onDestroy(De)});return function t(n){return e.apply(this,arguments)}}();const Ae=new N(null,Ve);const Te=new N(({state:e,children:t})=>{if(t.length!==0){if(t.length!==1||!(t[0]instanceof Function))throw new Error("You must provide a render function as the only children to the List");const n=t[0];return v(Ae,I({},e,{render:n}))}else return null});const ke=new N(({state:t,children:n})=>{if(n.length!==1||!(n[0]instanceof Function))throw new Error("You must provide a render function as the only children to the Map");const i=n[0];const r=([e,t],n,r)=>i(t,e,r,n);const s=e.keys(t.data||{}).map(e=>[e,t.data[e]]);const o=([e])=>e;return v(Ae,{data:s,indexBy:o,render:r})});const Fe=(e,t,n=null)=>e?t:n;const Se=new N(({state:{when:e=false},children:t})=>Fe(e,t,null));const Le=new N(({state:{when:e=true},children:t})=>Fe(e,null,t));const Ie=e=>e===null||m.isNode(e)||typeof e!=="object"&&Object.getPrototypeOf(e)===Function.prototype;var Pe=e=>t=>{let n;if(N.isViewDeclaration(t))n=t;else if(typeof t==="string")n=new N(({state:e,children:n})=>v(t,e,n));else if(Ie(t))n=new N(t);else throw new Error("Nothing to decorate");let i=e(n);if(!N.isViewDeclaration(i)){if(Ie(i))i=new N(i);else return i}if(n.originalId!=null)i.originalId=n.originalId;else i.originalId=n.id;return i};const Oe=t=>{const n=t!=null?t:u;return(t,i=null)=>{const r=i!=null?I({},i):null;if(r!=null&&"state"in r)r.state=I({},e.omit(["logger"],r.state));let s=r!=null?[t,r]:[t];n(...s)}};const Ue=e=>{const t={parent:e.element.parentNode,index:Array.prototype.indexOf.call(e.element.parentNode.childNodes,e.element)};if(e.children!=null&&e.children.length>0)t.element=e.element;return t};const Ce=(t,n)=>{let i=null;const r={};var s=true;var o=false;var a=undefined;try{for(var l=e.keys(t.prev)[Symbol.iterator](),c;!(s=(c=l.next()).done);s=true){const e=c.value;r[e]=true}}catch(e){o=true;a=e}finally{try{if(!s&&l.return!=null){l.return()}}finally{if(o){throw a}}}var h=true;var u=false;var d=undefined;try{for(var f=e.keys(n.state)[Symbol.iterator](),m;!(h=(m=f.next()).done);h=true){const e=m.value;r[e]=true}}catch(e){u=true;d=e}finally{try{if(!h&&f.return!=null){f.return()}}finally{if(u){throw d}}}for(const e in r){const r=t.prev[e];const s=n.state[e];if(r!==s){if(i===null)i={};i[e]=s}}return i};const $e=e=>t=>{const n="DEBUG: created "+(t.state.info?`"${t.state.info}"`:"");const i={state:t.state};e(n,i)};const je=(e,t)=>n=>{const i="DEBUG: mounted "+(n.state.info?`"${n.state.info}"`:"");const r={state:n.state,element:Ue(n)};t.prev=n.state;e(i,r)};const qe=(e,t)=>n=>{const i="DEBUG: updated "+(n.state.info?`"${n.state.info}"`:"");const r={state:n.state,element:Ue(n)};const s=Ce(t,n);if(s!=null)r.update=s;t.prev=n.state;e(i,r)};const He=e=>t=>{const n="DEBUG: unmounted "+(t.state.info?`"${t.state.info}"`:"");const i={state:t.state,element:Ue(t)};e(n,i)};const Me=e=>t=>{const n="DEBUG: destroyed "+(t.state.info?`"${t.state.info}"`:"");e(n)};const We=e=>t=>{const n={prev:{}};$e(e)(t);t.onMount(je(e,n));t.onUpdate(qe(e,n));t.onUnmount(He(e));t.onDestroy(Me(e))};const ze=new Map;const Be=1e4;const Ke=(e=null)=>{if(ze.has(e))return ze.get(e);else{const t=new N(null,We(Oe(e)));if(ze.size<Be)ze.set(e,t);return t}};var Qe=new N(({state:t,children:n})=>v(Ke(t.logger),e.omit(["logger"],t),n)).setDevelopmentOnly(true);const _e=(...t)=>{if(t.length>1)return e.compose(...t)(k);else if(t.length===1){const e=t[0];if(e instanceof Function)return e(k);else return new N(e)}else return k};const Ge=e=>new N(e);exports.view=_e;exports.template=Ge;exports.h=v;exports.isElementNode=V;exports.isViewNode=D;exports.isTextNode=A;exports.Node=m;exports.Declaration=N;exports.instantiate=fe;exports.render=me;exports.hydrate=de;exports.mount=ue;exports.isDevelopment=r;exports.isProduction=s;exports.getGlobal=d;exports.warn=h;exports.Debug=Qe;exports.Id=T;exports.None=k;exports.Show=Se;exports.Hide=Le;exports.List=Te;exports.Map=ke;exports.branch=Fe;exports.decorator=Pe;
