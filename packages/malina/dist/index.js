"use strict";Object.defineProperty(exports,"__esModule",{value:true});var e=require("malina-util");var t=require("diff");let n="production";try{n=process.env.NODE_ENV}catch(e){}const i=e=>e==="development"||e==="testing";const r=n==="development"||n==="testing";const s=!r;const o=typeof self==="object"&&self.self===self&&self||typeof global==="object"&&global.global===global&&global||this;const l="console"in o;const a=l&&"warn"in o.console;const c=l&&"log"in o.console;const h=e=>{if(r&&a)o.console.warn(e)};const u=(...e)=>{if(r&&c)o.console.log(...e)};const d=()=>o;const f=(e,t=null)=>{if(r&&a){if(!e())throw new Error(`Condition failed${t!=null?`: ${t}`:""}`)}};const m=(t,n)=>{const i=d();const r=Symbol.for(`__malina.env.id.${t}`);const s=`malina.seed.id.${t}`;let o;if(i!=null&&r in i)o=i[r];else{o={generator:new e.Random(s),counter:0};i[r]=o}return`${o.generator.id(n)}${++o.counter}`};class v{constructor(t,n={},i=[]){if(t==null)throw new Error("Node tag cannot be empty");this.tag=t;this.attrs=n||{};this.children=e.flatten(i);this.isDevOnly=typeof t==="object"&&t.isDevOnly}static isNode(e){return typeof e==="object"&&e!==null&&e.isNode instanceof Function&&e.isNode()}static isEqualNodes(e,t,n=true){const i=v.isNode(e);if(i!==v.isNode(t))return false;if(i)return e.isEqual(t);else return e===t}isNode(){return true}isDevOnly(){return this.isDevOnly}isEqual(t,n=true){if(this===t)return true;if(this.tag!==t.tag)return false;if(this.isDevOnly!==t.isDevOnly)return false;if(!e.shallowEqual(this.attrs,t.attrs))return false;if(n){if(this.children===t.children)return true;const e=this.children.length;if(e!==t.children.length)return false;for(let n=0;n<e;n++){if(!v.isEqualNodes(this.children[n],t.children[n]))return false}}return true}toString(){const e=Object.keys(this.attrs).reduce((e,t)=>{const n=this.attrs[t];if(typeof n==="string")return`${e} ${t}="${n}"`;else if(n instanceof Function)return`${e} ${t}=[Function]`;else return`${e} ${t}={${typeof n!=="object"?JSON.stringify(n):"{...}"}}`},"");const t=typeof this.tag==="string"?this.tag:"[View]";if(this.children.length>0){return`<${t}${e}>\n${this.children.map(e=>{if(e==null)return'\t""';const t=e.toString();return t.split("\n").map(e=>`\t${e}`).join("\n")}).join("\n")}\n</${t}>`}else return`<${t}${e}/>`}}const p=(e,t,...n)=>{const i=n.length===1&&Array.isArray(n[0])?n[0]:n;return new v(e,t,i)};const w=4;const y=(e,t,n)=>{if(n.length>=w)return t;const i=v.isNode(e);if(i!==v.isNode(t))return t;if(!i)return t;const r=N(e);const s=N(t);if(r&&s){if(e.isEqual(t))return e}else if(r===s){const i=e.children.length;if(e.isEqual(t,false)&&i===t.children.length){for(let r=0;r<i;r++){const i=n.concat([r]);const s=e.children[r];const o=t.children[r];const l=y(s,o,i);if(l!==s)return t}return e}}return t};const g=e=>{let t=null;return(...n)=>{const i=e(...n);if(t===i)return i;const r=v.isNode(t);const s=v.isNode(i);if(r&&s){const e=y(t,i,[]);t=e;return e}else if(s){t=i;return i}else{t=null;return i}}};const x=e=>{if(e instanceof Function)return g(e);else return x(()=>e)};class b{constructor(e,t,n){this.template=x(e);this.behavior=t||(()=>{});this.actions=n||{};this.id=m("declaration",8);this.originalId=null;this.isDevOnly=false;this.decorators={}}static isViewDeclaration(e){return typeof e==="object"&&e!==null&&e.isViewDeclaration instanceof Function&&e.isViewDeclaration()}isViewDeclaration(){return true}setDevelopmentOnly(e){this.isDevOnly=e;return this}is(e){return this===e||this.id===e.id||this.originalId===e.originalId}}const N=e=>v.isNode(e)&&b.isViewDeclaration(e.tag);const E=e=>v.isNode(e)&&!b.isViewDeclaration(e.tag);const D=e=>!(e instanceof Object)&&typeof e!=="object";var V=new b(({children:e})=>e);var A=new b(null);function T(e,t,n,i,r,s,o){try{var l=e[s](o);var a=l.value}catch(e){n(e);return}if(l.done){t(a)}else{Promise.resolve(a).then(i,r)}}function F(e){return function(){var t=this,n=arguments;return new Promise(function(i,r){var s=e.apply(t,n);function o(e){T(s,i,r,o,l,"next",e)}function l(e){T(s,i,r,o,l,"throw",e)}o(undefined)})}}function k(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function S(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);if(t)i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable});n.push.apply(n,i)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};if(t%2){S(n,true).forEach(function(t){k(e,t,n[t])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(e,Object.getOwnPropertyDescriptors(n))}else{S(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}}return e}function O(e,t){return L(e)||P(e,t)||U()}function L(e){if(Array.isArray(e))return e}function P(e,t){var n=[];var i=true;var r=false;var s=undefined;try{for(var o=e[Symbol.iterator](),l;!(i=(l=o.next()).done);i=true){n.push(l.value);if(t&&n.length===t)break}}catch(e){r=true;s=e}finally{try{if(!i&&o["return"]!=null)o["return"]()}finally{if(r)throw s}}return n}function U(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}class ${constructor(){this.resolvers={};this.listeners={}}notify(e,t=[]){if(e in this.listeners){const l=this.listeners[e];var n=true;var i=false;var r=undefined;try{for(var s=l[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;e(...t)}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}}if(e in this.resolvers){const n=this.resolvers[e];delete this.resolvers[e];var l=true;var a=false;var c=undefined;try{for(var h=n[Symbol.iterator](),u;!(l=(u=h.next()).done);l=true){const e=O(u.value,2),n=e[0],i=e[1];const r=i&&t.length===1?t[0]:t;n(r)}}catch(e){a=true;c=e}finally{try{if(!l&&h.return!=null){h.return()}}finally{if(a){throw c}}}}}wait(e,t=true){return new Promise(n=>{if(!(e in this.resolvers))this.resolvers[e]=[[n,t]];else this.resolvers[e].push([n,t])})}waitFor(e,t){return new Promise(n=>{const i=(...e)=>{if(t(...e))n(...e)};if(!(e in this.resolvers))this.resolvers[e]=[[i]];else this.resolvers[e].push([i])})}on(e,t){if(!(e in this.listeners))this.listeners[e]=[t];else this.listeners[e].push(t);return()=>this.off(e,t)}off(e,t){if(e in this.listeners)this.listeners.splice(this.listeners.indexOf(t),1)}}class C{constructor(e){this.view=e}get state(){return this.view.state}get actions(){return this.view.actions}get children(){return this.view.children||[]}}class j extends C{get state(){return this.view.state}set state(e){this.view.state=e}get isMounted(){return this.view.mounted}get isDestroyed(){return this.view.destroyed}get element(){return this.view.element}}class K extends j{update(e){if(!this.isDestroyed)return this.view.update(e);else return this.state}mount(){return this.view.dispatcher.wait("mount",true)}onMount(e){return this.view.dispatcher.on("mount",()=>e(this))}nextUpdate(){return this.view.dispatcher.wait("update",true)}onUpdate(e){return this.view.dispatcher.on("update",()=>e(this))}unmount(){return this.view.dispatcher.wait("unmount",true)}onUnmount(e){return this.view.dispatcher.on("unmount",()=>e(this))}onDestroy(e){return this.view.dispatcher.on("destroy",()=>e(this))}waitFor(e,t){var n=this;return F(function*(){if(e(n.state))return true;while(yield n.updating()){if(e(n.state))return true}if(e(n.state))return true;return false})()}updating(){var e=this;return F(function*(){return Promise.race([e.nextUpdate().then(()=>true),e.unmount().then(()=>false)])})()}setTimeout(e,t){const n=setTimeout(e,t);this.onDestroy(()=>clearTimeout(n))}setInterval(e,t){const n=setInterval(e,t);this.onDestroy(()=>clearInterval(n))}}class H extends j{render(){return this.view.render()}attach(e=null){this.view.attach(e)}update(e=null,t=null){if(!this.isDestroyed)return this.view.update(e,t);else return this.state}move(e,t){return this.view.move(e,t)}unmount(){this.view.unmount()}destroy(e=true){this.view.destroy(e)}onMount(e){return this.view.dispatcher.on("mount",()=>e(this))}onUpdate(e){return this.view.dispatcher.on("update",()=>e(this))}onUnmount(e){return this.view.dispatcher.on("unmount",()=>e(this))}onDestroy(e){return this.view.dispatcher.on("destroy",()=>e(this))}}class M{constructor(e,t,n){this.document=e;this.store=t;this.globalStore=n}static initialize(e,t){return new M(e,t,{})}isLocked(){return this.getOrCreate("lock",false,true)}lock(){return this.update("lock",true,true)}unlock(){return this.update("lock",false,true)}getCallbackQueue(e){return this.getOrCreate(`callback-queue.${e}`,[],true)}setSvg(e){return this.copyWith({svg:e})}isSvg(){return this.getOrCreate("svg",false)}setInProduction(e){return this.update("production",e)}isInProduction(){return this.getOrCreate("production",true)}isUpdating(){return this.getOrCreate("updating",false)}setUpdating(e){const t={};for(const e in this.store){if(Object.prototype.hasOwnProperty.call(this.store,e))t[e]=this.store[e]}t["updating"]=e;return new M(this.document,t,this.globalStore)}getDocument(){return this.document}update(e,t,n=false){const i=n?this.globalStore:this.store;i[e]=t;return this}copy(e){return new M(this.document,I({},this.store,{},e),this.globalStore)}getOrCreate(e,t,n=false){const i=n?this.globalStore:this.store;if(e in i)return i[e];else{i[e]=t;return i[e]}}}const W=e=>e instanceof e.ownerDocument.defaultView.HTMLTemplateElement;const q=(e,t)=>{for(let n=0;n<Math.min(e.length,t.length);n++){const i=e[n]-t[n];if(i!==0)return i}return e.length-t.length};const z=(e,t=1)=>e.length?e.slice(0,-1).concat([e[e.length-1]+t]):e;const B=e=>e.length===0;class Q{constructor(e){this.view=e;this.deleted=false}delete(){this.deleted=true}}class G{constructor(){this.views={};this.index=[]}hasView(e){return G.getPathKey(e)in this.views}getView(e){const t=G.getPathKey(e);return t in this.views?this.views[t].view:null}*iterateViews(e=[],t=false){let n=0;if(!B(e)){const t=this.searchPath(e);n=t>=0?t:-t-1}let i=null;if(!B(e)){const t=this.searchPath(z(e));i=t>=0?t+1:-t-1}i=i!=null?Math.min(i,this.index.length):this.index.length;if(!t){for(let e=n;e<i;e++){const t=this.index[e],n=t.view,r=t.key;const s=new Q(n);yield s;if(s.deleted){this.index.splice(e,1);e-=1;i-=1;delete this.views[r]}}}else{for(let e=Math.max(i-1,0);e>=n;e--){const t=this.index[e],n=t.view,i=t.key;const r=new Q(n);yield r;if(r.deleted){this.index.splice(e,1);delete this.views[i]}}}}addView(e,t){const n=this.searchPath(e);const i=n>=0?n:-n-1;const r=G.getPathKey(e);const s={view:t,path:e,key:r};this.views[r]=s;this.index.splice(i,0,s)}removeView(e){const t=G.getPathKey(e);if(!(t in this.views))return null;const n=this.searchPath(e);const i=this.views[t].view;this.index.splice(n,1);delete this.views[t];return i}isEmpty(){return this.index.length===0}static getPathKey(e){return e.join(".")}searchPath(t){return e.binarySearch(t,this.index,(e,t)=>{const n="path"in e?e.path:e;const i="path"in t?t.path:t;return q(n,i)})}}const _=e=>`on${e[0].toUpperCase()}${e.substr(1)}`;const R=e=>{const t=e.toLowerCase();return t.startsWith("on")?t.substr(2):t};const Y=e=>e.length===0;const J=(e,t)=>e.tag.id===t.tag.id;const X=(e,t)=>{const n=e.children;if(e.attrs.ignoreKeys||t.noWarnKeys)return;if(!n.every((e,t)=>t===0||!N(e)||!N(n[t-1])||e.attrs.key||!J(e,n[t-1])))throw new Error("Every view node in an array must have a 'key' attribute")};const Z=(e,t)=>{const n=e.children;if(e.attrs.ignoreKeys||t.noWarnKeys)return;let i={};var r=true;var s=false;var o=undefined;try{for(var l=n[Symbol.iterator](),a;!(r=(a=l.next()).done);r=true){const e=a.value;if(N(e)&&e.attrs.key){if(!(e.tag.id in i))i[e.tag.id]={};if(e.attrs.key in i[e.tag.id])throw new Error("Every view node in an array must have an unique 'key' attribute");i[e.tag.id][e.attrs.key]=true}}}catch(e){s=true;o=e}finally{try{if(!r&&l.return!=null){l.return()}}finally{if(s){throw o}}}};const ee=e=>{const t=e.attrs,n=e.children;if("innerHtml"in t&&t.innerHtml!=null&&n!=null&&n.length>0)throw new Error('Nodes with "innerHtml" attribute must not have children')};const te=(e,t={})=>{X(e,t);Z(e,t);ee(e);return e};const ne=(e,t,n)=>{const i=W(e)?e.content:e;const r=i.childNodes[t];i.insertBefore(n,r)};const ie=(e,t)=>{const n=W(e)?e.content:e;n.removeChild(t)};const re=/^[a-z][a-z0-9.-_]*-[a-z0-9.-_]*$/;const se=["annotation-xml","color-profile","font-face","font-face-src","font-face-uri","font-face-format","font-face-name","missing-glyph"];const oe=e=>E(e)&&!se.includes(e.tag)&&(re.test(e.tag)||"is"in e.attrs&&re.test(e.attrs.is));const le=(e,t)=>t instanceof e.getDocument().defaultView.Element||t instanceof e.getDocument().defaultView.Text;class ae{constructor(e,t){this.view=e;this.context=t;this.element=null;this.eventListeners=new Map;this.eventListenerDelegates=new Map}render(e){return this.createNode(e,[],this.context)}hydrate(e,t){if(this.element!==null)throw new Error("Already attached");this.hydrateNode(e,t,[],this.context);this.attach(e)}attach(e,t){if(this.element!==null)throw new Error("Already attached");this.element=e;this.attachNode(e,t,[],this.context)}mount(e,t){ne(e,t,this.element)}move(e,t){ne(e,t,this.element)}update(e,t){this.context=this.context.setUpdating(true);this.patch(this.element,e,t,[],this.context);this.context.setUpdating(false)}detach(e){if(this.element===null)throw new Error("Already detached");this.detachNode(this.element,e,[],this.context);f(()=>this.eventListeners.size===0,"Event listeners map is empty after detach");f(()=>this.eventListenerDelegates.size===0,"Event listener delegates map is empty after detach");this.element=null}static getAttrKey(e,t){return`${t}.${e.join(".")}`}patch(e,t,n,i,r){if(t===n)return;if(E(t)){if(n==null)this.patchFromNodeToNone(e,t,i,r);else if(E(n))this.patchFromNodeToNode(e,t,n,i,r);else if(N(n))this.patchFromNodeToView(e,t,n,i,r);else if(D(n))this.patchFromNodeToText(e,t,n,i);else if(le(r,n))this.patchFromElementNodeToDom(e,n,i);else throw new Error("Invalid template type")}else if(N(t)){if(n==null)this.patchFromViewToNone(e,t,i);else if(E(n))this.patchFromViewToNode(e,t,n,i,r);else if(N(n))this.patchFromViewToView(e,t,n,i,r);else if(D(n))this.patchFromViewToText(e,t,n,i);else if(le(r,n))this.patchFromViewToDom(e,n,i);else throw new Error("Invalid template type")}else if(le(r,t)){if(n==null)this.patchFromDomToNone(e,i);else if(E(n))this.patchFromDomToNode(e,n,i,r);else if(N(n))this.patchFromDomToView(e,n,i,r);else if(D(n))this.patchFromDomToText(e,n,i);else if(le(r,n))this.patchFromDomToDom(e,n,i);else throw new Error("Invalid template type")}else{if(n==null)this.patchFromTextToNone(e,i);else if(E(n))this.patchFromTextToNode(e,n,i,r);else if(N(n))this.patchFromTextToView(e,n,i,r);else if(D(n))this.patchTextNodes(e,t,n,i);else if(le(r,n))this.patchFromTextToDom(e,n,i);else throw new Error("Invalid template type")}}patchFromElementNodeToDom(e,t,n){if(e!==t){this.view.destroyInnerViews(n,false);e.replaceWith(t);if(Y(n))this.element=t}}patchFromViewToDom(e,t,n){this.view.destroyInnerView(n,false);e.replaceWith(t);if(Y(n))this.element=t}patchFromDomToNone(e,t){if(Y(t))throw new Error("Root element deleted during patch");ie(e.parentNode,e)}patchFromDomToNode(e,t,n,i){const r=this.createElementNode(t,n,i);e.replaceWith(r);if(Y(n))this.element=r}patchFromDomToView(e,t,n,i){const r=this.view.instantiateInnerView(t,n,i.setUpdating(false));let s;if(n.length>0)s=n[n.length-1];else s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();if(i.isUpdating()){const e=r.render();ne(o,s,e);r.attach(e)}else throw new Error("Unreachable");if(Y(n))this.element=r.element}patchFromDomToText(e,t,n){const i=this.context.getDocument().createTextNode(`${t}`);e.replaceWith(i);if(Y(n))this.element=i}patchFromDomToDom(e,t,n){if(e!==t){e.replaceWith(t);if(Y(n))this.element=t}}patchFromTextToDom(e,t,n){e.replaceWith(t);if(Y(n))this.element=t}patchFromTextToNone(e,t){if(Y(t))throw new Error("Root element deleted during patch");ie(e.parentNode,e)}patchTextNodes(e,t,n,i){if(t!==n){const t=this.createTextNode(n);e.replaceWith(t);if(Y(i))this.element=t}}patchFromTextToNode(e,t,n,i){const r=this.createElementNode(t,n,i);e.replaceWith(r);if(Y(n))this.element=r}patchFromTextToView(e,t,n,i){const r=this.view.instantiateInnerView(t,n,i.setUpdating(false));let s;if(n.length>0)s=n[n.length-1];else s=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const o=e.parentNode;e.remove();if(i.isUpdating()){const e=r.render();ne(o,s,e);r.attach(e)}else throw new Error("Unreachable");if(Y(n))this.element=r.element}patchFromNodeToNone(e,t,n,i){if(Y(n))throw new Error("Root element deleted during patch");this.detachElementNode(e,t,n,i);this.view.destroyInnerViews(n,false);e.remove()}patchFromNodeToText(e,t,n,i){this.view.destroyInnerViews(i,false);const r=this.context.getDocument().createTextNode(`${n}`);e.replaceWith(r);if(Y(i))this.element=r}patchFromNodeToNode(e,t,n,i,r){if(t===n)return;const s=oe(t);const o=oe(n);if(t.tag===n.tag){if(s&&o){this.updateAttributes(e,t,n,i,r);e.innerHTML="";this.createChildren(e,n,i,r)}else if(s||o){this.view.destroyInnerViews(i,false);const t=this.createElementNode(n,i,r);e.replaceWith(t);if(Y(i))this.element=t}else{this.updateAttributes(e,t,n,i,r);this.updateChildren(e,t,n,i,r)}}else{this.view.destroyInnerViews(i,false);const t=this.createElementNode(n,i,r);e.replaceWith(t);if(Y(i))this.element=t}}patchFromNodeToView(e,t,n,i,r){this.view.destroyInnerViews(i,false);const s=this.view.instantiateInnerView(n,i,r.setUpdating(false));let o;if(i.length>0)o=i[i.length-1];else o=Array.from(e.parentNode.childNodes).findIndex(t=>t===e);const l=e.parentNode;e.remove();if(r.isUpdating()){const e=s.render();ne(l,o,e);s.attach(e)}else throw new Error("Unreachable");if(Y(i))this.element=s.element}patchFromViewToNone(e,t,n){if(Y(n))throw new Error("Root element deleted during patch");this.view.destroyInnerView(n)}patchFromViewToText(e,t,n,i){this.view.destroyInnerView(i,false);const r=this.context.getDocument().createTextNode(`${n}`);e.replaceWith(r);if(Y(i))this.element=r}patchFromViewToNode(e,t,n,i,r){this.view.destroyInnerView(i,false);const s=this.createElementNode(n,i,r);e.replaceWith(s);if(Y(i))this.element=s}patchFromViewToView(e,t,n,i,r){if(t===n)return;if(J(t,n)&&t.attrs.key===n.attrs.key){const e=this.view.getInstantiatedInnerView(i);e.update(n.attrs,n.children)}else{const t=e.parentNode;let s;if(i.length>0)s=i[i.length-1];else s=Array.from(t.childNodes).findIndex(t=>t===e);this.view.destroyInnerView(i);const o=this.view.instantiateInnerView(n,i,r.setUpdating(false));e.remove();if(r.isUpdating()){const e=o.render();ne(t,s,e);o.attach(e)}else throw new Error("Unreachable");if(Y(i))this.element=o.element}}createNode(e,t,n){if(E(e))return this.createElementNode(e,t,n);else if(N(e))return this.createViewNode(e,t,n);else if(le(n,e))return e;else if(e===null||D(e))return this.createTextNode(e)}hydrateNode(e,t,n,i){if(E(t))return this.hydrateElementNode(e,t,n,i);else if(N(t))return this.hydrateViewNode(e,t,n,i)}attachNode(e,t,n,i){if(E(t))return this.attachElementNode(e,t,n,i);else if(N(t))return this.attachViewNode(e,n)}detachNode(e,t,n,i){if(E(t))return this.detachElementNode(e,t,n,i);else if(N(t))return this.detachViewNode(e,n)}createElementNode(e,t,n){let i=n.isSvg();let r;if(!i&&e.tag==="svg"){n=n.setSvg(true);i=true}if(i)r=n.getDocument().createElementNS("http://www.w3.org/2000/svg",e.tag);else r=n.getDocument().createElement(e.tag);this.addAttributes(r,e,t,n);this.createChildren(r,e,t,n);return r}hydrateElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.hydrateAttributes(e,t,n,i);this.hydrateChildren(e,t,n,i)}attachElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.attachAttributes(e,t,n,i);this.attachChildren(e,t,n,i)}detachElementNode(e,t,n,i){let r=i.isSvg();if(!r&&t.tag==="svg"){i=i.setSvg(true);r=true}this.detachAttributes(e,t,n,i);this.detachChildren(e,t,n,i)}createViewNode(e,t,n){const i=this.view.instantiateInnerView(e,t,n.setUpdating(false));let r;if(n.isUpdating()){r=i.render(this.document);i.attach(r)}else r=i.render(this.document);return r}hydrateViewNode(e,t,n,i){const r=this.view.getOrInstantiateInnerView(t,n,i);return r.hydrate(e)}attachViewNode(e,t){const n=this.view.getInstantiatedInnerView(t);return n.attach(e)}detachViewNode(e,t){const n=this.view.getInstantiatedInnerView(t);n.unmount()}createTextNode(e){return this.context.getDocument().createTextNode(`${e!=null?e:""}`)}createChildren(e,t,n,i){te(t);if("innerHtml"in t.attrs)e.innerHTML=t.attrs.innerHtml;else{const r=i.getDocument().createDocumentFragment();let s=0;for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}const l=n.concat([e-s]);const a=this.createNode(o,l,i);r.appendChild(a)}if(t.children.length>0){const t=W(e)?e.content:e;t.appendChild(r)}}}hydrateChildren(e,t,n,i){te(t,{noWarnKeys:true});if(oe(t))return;const r=W(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(oe(o))continue;const l=n.concat([e-s]);const a=r.childNodes[e];this.hydrateNode(a,o,l,i)}}}attachChildren(e,t,n,i){te(t,{noWarnKeys:true});if(oe(t))return;const r=W(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(oe(o))continue;const l=n.concat([e-s]);const a=r.childNodes[e];this.attachNode(a,o,l,i)}}}detachChildren(e,t,n,i){if(oe(t))return;const r=W(e)?e.content:e;let s=0;if(!("innerHtml"in t.attrs)){for(const e in t.children){const o=t.children[e];if(o===null||i.isInProduction()&&o.isDevOnly){s+=1;continue}if(oe(o))continue;const l=n.concat([e-s]);const a=r.childNodes[e];this.detachNode(a,o,l,i)}}}updateChildren(e,t,n,i,r){if(t===n)return;te(n);if("innerHtml"in n.attrs)e.innerHTML=n.attrs.innerHtml;else{if(n.tag==="svg"&&!r.isSvg())r=r.setSvg(true);const s=Math.max(t.children.length,n.children.length);let o=0;for(let l=0;l<s;l++){let s=t.children[l];let a=l in n.children?n.children[l]:null;if(r.isInProduction()){if(s!=null&&a!=null&&s.isDevOnly&&a.isDevOnly)continue;else if(s!=null&&s.isDevOnly)s=null;else if(a!=null&&a.isDevOnly)a=null}const c=i.concat([l]);if(s!=null){const t=e.childNodes[l-o];this.patch(t,s,a,c,r);if(a==null)o+=1}else{if(a!=null){const t=this.createNode(a,c,r);const n=W(e)?e.content:e;const i=n.childNodes[l];n.insertBefore(t,i)}else o+=1}}}}addAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.addAttribute(e,r,s,n,i)}}hydrateAttributes(e,t,n,i){if(!("style"in t.attrs))e.removeAttribute("style");for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.hydrateAttribute(e,r,s,n,i)}}attachAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.attachAttribute(e,r,s,n,i)}}detachAttributes(e,t,n,i){for(const r in t.attrs){if(r==="innerHtml"||r==="ignoreKeys")continue;const s=t.attrs[r];this.detachAttribute(e,r,s,n,i)}}addAttribute(e,t,n,i,r){if(t==="style"){for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,i,R(t),n);else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t!=="focus"&&t in e&&!r.isSvg()&&n!=null)e[t]=n;else if(typeof n==="boolean"){if(t!=="focus")e.setAttribute(t,t)}else if(n!=null)e.setAttribute(t!=="htmlFor"?t:"for",n)}hydrateAttribute(e,t,n,i,r){if(t==="style"){e.removeAttribute("style");for(const t in n)this.setStyleProp(e,t,n[t]||"")}else if(n instanceof Function)this.addEventListener(e,i,R(t),n);else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in n)e.dataset[t]=n[t]}else if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}}attachAttribute(e,t,n,i,r){if(t==="focus"&&e.focus&&e.blur){if(n)e.focus();else e.blur()}}detachAttribute(e,t,n,i,r){if(n instanceof Function){const n=R(t);this.removeEventListener(e,i,n)}}updateAttributes(e,t,n,i,r){if(t===n)return;for(const s in n.attrs){if(s==="innerHtml"||s==="ignoreKeys")continue;const o=n.attrs[s];if(s in t.attrs){const n=t.attrs[s];this.updateAttribute(e,s,n,o,i,r)}else this.addAttribute(e,s,o,i,r)}for(const s in t.attrs){if(s==="innerHtml"||s==="ignoreKeys")continue;if(!(s in n.attrs))this.removeAttribute(e,s,t.attrs[s],i,r)}}updateAttribute(e,t,n,i,r,s){if(n===i)return;const o=i instanceof Function;const l=n instanceof Function;if(t==="style"){for(const t in n){if(!(t in i))this.removeStyleProp(e,t)}for(const t in i){const n=i[t]||"";this.setStyleProp(e,t,n)}}else if(o||l){if(o&&l){if(i!==n)this.updateEventListener(r,R(t),i)}else if(o){this.removeAttribute(e,t,n,r,s);this.addEventListener(e,r,R(t),i)}else if(l){this.removeEventListener(e,r,R(t));this.addAttribute(e,t,i,r,s)}}else if(t==="data"){const t=n!=null&&typeof n==="object";const r=i!=null&&typeof i==="object";if(t&&r){for(const t in n){if(!(t in i))delete e.dataset[t]}for(const t in i)e.dataset[t]=i[t]}else if(t&&!r){for(const t in e.dataset)delete e.dataset[t]}else if(!t&&r){for(const t in i)e.dataset[t]=i[t]}}else if(t!=="focus"&&t in e&&!s.isSvg())e[t]=i;else if(typeof n==="boolean"){if(t==="focus"){if(e.focus&&e.blur){if(i)e.focus();else e.blur()}}else{if(i)e.setAttribute(t,t);else e.removeAttribute(t)}}else{if(i!=null)e.setAttribute(t!=="htmlFor"?t:"for",i);else if(n!=null)e.removeAttribute(t!=="hmtlFor"?t:"for")}}removeAttribute(e,t,n,i,r){if(t==="style")e.removeAttribute("style");else if(n instanceof Function){const n=R(t);this.removeEventListener(e,i,n)}else if(t==="data"&&n!=null&&typeof n==="object"){for(const t in e.dataset)delete e.dataset[t]}else if(t!=="focus"&&t in e&&!r.isSvg())e[t]=undefined;else if(typeof n==="boolean"){if(t==="focus"&&e.blur)e.blur();else e.removeAttribute(t)}else if(n!=null)e.removeAttribute(t!=="hmtlFor"?t:"for")}setStyleProp(e,t,n){if(t[0]==="-"){const i=n.indexOf("!important");let r=n;if(i!==-1)r=i!==n.slice(0,i)+n.slice(i+10);r=r.trim().replace(/;$/,"");e.style.setProperty(t,r)}else e.style[t]=n}removeStyleProp(e,t){if(t[0]==="-")e.style.removeProperty(t);else delete e.style[t]}addEventListener(e,t,n,i){const r=this.createEventListenerDelegate(i,t,n);if(e.addEventListener)e.addEventListener(n,r);else if(e.attachEvent)e.attachEvent(_(n),r);else{const t=e[n]&&e[n].listeners||[];if(e[n]!=null)e[n].listeners=t.concat([r]);else{const i=(...t)=>e[n].listeners.map(e=>e(...t));i.listeners=t.concat([r]);e[n]=i}}}updateEventListener(e,t,n){this.updateEventListenerDelegate(n,e,t)}removeEventListener(e,t,n){const i=this.getEventListenerDelegate(t,n);this.removeEventListenerDelegate(t,n);if(e.removeEventListener)e.removeEventListener(n,i);else if(e.detachEvent)e.detachEvent(_(n),i);else{if(e[n]!=null&&e[n].listeners!=null)e[n].listeners=e[n].listener.filter(e=>e!==i)}}getEventListenerDelegate(e,t){const n=ae.getAttrKey(e,t);return this.eventListenerDelegates.get(n)}hasEventListenerDelegate(e,t){const n=ae.getAttrKey(e,t);return this.eventListenerDelegates.has(n)}createEventListenerDelegate(e,t,n){const i=ae.getAttrKey(t,n);this.eventListeners.set(i,e);const r=(...e)=>{const t=this.eventListeners.get(i);if(t==null)throw new Error("Event listener not found");t(...e)};this.eventListenerDelegates.set(i,r);return r}updateEventListenerDelegate(e,t,n){const i=ae.getAttrKey(t,n);this.eventListeners.set(i,e)}removeEventListenerDelegate(e,t){const n=ae.getAttrKey(e,t);this.eventListenerDelegates.delete(n);this.eventListeners.delete(n)}}class ce{constructor(e,t){const n=t.tag,i=t.attrs,r=t.children;this.template=n.template;this.state=i;this.actions=this.bindActions(n.actions);this.behavior=n.behavior;this.dispatcher=new $;this.templateFacade=new C(this);this.actionFacade=new j(this);this.children=r;this.id=n.id;this.context=e;this.tree=new G;this.renderer=new ae(this,e);this.node=null;this.destroyed=false;this.templateLock=false;this.updateLock=false;this.trackedActionUpdate=false;this.tmpElement=null;this.runBehavior()}get element(){return this.renderer.element||this.tmpElement}render(){if(this.destroyed)throw new Error("View is destroyed");this.tmpElement=null;this.node=this.renderTemplate();return this.renderer.render(this.node)}hydrate(e){if(this.destroyed)throw new Error("View is destroyed");if(this.element!=null)throw new Error("View is already hydrated");this.tmpElement=null;if(this.node==null)this.node=this.renderTemplate();const t=!this.context.isLocked();if(t)this.context.lock();this.renderer.hydrate(e,this.node);if(t){this.context.unlock();const e=this.context.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element])}else{const e=this.context.getCallbackQueue("mount");e.push(()=>this.dispatcher.notify("mount",[this.element]))}}attach(e){if(this.destroyed)throw new Error("View is destroyed");if(this.element!=null)throw new Error("View is already attached");this.tmpElement=null;if(this.node==null)this.node=this.renderTemplate();const t=!this.context.isLocked();if(t)this.context.lock();this.renderer.attach(e,this.node);if(t){this.context.unlock();const e=this.context.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element])}else{const e=this.context.getCallbackQueue("mount");e.push(()=>this.dispatcher.notify("mount",[this.element]))}}mount(e,t){if(this.destroyed)throw new Error("View is destroyed");this.tmpElement=null;const n=!this.context.isLocked();if(n)this.context.lock();if(this.node==null)this.node=this.renderTemplate();const i=this.renderer.render(this.node);this.renderer.attach(i,this.node);this.renderer.mount(e,t);if(n){this.context.unlock();const e=this.context.getCallbackQueue("mount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("mount",[this.element])}else{const e=this.context.getCallbackQueue("mount");e.push(()=>this.dispatcher.notify("mount",[this.element]))}}move(e,t){this.tmpElement=null;this.renderer.move(e,t)}update(e=null,t=null){let n=false;if(this.destroyed)throw new Error("View has been destroyed");const i=this.updateState(e);const r=this.updateChildrenState(t);n=this.state!==i||this.children!==r;this.state=i;this.children=r;if(this.element!==null&&n)this.refresh();if(this.element!==null&&n)this.dispatcher.notify("update",[this.state]);return n}unmount(){if(this.destroyed)throw new Error("View has been destroyed");if(this.element===null)throw new Error("View has been already unmounted");const e=!this.context.isLocked();if(e)this.context.lock();this.tmpElement=this.element;this.renderer.detach(this.node);if(e){this.context.unlock();const e=this.context.getCallbackQueue("unmount");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("unmount");this.tmpElement=null}else{const e=this.context.getCallbackQueue("unmount");e.push(()=>{this.dispatcher.notify("unmount");this.tmpElement=null})}}destroy(e=true){if(this.destroyed)throw new Error("View has been destroyed");const t=this.element;if(t!==null)this.unmount();const n=!this.context.isLocked();if(n)this.context.lock();this.destroyInnerViews([],false);if(e&&t!=null)t.remove();this.node=null;this.destroyed=true;f(()=>this.tree.isEmpty(),"View tree is empty after destroy");if(n){this.context.unlock();const e=this.context.getCallbackQueue("destroy");while(e.length>0){const t=e.splice(0,1)[0];t()}this.dispatcher.notify("destroy")}else{const e=this.context.getCallbackQueue("destroy");e.push(()=>this.dispatcher.notify("destroy"))}}getOrInstantiateInnerView(e,t,n){if(!this.tree.hasView(t))return this.instantiateInnerView(e,t,n);return this.tree.getView(t)}instantiateInnerView(e,t,n){f(()=>!this.tree.hasView(t),"View tree overwrite");const i=new ce(n,e);this.tree.addView(t,i);return i}getInstantiatedInnerView(e){return this.tree.getView(e)}destroyInnerViews(e,t=true){var n=true;var i=false;var r=undefined;try{for(var s=this.tree.iterateViews(e)[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;const n=e.view;n.destroy(t);e.delete()}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}}destroyInnerView(e,t=true){const n=this.tree.getView(e);this.tree.removeView(e);n.destroy(t)}runBehavior(){if(this.behavior instanceof Function)this.behavior(new K(this))}refresh(){const e=this.renderTemplate();const t=this.node;this.node=e;this.renderer.update(t,e)}renderTemplate(){this.templateLock=true;try{let e=this.template(this.templateFacade);if(Array.isArray(e)){if(e.length!==1)throw new Error("Only one root element must be rendered for a view");e=e[0]}e=e!=null?e:"";return e}finally{this.templateLock=false}}bindActions(t){const n={};var i=true;var r=false;var s=undefined;try{for(var o=e.keys(t)[Symbol.iterator](),l;!(i=(l=o.next()).done);i=true){const e=l.value;const i=t[e];if(i instanceof Function)n[e]=((...n)=>this.callAction(t[e],...n));else n[e]=this.bindActions(i)}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}return n}callAction(e,...t){var n=this;if(this.templateLock)throw new Error("Actions can't be called during template render");const i=!this.updateLock;this.updateLock=true;let r=e(...t);if(r instanceof Function)r=r(this.actionFacade);else if(r instanceof Promise){return F(function*(){n.finishAction(i);r=yield r;if(r instanceof Function)r=r(n.actionFacade);if(r instanceof Promise){n.finishAction(i);r=yield r;n.finishAction(i,r);return n.state}else{n.finishAction(i,r);return n.state}})()}if(r instanceof Promise){return F(function*(){n.finishAction(i);r=yield r;n.finishAction(i,r);return n.state})()}else{this.finishAction(i,r);return this.state}}finishAction(e,t=null){this.updateLock=false;if(e){if(!this.destroyed&&this.element!==null){let e=false;const n=this.update(t);if(!n&&this.trackedActionUpdate){this.trackedActionUpdate=false;this.refresh();e=true}else this.trackedActionUpdate=false;if(e)this.dispatcher.notify("update",[this.state])}else if(!this.destroyed)this.state=this.updateState(t)}else{const e=this.updateState(t);this.trackedActionUpdate=this.trackedActionUpdate||this.state!==e;this.state=e}}updateState(t=null){if(t==null||t===this.state)return this.state;const n={};let i=false;var r=true;var s=false;var o=undefined;try{for(var l=e.keys(t)[Symbol.iterator](),a;!(r=(a=l.next()).done);r=true){const e=a.value;if(typeof e==="symbol")this.state[e]=t[e];else{n[e]=t[e];i=i||t[e]!==this.state[e]}}}catch(e){s=true;o=e}finally{try{if(!r&&l.return!=null){l.return()}}finally{if(s){throw o}}}if(!i)return this.state;var c=true;var h=false;var u=undefined;try{for(var d=e.keys(this.state)[Symbol.iterator](),f;!(c=(f=d.next()).done);c=true){const e=f.value;if(!(e in n))n[e]=this.state[e]}}catch(e){h=true;u=e}finally{try{if(!c&&d.return!=null){d.return()}}finally{if(h){throw u}}}return n}updateChildrenState(t=null){if(t===null||t===null)return this.children;const n=this.children==null||this.children.length===0;const i=t.length===0;if(n!==i)return t;else return!e.shallowEqual(this.children,t)?t:this.children}}const he=(e,t,n,{insideSvg:i,hydrate:r,isProduction:s})=>{const o=v.isNode(t)?t:p(t);const l=e.ownerDocument;let a=M.initialize(l,{production:s,svg:i});if(!a.isSvg()){const t=l.defaultView;if(e instanceof t.SVGElement)a=a.setSvg(true)}const c=new ce(a,o);const h=W(e)?e.content:e;if(r)c.hydrate(h.childNodes[n]);else c.mount(h,n);return new H(c)};const ue=(e,t,n=0,{insideSvg:r=false,env:o=(s?"production":"development")}={})=>he(e,t,n,{insideSvg:r,hydrate:false,isProduction:!i(o)});const de=(e,t,n=0,{insideSvg:r=false,env:o=(s?"production":"development")}={})=>he(e,t,n,{insideSvg:r,hydrate:true,isProduction:!i(o)});const fe=(e,t,{insideSvg:n=false,env:i=(s?"production":"development")}={})=>{const r=v.isNode(t)?t:p(t);const o=M.initialize(e,{production:s,svg:n});const l=new ce(o,r);return new H(l)};const me=(e,t,{insideSvg:n=false,env:i=(s?"production":"development")}={})=>{const r=fe(e,t,{insideSvg:n,env:i});r.render();return new H(r)};const ve=e=>{if(e==null)return(e,t)=>t;if(e instanceof Function)return e;else return t=>t[e]};const pe=e=>({data:e.data||[],accessor:ve(e.indexBy),render:e.render,mountPoint:null,initialized:false,views:{},index:[],prevData:[]});const we=new b(({state:{render:e}})=>e);const ye=e=>{let t=0;const n=[];var i=true;var r=false;var s=undefined;try{for(var o=e[Symbol.iterator](),l;!(i=(l=o.next()).done);i=true){const e=l.value;if(e.added){var a=true;var c=false;var h=undefined;try{for(var u=e.value[Symbol.iterator](),d;!(a=(d=u.next()).done);a=true){const e=d.value;n.push({added:true,value:e,index:t});t+=1}}catch(e){c=true;h=e}finally{try{if(!a&&u.return!=null){u.return()}}finally{if(c){throw h}}}}else if(e.removed){var f=true;var m=false;var v=undefined;try{for(var p=e.value[Symbol.iterator](),w;!(f=(w=p.next()).done);f=true){const e=w.value;n.push({removed:true,value:e,index:t})}}catch(e){m=true;v=e}finally{try{if(!f&&p.return!=null){p.return()}}finally{if(m){throw v}}}}else{var y=true;var g=false;var x=undefined;try{for(var b=e.value[Symbol.iterator](),N;!(y=(N=b.next()).done);y=true){const e=N.value;n.push({value:e,index:t});t+=1}}catch(e){g=true;x=e}finally{try{if(!y&&b.return!=null){b.return()}}finally{if(g){throw x}}}}}}catch(e){r=true;s=e}finally{try{if(!i&&o.return!=null){o.return()}}finally{if(r){throw s}}}const E={};for(const e in n){const t=n[e];if(t.added)E[t.value]=e}for(let e=0;e<n.length;e++){const t=n[e];if(t.removed&&t.value in E){n.splice(e,1);e--}}return n};const ge=({state:e})=>{const t=O(e.mountPoint,2),n=t[0],i=t[1];n.childNodes[i].remove();e.initialized=true;e.index=[];e.views={};for(const t in e.data){const r=+t;const s=e.data[r];const o=e.accessor(s,r,e.data);e.index.push(o);const l=p(we,{render:e.render(s,r,e.data)});const a=ue(n,l,i+r);e.views[o]={view:a,index:i+r}}xe(e.index);e.prevData=e.data};const xe=e=>{const t={};var n=true;var i=false;var r=undefined;try{for(var s=e[Symbol.iterator](),o;!(n=(o=s.next()).done);n=true){const e=o.value;if(e in t)throw new Error("Item keys must be unique");t[e]=true}}catch(e){i=true;r=e}finally{try{if(!n&&s.return!=null){s.return()}}finally{if(i){throw r}}}return e};const be=({state:e})=>{const n=O(e.mountPoint,2),i=n[0],r=n[1];const s=e.data.map(e.accessor);xe(s);const o=t.diffArrays(e.index,s);const l=ye(o);const a={};for(const t in l){const n=l[t];const s=n.value;const o=+n.index;const c=s in e.views;if(n.added&&s!==e.index[o]){if(c){const t=n.index;const r=e.index[t];const o=e.views[s],l=o.index,c=o.view;const h=e.views[r].view;c.move(i,t);if(e.prevData[l]!==e.data[t])c.update({render:e.render(e.data[t],t,e.data)});h.move(i,l+1);if(e.prevData[t]!==e.data[l])h.update({render:e.render(e.data[l],t,e.data)});e.views[s]={view:c,index:t};e.views[r]={view:h,index:l};a[s]=true;a[r]=true}else{const t=e.data[o];const n=p(we,{render:e.render(t,o,e.data)});const l=ue(i,n,r+o);e.views[s]={view:l,index:r+o}}}else if(n.removed){const t=e.views[s].view;t.destroy();delete e.views[s]}else if(!(s in a)){const t=e.data[o];if(t!==e.prevData[o])e.views[s].view.update({render:e.render(t,o,e.data)})}}e.index=s;e.prevData=e.data};const Ne=e=>{if(e.state.mountPoint==null)return;if(e.state.initialized)be(e);else ge(e)};const Ee=e=>{const t=e.state,n=e.element;t.mountPoint=[n.parentNode,Array.prototype.indexOf.call(n.parentNode.childNodes,n)];Ne(e)};const De=({state:e})=>{for(var t=0,n=Object.values(e.views);t<n.length;t++){const e=n[t].view;e.destroy(false)}const i=O(e.mountPoint,2),r=i[0],s=i[1];for(let t=0;t<e.data.length;t++)r.childNodes[s].remove();e.mountPoint=null;e.initialized=false;e.views={};e.index=[];e.prevData=[]};const Ve=function(){var e=F(function*(e){e.state=I({},e.state,{},pe(e.state));e.onMount(Ee);e.onUpdate(Ne);e.onDestroy(De)});return function t(n){return e.apply(this,arguments)}}();const Ae=new b(null,Ve);const Te=new b(({state:e,children:t})=>{if(t.length!==0){if(t.length!==1||!(t[0]instanceof Function))throw new Error("You must provide a render function as the only children to the List");const n=t[0];return p(Ae,I({},e,{render:n}))}else return null});const Fe=new b(({state:t,children:n})=>{if(n.length!==1||!(n[0]instanceof Function))throw new Error("You must provide a render function as the only children to the Map");const i=n[0];const r=([e,t],n,r)=>i(t,e,r,n);const s=e.keys(t.data||{}).map(e=>[e,t.data[e]]);const o=([e])=>e;return p(Ae,{data:s,indexBy:o,render:r})});const ke=(e,t,n=null)=>e?t:n;const Se=new b(({state:{when:e=false},children:t})=>ke(e,t,null));const Ie=new b(({state:{when:e=true},children:t})=>ke(e,null,t));const Oe=e=>e===null||v.isNode(e)||typeof e!=="object"&&Object.getPrototypeOf(e)===Function.prototype;const Le=(e,t,n)=>{const i={[e]:true};for(const e in t.decorators)i[e]=true;n.decorators=i;return n};var Pe=e=>{const t=m("decorator",8);return n=>{let i;if(b.isViewDeclaration(n))i=n;else if(typeof n==="string")i=new b(({state:e,children:t})=>p(n,e,t));else if(Oe(n))i=new b(n);else throw new Error("Nothing to decorate");if(i.decorators[t])return i;let r=e(i);if(!b.isViewDeclaration(r)){if(Oe(r))r=new b(r);else return Le(t,i,r)}if(i.originalId!=null)r.originalId=i.originalId;else r.originalId=i.id;return Le(t,i,r)}};const Ue=t=>{const n=t!=null?t:u;return(t,i=null)=>{const r=i!=null?I({},i):null;if(r!=null&&"state"in r)r.state=I({},e.omit(["logger"],r.state));let s=r!=null?[t,r]:[t];n(...s)}};const $e=e=>{const t={parent:e.element.parentNode,index:Array.prototype.indexOf.call(e.element.parentNode.childNodes,e.element)};if(e.children!=null&&e.children.length>0)t.element=e.element;return t};const Ce=(t,n)=>{let i=null;const r={};var s=true;var o=false;var l=undefined;try{for(var a=e.keys(t.prev)[Symbol.iterator](),c;!(s=(c=a.next()).done);s=true){const e=c.value;r[e]=true}}catch(e){o=true;l=e}finally{try{if(!s&&a.return!=null){a.return()}}finally{if(o){throw l}}}var h=true;var u=false;var d=undefined;try{for(var f=e.keys(n.state)[Symbol.iterator](),m;!(h=(m=f.next()).done);h=true){const e=m.value;r[e]=true}}catch(e){u=true;d=e}finally{try{if(!h&&f.return!=null){f.return()}}finally{if(u){throw d}}}for(const e in r){const r=t.prev[e];const s=n.state[e];if(r!==s){if(i===null)i={};i[e]=s}}return i};const je=e=>t=>{const n="DEBUG: created "+(t.state.info?`"${t.state.info}"`:"");const i={state:t.state};e(n,i)};const Ke=(e,t)=>n=>{const i="DEBUG: mounted "+(n.state.info?`"${n.state.info}"`:"");const r={state:n.state,element:$e(n)};t.prev=n.state;e(i,r)};const He=(e,t)=>n=>{const i="DEBUG: updated "+(n.state.info?`"${n.state.info}"`:"");const r={state:n.state,element:$e(n)};const s=Ce(t,n);if(s!=null)r.update=s;t.prev=n.state;e(i,r)};const Me=e=>t=>{const n="DEBUG: unmounted "+(t.state.info?`"${t.state.info}"`:"");const i={state:t.state,element:$e(t)};e(n,i)};const We=e=>t=>{const n="DEBUG: destroyed "+(t.state.info?`"${t.state.info}"`:"");e(n)};const qe=e=>t=>{const n={prev:{}};je(e)(t);t.onMount(Ke(e,n));t.onUpdate(He(e,n));t.onUnmount(Me(e));t.onDestroy(We(e))};const ze=new Map;const Be=1e4;const Qe=(e=null)=>{if(ze.has(e))return ze.get(e);else{const t=new b(null,qe(Ue(e)));if(ze.size<Be)ze.set(e,t);return t}};var Ge=new b(({state:t,children:n})=>p(Qe(t.logger),e.omit(["logger"],t),n)).setDevelopmentOnly(true);const _e=(...t)=>{if(t.length>1)return e.compose(...t)(A);else if(t.length===1){const e=t[0];if(e instanceof Function)return e(A);else return new b(e)}else return A};const Re=e=>new b(e);exports.view=_e;exports.template=Re;exports.h=p;exports.isElementNode=E;exports.isViewNode=N;exports.isTextNode=D;exports.Node=v;exports.Declaration=b;exports.instantiate=fe;exports.render=me;exports.hydrate=de;exports.mount=ue;exports.isDevelopment=r;exports.isProduction=s;exports.getGlobal=d;exports.warn=h;exports.Debug=Ge;exports.Id=V;exports.None=A;exports.Show=Se;exports.Hide=Ie;exports.List=Te;exports.Map=Fe;exports.branch=ke;exports.decorator=Pe;
