"use strict";Object.defineProperty(exports,"__esModule",{value:true});var c=require("malina");var a=require("malina-util");function f(t){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){f=function(t){return typeof t}}else{f=function(t){return t&&typeof Symbol==="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t}}return f(t)}function s(t,n,e,r,u,i,o){try{var a=t[i](o);var c=a.value}catch(t){e(t);return}if(a.done){n(c)}else{Promise.resolve(c).then(r,u)}}function t(a){return function(){var t=this,o=arguments;return new Promise(function(n,e){var r=a.apply(t,o);function u(t){s(r,n,e,u,i,"next",t)}function i(t){s(r,n,e,u,i,"throw",t)}u(undefined)})}}function e(t,n){if(!(t instanceof n)){throw new TypeError("Cannot call a class as a function")}}function r(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(t,r.key,r)}}function u(t,n,e){if(n)r(t.prototype,n);if(e)r(t,e);return t}function l(t,n,e){if(n in t){Object.defineProperty(t,n,{value:e,enumerable:true,configurable:true,writable:true})}else{t[n]=e}return t}function v(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};var r=Object.keys(e);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))}r.forEach(function(t){l(n,t,e[t])})}return n}function o(t,n){if(t==null)return{};var e={};var r=Object.keys(t);var u,i;for(i=0;i<r.length;i++){u=r[i];if(n.indexOf(u)>=0)continue;e[u]=t[u]}return e}function p(t,n){if(t==null)return{};var e=o(t,n);var r,u;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(u=0;u<i.length;u++){r=i[u];if(n.indexOf(r)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,r))continue;e[r]=t[r]}}return e}var n=function t(r){return c.decorator(function(e){var u=function t(n){if(e.state instanceof Function)return e.state(n);else return e.state};var i=function t(n){if(r instanceof Function)return r(n);else return r};var t=function t(n){var e=u(n);var r=i(n);return v({},e!=null?e:{},r!=null?r:{})};return c.view(e.template,t,e.actions,e.hooks)})};var h=function t(u){return c.decorator(function(e){var r=function t(n){if(e.actions instanceof Function)return e.actions(n);else return e.actions};var t=function t(n){return v({},r(n)||{},u||{})};return c.view(e.template,e.state,t,e.hooks)})};var m=function t(a){return c.decorator(function(e){var o=function t(n){if(e.hooks instanceof Function)return e.hooks(n);else return e.hooks};var t=function t(n){var i=o(n)||{};var e=v({},i);var r=function t(u){e[u]=function(n,e,r){var t=function t(){if(i[u]!=null)i[u](n,e,r)};a[u](t)(n,e,r)}};for(var u in a){r(u)}return e};return c.view(e.template,e.state,e.actions,t)})};var d=function t(n){return c.decorator(function(t){return c.view(n(t.template),t.state,t.actions,t.hooks)})};var i=function t(u){return c.decorator(function(r){return function(t,n,e){return c.h(r,u(t),e)}})};var b=function(){function t(){e(this,t);this.listenerCounter=0;this.listeners={}}u(t,[{key:"subscribe",value:function t(n){var e=this;var r=++this.listenerCounter;this.listeners[r]=n;return function(){return delete e.listeners[r]}}},{key:"notify",value:function t(){for(var n in this.listeners){var e;(e=this.listeners)[n].apply(e,arguments)}}}]);return t}();var y=Symbol("context");var w=function(){function n(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};e(this,n);this.value=t;this.emitter=new b}u(n,[{key:"subscribe",value:function t(n){return this.emitter.subscribe(n)}},{key:"update",value:function t(n){var e=v({},this.value,n);if(a.shallowEqual(this.value,e))return;this.value=e;this.emitter.notify(this.value)}},{key:"get",value:function t(){return this.value}}]);return n}();var g=new Map;var x=1e4;var O=function t(e){return c.decorator(function(t){if(g.has(t.template))return g.get(t.template);else{var n=e(t);if(g.size<x)g.set(t.template,n);return n}})};var j=O(d(function(i){return function(t,n,e){var r=t[y];var u=i(t,n,e);if(r!=null)return k(r)(u);else return u}}));var k=function e(r){return function(t){if(c.isViewNode(t)){var n=v({},t.attrs!=null?t.attrs:{},l({},y,r));return c.h(j(t.tag),n,t.children.map(e(r)))}else if(c.isElementNode(t))return c.h(t.tag,t.attrs,t.children.map(e(r)));else return t}};var S=function t(n){return n};var P=function t(){var u=arguments.length>0&&arguments[0]!==undefined?arguments[0]:S;var i=function t(n,e){var r=u(n);if(f(r)!=="object")throw new Error("Context must be an object derived from view's state and actions");return r};return a.compose(m({create:function t(u){return function(t,n,e){u();if(!(y in n)){var r=new w(i(n,e));n[y]=r}}},update:function t(u){return function(t,n,e){u();var r=n[y];r.update(i(n,e))}}}),j)};var E=Symbol("update");var C=Symbol("subscription");var F=function t(n){return{context:n}};var N=function t(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:F;return a.compose(m({create:function t(u){return function(t,n,e){var r=n[y];if(r!=null)Object.assign(n,i(r.value));u();if(r==null)r=n[y];if(r!=null){n[C]=r.subscribe(e[E]);Object.assign(n,i(r.value))}}},destroy:function t(r){return function(t,n,e){if(C in n)n[C]();r()}}}),h(l({},E,function(t){return function(){return v({},i(t))}})))};var M=Symbol("store");var q=function t(e,n){return n.reduce(function(t,n){Object.assign(t,n(e));return t},{})};var A=function t(){for(var n=arguments.length,e=new Array(n),r=0;r<n;r++){e[r]=arguments[r]}return a.compose(N(function(t){return M in t?q(t[M].ref,e):{}}),P(function(t){var n=t.store;return n!=null?l({},M,{ref:n}):{}}))};var z={};z.update=function(o){return function(){var n=t(regeneratorRuntime.mark(function t(e){var r,u,i;return regeneratorRuntime.wrap(function t(n){while(1){switch(n.prev=n.next){case 0:r=e.state;u=v({},r);i=o;if(o instanceof Function)i=o(u);if(!(i instanceof Promise)){n.next=8;break}n.next=7;return i;case 7:i=n.sent;case 8:if(i!=null)u=v({},u,i);return n.abrupt("return",{state:u});case 10:case"end":return n.stop()}}},t,this)}));return function(t){return n.apply(this,arguments)}}()};var R=function t(n){return c.decorator(function(t){var o=a.compose(N(function(t){return M in t?{store:t[M].ref}:{}}),P(function(t){var n=t.ref;return l({},M,n)}),i(function(t){var n=t.ref,e=p(t,["ref"]);return v({},e)}))(t);return c.view(function(t,n,e){var r=t.state,u=t.ref,i=p(t,["state","ref"]);u.state=r;u.update=n.update;return c.h(o,v({},i,{ref:{ref:u}}),e)},{state:v({},n),ref:{}},z)})};var T=function t(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return R(n)};var V=function i(o){return function(r){var u={};var t=function t(n){var e=o[n];if(e instanceof Function)u[n]=function(){return e(r).apply(void 0,arguments)};else if(f(e)==="object")u[n]=i(e)(r)};for(var n in o){t(n)}return u}};var _=new Map;var D=1e4;var H=function t(e){return c.decorator(function(t){if(_.has(t.template))return _.get(t.template);else{var n=e(t);if(_.size<D)_.set(t.template,n);return n}})};var I=function t(i){return H(d(function(u){return function(t,n,e){var r=u(t,n,e);return B(i)(r)}}))};var B=function i(o){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"styleName";return function(t){if(c.isViewNode(t))return c.h(I(o)(t.tag),t.attrs,t.children.map(i(o)));else if(c.isElementNode(t)){if(t.attrs!=null&&a in t.attrs){var n=(t.attrs[a]||"").split(" ").filter(function(t){return t.length>0});var e=(t.attrs.class||"").split(" ").filter(function(t){return t.length>0});var r=n.map(function(t){return o[t]}).filter(function(t){return t!=null}).concat(e).join(" ");var u=v({},t.attrs);delete u[a];if(r.length>0)u.class=r;return c.h(t.tag,u,t.children.map(i(o)))}else return c.h(t.tag,t.attrs,t.children.map(i(o)))}else return t}};var G=function(n){return c.decorator(function(t){return I(n)(t)})};exports.cssModules=G;exports.withState=n;exports.withActions=h;exports.withHooks=m;exports.withTemplate=d;exports.mapState=i;exports.withContext=P;exports.getContext=N;exports.connect=A;exports.withStore=T;exports.bindActions=V;
