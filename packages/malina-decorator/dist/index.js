"use strict";Object.defineProperty(exports,"__esModule",{value:true});var t=require("malina");var e=require("malina-util");function n(t,e,n,r,s,o,i){try{var c=t[o](i);var a=c.value}catch(t){n(t);return}if(c.done){e(a)}else{Promise.resolve(a).then(r,s)}}function r(t){return function(){var e=this,r=arguments;return new Promise(function(s,o){var i=t.apply(e,r);function c(t){n(i,s,o,c,a,"next",t)}function a(t){n(i,s,o,c,a,"throw",t)}c(undefined)})}}function s(t,e,n){if(e in t){Object.defineProperty(t,e,{value:n,enumerable:true,configurable:true,writable:true})}else{t[e]=n}return t}function o(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};var r=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))}r.forEach(function(e){s(t,e,n[e])})}return t}const i=t=>e=>{if(t instanceof Function)return t(e)||{};else return t||{}};const c=e=>t.decorator(n=>{const r=i(n.state);const s=i(e);const c=t=>{const e=r(t);const n=s(t);return o({},e,n)};return t.view(n.template,c,n.actions,n.hooks)});const a=e=>t.decorator(n=>{const r=i(n.actions);const s=i(e);const c=t=>o({},r(t),s(t));return t.view(n.template,n.state,c,n.hooks)});const l=e=>t.decorator(n=>{const r=i(n.hooks);const s=i(e);const c=t=>{const e=r(t);const n=s(t);const i=o({},e);for(const t in n){i[t]=((r,s,o)=>{const i=()=>{if(e[t]!=null)e[t](r,s,o)};n[t](i)(r,s,o)})}return i};return t.view(n.template,n.state,n.actions,c)});const u=e=>t.decorator(n=>t.view(e(n.template),n.state,n.actions,n.hooks));const f=e=>t.decorator(n=>(r,s,o)=>t.h(n,e(r),o));class p{constructor(){this.listenerCounter=0;this.listeners={}}subscribe(t){const e=++this.listenerCounter;this.listeners[e]=t;return()=>delete this.listeners[e]}notify(...t){for(const e in this.listeners)this.listeners[e](...t)}}const h=Symbol("context");class d{constructor(t={}){this.value=t;this.emitter=new p}subscribe(t){return this.emitter.subscribe(t)}update(t){const n=o({},this.value,t);if(e.shallowEqual(this.value,n))return;this.value=n;this.emitter.notify(this.value)}get(){return this.value}}const m=new Map;const v=1e4;const b=e=>t.decorator(t=>{if(m.has(t.template))return m.get(t.template);else{let n=e(t);if(m.size<v)m.set(t.template,n);return n}});const y=b(u(t=>(e,n,r)=>{const s=e[h];const o=t(e,n,r);if(s!=null)return w(s)(o);else return o}));const w=e=>n=>{if(!Array.isArray(n)){if(t.isViewNode(n)){const r=o({},n.attrs!=null?n.attrs:{},{[h]:e});return t.h(y(n.tag),r,n.children.map(w(e)))}else if(t.isElementNode(n))return t.h(n.tag,n.attrs,n.children.map(w(e)));else return n}else return n.map(w(e))};const g=t=>t;const x=(t=g)=>{const n=(e,n)=>{const r=t(e,n);if(typeof r!=="object")throw new Error("Context must be an object derived from view's state and actions");return r};return e.compose(l({create:t=>(e,r,s)=>{t();if(!(h in r)){const t=new d(n(r,s));r[h]=t}},update:t=>(e,r,s)=>{t();const o=r[h];o.update(n(r,s))}}),y)};const j=Symbol("update");const O=Symbol("subscription");const S=t=>({context:t});const P=(t=S)=>e.compose(l({create:e=>(n,r,s)=>{let o=r[h];if(o!=null)Object.assign(r,t(o.value));e();if(o==null)o=r[h];if(o!=null){r[O]=o.subscribe(s[j]);Object.assign(r,t(o.value))}},destroy:t=>(e,n,r)=>{if(O in n)n[O]();t()}}),a({[j]:e=>()=>o({},t(e))}));const k={};k.update=(t=>(function(){var n=r(function*({store:n}){let r=o({},n);let s=t;if(t instanceof Function)s=t(r);if(s instanceof Promise)s=yield s;if(s!=null)r=o({},r,s);if(!e.shallowEqual(n,r))return{store:r}});return function(t){return n.apply(this,arguments)}})());const E=Symbol("store");const C=x((t,e)=>({[E]:{state:t.store,update:e.update}}));const N=e=>C(t.view((t,e,n)=>n,{store:e},k));const q=e=>t.decorator(n=>{const r=N(e);return u(n=>(s,o,i)=>t.h(r,{store:e},n(s,o,i)))(n)});const A=(...t)=>({});const M=(t=A,e=A)=>P(n=>{if(E in n){const r=n[E];return o({},t(r.state),e(r.update))}else return{}});const F=t=>n=>{const r={};var s=true;var o=false;var i=undefined;try{for(var c=e.keys(t)[Symbol.iterator](),a;!(s=(a=c.next()).done);s=true){const e=a.value;const s=t[e];if(s instanceof Function)r[e]=((...t)=>n(s(...t)));else r[e]=F(s)}}catch(t){o=true;i=t}finally{try{if(!s&&c.return!=null){c.return()}}finally{if(o){throw i}}}return r};const z=new Map;const V=1e4;const _=e=>t.decorator(t=>{if(z.has(t.template))return z.get(t.template);else{let n=e(t);if(z.size<V)z.set(t.template,n);return n}});const D=(t,e)=>_(u(n=>(r,s,o)=>{const i=n(r,s,o);return H(t,e)(i)}));const H=(e,n)=>r=>{if(t.isViewNode(r))return t.h(D(e)(r.tag),r.attrs,r.children.map(H(e)));else if(t.isElementNode(r)){if(r.attrs!=null&&n in r.attrs){const s=(r.attrs[n]||"").split(" ").filter(t=>t.length>0);const i=(r.attrs.class||"").split(" ").filter(t=>t.length>0);const c=s.map(t=>e[t]).filter(t=>t!=null).concat(i).join(" ");const a=o({},r.attrs);delete a[n];if(c.length>0)a.class=c;return t.h(r.tag,a,r.children.map(H(e)))}else return t.h(r.tag,r.attrs,r.children.map(H(e)))}else return r};var T=(e,n="styleName")=>t.decorator(t=>D(e,n)(t));exports.cssModules=T;exports.withState=c;exports.withActions=a;exports.withHooks=l;exports.withTemplate=u;exports.mapState=f;exports.withContext=x;exports.getContext=P;exports.withStore=q;exports.connect=M;exports.bindActions=F;
