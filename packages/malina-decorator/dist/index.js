"use strict";Object.defineProperty(exports,"__esModule",{value:true});var t=require("malina");var e=require("malina-util");const s=t=>e=>{if(t instanceof Function)return t(e)||{};else return t||{}};const n=e=>t.decorator(n=>{const o=s(n.state);const r=s(e);const c=t=>{const e=o(t);const s=r(t);return{...e,...s}};return t.view(n.template,c,n.actions,n.hooks)});const o=e=>t.decorator(n=>{const o=s(n.actions);const r=s(e);const c=t=>({...o(t),...r(t)});return t.view(n.template,n.state,c,n.hooks)});const r=e=>t.decorator(n=>{const o=s(n.hooks);const r=s(e);const c=t=>{const e=o(t);const s=r(t);const n={...e};for(const t in s){n[t]=((n,o,r)=>{const c=()=>{if(e[t]!=null)e[t](n,o,r)};s[t](c)(n,o,r)})}return n};return t.view(n.template,n.state,n.actions,c)});const c=e=>t.decorator(s=>t.view(e(s.template),s.state,s.actions,s.hooks));const i=e=>t.decorator(s=>(n,o,r)=>t.h(s,e(n),r));class a{constructor(){this.listenerCounter=0;this.listeners={}}subscribe(t){const e=++this.listenerCounter;this.listeners[e]=t;return()=>delete this.listeners[e]}notify(...t){for(const e in this.listeners)this.listeners[e](...t)}}const l=Symbol("context");class u{constructor(t={}){this.value=t;this.emitter=new a}subscribe(t){return this.emitter.subscribe(t)}update(t){const s={...this.value,...t};if(e.shallowEqual(this.value,s))return;this.value=s;this.emitter.notify(this.value)}get(){return this.value}}const p=new Map;const h=1e4;const f=e=>t.decorator(t=>{if(p.has(t.template))return p.get(t.template);else{let s=e(t);if(p.size<h)p.set(t.template,s);return s}});const d=f(c(t=>(e,s,n)=>{const o=e[l];const r=t(e,s,n);if(o!=null)return m(o)(r);else return r}));const m=e=>s=>{if(!Array.isArray(s)){if(t.isViewNode(s)){const n={...s.attrs!=null?s.attrs:{},[l]:e};return t.h(d(s.tag),n,s.children.map(m(e)))}else if(t.isElementNode(s))return t.h(s.tag,s.attrs,s.children.map(m(e)));else return s}else return s.map(m(e))};const w=t=>t;const b=(t=w)=>{const s=(e,s)=>{const n=t(e,s);if(typeof n!=="object")throw new Error("Context must be an object derived from view's state and actions");return n};return e.compose(r({create:t=>(e,n,o)=>{t();if(!(l in n)){const t=new u(s(n,o));n[l]=t}},update:t=>(e,n,o)=>{t();const r=n[l];r.update(s(n,o))}}),d)};const v=Symbol("update");const x=Symbol("subscription");const g=t=>({context:t});const y=(t=g)=>e.compose(r({create:e=>(s,n,o)=>{let r=n[l];if(r!=null)Object.assign(n,t(r.value));e();if(r==null)r=n[l];if(r!=null){n[x]=r.subscribe(o[v]);Object.assign(n,t(r.value))}},destroy:t=>(e,s,n)=>{if(x in s)s[x]();t()}}),o({[v]:e=>()=>({...t(e)})}));const S={};S.update=(t=>async({store:s})=>{let n={...s};let o=t;if(t instanceof Function)o=t(n);if(o instanceof Promise)o=await o;if(o!=null)n={...n,...o};if(!e.shallowEqual(s,n))return{store:n}});const j=Symbol("store");const k=b((t,e)=>({[j]:{state:t.store,update:e.update}}));const C=e=>k(t.view((t,e,s)=>s,{store:e},S));const E=e=>t.decorator(s=>{const n=C(e);return c(s=>(o,r,c)=>t.h(n,{store:e},s(o,r,c)))(s)});const N=(...t)=>({});const q=(t=N,e=N)=>y(s=>{if(j in s){const n=s[j];return{...t(n.state),...e(n.update)}}else return{}});const A=t=>s=>{const n={};for(const o of e.keys(t)){const e=t[o];if(e instanceof Function)n[o]=((...t)=>s(e(...t)));else n[o]=A(e)}return n};const M=new Map;const F=1e4;const O=e=>t.decorator(t=>{if(M.has(t.template))return M.get(t.template);else{let s=e(t);if(M.size<F)M.set(t.template,s);return s}});const z=(t,e)=>O(c(s=>(n,o,r)=>{const c=s(n,o,r);return P(t,e)(c)}));const P=(e,s)=>n=>{if(t.isViewNode(n))return t.h(z(e)(n.tag),n.attrs,n.children.map(P(e)));else if(t.isElementNode(n)){if(n.attrs!=null&&s in n.attrs){const o=(n.attrs[s]||"").split(" ").filter(t=>t.length>0);const r=(n.attrs.class||"").split(" ").filter(t=>t.length>0);const c=o.map(t=>e[t]).filter(t=>t!=null).concat(r).join(" ");const i={...n.attrs};delete i[s];if(c.length>0)i.class=c;return t.h(n.tag,i,n.children.map(P(e)))}else return t.h(n.tag,n.attrs,n.children.map(P(e)))}else return n};var V=(e,s="styleName")=>t.decorator(t=>z(e,s)(t));exports.cssModules=V;exports.withState=n;exports.withActions=o;exports.withHooks=r;exports.withTemplate=c;exports.mapState=i;exports.withContext=b;exports.getContext=y;exports.withStore=E;exports.connect=q;exports.bindActions=A;
