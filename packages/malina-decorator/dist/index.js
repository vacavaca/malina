"use strict";Object.defineProperty(exports,"__esModule",{value:true});var t=require("malina");var e=require("malina-util");function n(t,e,n,r,s,o,i){try{var l=t[o](i);var a=l.value}catch(t){n(t);return}if(l.done){e(a)}else{Promise.resolve(a).then(r,s)}}function r(t){return function(){var e=this,r=arguments;return new Promise(function(s,o){var i=t.apply(e,r);function l(t){n(i,s,o,l,a,"next",t)}function a(t){n(i,s,o,l,a,"throw",t)}l(undefined)})}}function s(t,e,n){if(e in t){Object.defineProperty(t,e,{value:n,enumerable:true,configurable:true,writable:true})}else{t[e]=n}return t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);if(e)r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable});n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};if(e%2){o(n,true).forEach(function(e){s(t,e,n[e])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(t,Object.getOwnPropertyDescriptors(n))}else{o(n).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}}return t}const l=Symbol.for("__malina_styles");const a=Symbol.for("__malina_styles_attribute");const c=Symbol.for("__malina_styles_update");const u=Symbol.for("__malina_styles_update_attribute");const f=(t,n)=>{if(n==null||e.keys(n).length===0)return t||{};else if(t==null||e.keys(t).length===0)return n||{};else return i({},n||{},{},t||{})};const d=(t,e)=>{if(e!=null)return e;else return t};const h=(e,n)=>r=>{if(t.isElementNode(r)){if(r.attrs!=null&&n in r.attrs){const s=(r.attrs[n]||"").split(" ").filter(t=>t.length>0);const o=(r.attrs.class||"").split(" ").filter(t=>t.length>0);const l=s.map(t=>e[t]).filter(t=>t!=null).concat(o).join(" ");const a=i({},r.attrs);delete a[n];if(l.length>0)a.class=l;return t.h(r.tag,a,r.children.map(h(e,n)))}else return t.h(r.tag,r.attrs,r.children.map(h(e,n)))}else if(t.isViewNode(r)){const s=i({},r.attrs||null,{[c]:e,[u]:n});return t.h(r.tag,s,r.children.map(h(e,n)))}else return r};const m=e.compose(t.mapTemplate(t=>({state:e})=>{const n=e||{},r=n[l],s=n[a];const o=e||{},i=o[c],m=o[u];const p=f(r,i);const v=d(s,m);const y=t();return h(p,v)(y)}));const p=(n,r="styleName")=>e.compose(m,t.withLifecycle({create:({state:t})=>{t[l]=f(t[l],n);t[a]=d(t[a],r)}}));const v=Symbol.for("__malina_ids.ctx");const y=Symbol.for("__malina_ids.state");const w=Symbol.for("__malina-decorator.id.random");const b=t.getGlobal();let g;if(b!=null&&w in b)g=b[w];else{g=new e.Random("malina-decorator.id-seed");if(b!=null)b[w]=g}const x=(e,n)=>r=>{if(n==null)return r;if(Array.isArray(r))return r.map(x(e,n.ids));else if(t.isElementNode(r)||e.views&&t.isViewNode(r)){let l=r.attrs;const a=`${e.realPrefix}Id`;const c=`${e.realPrefix}For`;const u=[];if(a in r.attrs){const t=r.attrs[a];l=i({},r.attrs,{id:t});delete l[a]}else if("id"in r.attrs)u.push("id");if(c in r.attrs){const t=r.attrs[c];l=i({},r.attrs,{for:t});delete l[c]}else if("for"in r.attrs)u.push("for");for(var s=0,o=u;s<o.length;s++){const a=o[s];const c=r.attrs[a];l=i({},r.attrs);if(c in n.ids)l[a]=n.ids[c];else{let r;if(t.isDevelopment){let t=++n.ref.id;r=`${t}`;while(r.length<e.length)r=`0${r}`}else r=g.id(e.length);const s=`${c}_${r}`;n.ids[c]=s;l[a]=s}}return t.h(r.tag,l,r.children.map(x(e,n)))}else return r};const _=(t={})=>({length:t.length||4,realPrefix:t.realPrefix||"html",views:t.views||false});const C=n=>e.compose(t.getContext(t=>v in t?{[v]:t[v]}:{}),t.withContext(({state:t})=>{if(!(v in t)){const e={id:0};t[v]=e;return{[v]:e}}else return{}}),t.withState({[y]:{ids:{}}}),t.mapTemplate(t=>e=>x(_(n),{ref:e.state[v],ids:e.state[y].ids})(t())));const S=(t,e)=>{let n=t;var r=true;var s=false;var o=undefined;try{for(var i=e[Symbol.iterator](),l;!(r=(l=i.next()).done);r=true){const t=l.value;if(n==null)break;n=n.childNodes[t]||null}}catch(t){s=true;o=t}finally{try{if(!r&&i.return!=null){i.return()}}finally{if(s){throw o}}}return n};const O=Symbol.for("__malina_refs");const E=t=>t.join(".");const P=new Set;const N=1e4;const j=e=>t.warn(`Incorrect use of refs:\n\n${e}\n\nViews can only handle its own refs. When a ref passed to a child-node inside another view-node it will be ignored`);const k=(e,n,r=null)=>{const s=t.isElementNode(n);const o=t.isViewNode(n);if(s&&e in n.attrs){if(r!=null&&P.size<N)P.add(r.tag.id);j(r||n);return true}else if(s||o&&!P.has(n.tag.id)){let t=false;var i=true;var l=false;var a=undefined;try{for(var c=n.children[Symbol.iterator](),u;!(i=(u=c.next()).done);i=true){const s=u.value;t=k(e,s,o?n:r);if(t)break}}catch(t){l=true;a=t}finally{try{if(!i&&c.return!=null){c.return()}}finally{if(l){throw a}}}return t}else return false};const A=(t,e,n,r)=>e.children.map((e,s)=>{const o=n.concat([s]);return R(t,e,o,r).node});const R=(n,r,s,o)=>{const i=t.isElementNode(r);if(i&&n in r.attrs){const i=r.attrs[n];if(!(i instanceof Function)&&typeof i!=="string")throw new Error("Ref consumer must be a function or a string");o.set(E(s),{path:s,consumer:i});const l=A(n,r,s,o);const a=t.h(r.tag,e.omit([n],r.attrs),l);return{refs:o,node:a}}else if(i){const e=A(n,r,s,o);const i=t.h(r.tag,r.attrs,e);return{refs:o,node:i}}else if(t.isDevelopment&&t.isViewNode(r)&&!P.has(r.tag.id))k(n,r,r);return{refs:o,node:r}};const M=(t,e)=>{const n=new Map;if(Array.isArray(e)){const r=[];for(const s in e){const o=[s];r.push(R(t,e,o,n).node)}return{refs:n,node:r}}else return R(t,e,[],n)};const $=(t,{path:e,consumer:n})=>{const r=S(t.element,e);if(r==null)throw new Error("Internal error: element not found by ref");if(n instanceof Function)n(r);else t.state[n]=r};const D=(t,e,n)=>{var r=true;var s=false;var o=undefined;try{for(var i=n.keys()[Symbol.iterator](),l;!(r=(l=i.next()).done);r=true){const r=l.value;if(e==null||!e.has(r))$(t,n.get(r));else{const s=e.get(r);const o=n.get(r);if(s.consumer!==o.consumer)$(t,o)}}}catch(t){s=true;o=t}finally{try{if(!r&&i.return!=null){i.return()}}finally{if(s){throw o}}}};const T=(t,e)=>{var n=true;var r=false;var s=undefined;try{for(var o=e.values()[Symbol.iterator](),i;!(n=(i=o.next()).done);n=true){const e=i.value.consumer;if(e instanceof Function)e(null);else t.state[e]=null}}catch(t){r=true;s=t}finally{try{if(!n&&o.return!=null){o.return()}}finally{if(r){throw s}}}};const F=(n="ref")=>e.compose(t.mapTemplate(t=>e=>{const r=t();const s=M(n,r),o=s.refs,i=s.node;e.state[O].next=o;return i}),t.withLifecycle({create:t=>{t.state[O]={prev:null,next:null}},mount:t=>{D(t,t.state[O].prev,t.state[O].next);t.state[O].prev=t.state[O].next},update:t=>{D(t,t.state[O].prev,t.state[O].next);t.state[O].prev=t.state[O].next},unmount:t=>{T(t,t.state[O].next);t.state[O].prev=null}}));const L={};L.finishUpdate=(t=>({state:n})=>{const r=i({},n.store,{},t);if(!e.shallowEqual(n.store,r))return{store:r}});L.update=(t=>(function(){var e=r(function*({state:e,actions:n}){let r=i({},e.store);let s=t;if(t instanceof Function)s=t(r);if(s instanceof Promise)s=yield s;if(s!=null)yield n.finishUpdate(s)});return function(t){return e.apply(this,arguments)}})());const V=t=>(function(){var e=r(function*(...e){const n=yield t(...e);return n.store});return function(){return e.apply(this,arguments)}})();const q=Symbol.for("__malina_store");const I=e.compose(t.withContext(({state:t,actions:e})=>({[q]:{state:t.store,update:e.update}})));const U=t.view(t.withTemplate(({children:t})=>t),t.withActions(L),I);const z=e=>t.decorator(n=>({state:r,children:s})=>t.h(U,{store:e},t.h(n,r,s)));const G=(...t)=>({});const H=(e=G,n=G)=>t.getContext(t=>{if(q in t){const r=t[q];const s=e!=null?e:G;const o=n!=null?n:G;return i({},s(r.state)||{},{},o(r.update)||{})}else return{}});const W=t=>e.memoize(n=>{const r=V(n);const s={};var o=true;var i=false;var l=undefined;try{for(var a=e.keys(t)[Symbol.iterator](),c;!(o=(c=a.next()).done);o=true){const e=c.value;const o=t[e];if(o instanceof Function)s[e]=((...t)=>r(o(...t)));else s[e]=W(o)(n)}}catch(t){i=true;l=t}finally{try{if(!o&&a.return!=null){a.return()}}finally{if(i){throw l}}}return s});const B=t=>t instanceof t.ownerDocument.defaultView.HTMLTemplateElement;const J=t=>t.split("-").length>=2;const K=t=>{if(!J(t))throw new Error(`"${t}" is not valid custom element name`)};const Q=(n,r,s,{shadow:o="open",observe:i={}})=>(class extends n.HTMLElement{constructor(...t){const e=super(...t);this.view=null;this.childObserver=new n.MutationObserver(this.handleChildMutations.bind(this));this.expectedRemove=[];this.waitingChildren=true;return e}static get observedAttributes(){return i!=null?Array.isArray(i)?i:e.keys(i):[]}connectedCallback(){if(this.view==null){const u=this.attachShadow({mode:o});const f={};var e=true;var s=false;var l=undefined;try{for(var a=this.attributes[Symbol.iterator](),c;!(e=(c=a.next()).done);e=true){const t=c.value;if(i!=null&&t.name in i)f[i[t.name]]=t.value;else f[t.name]=t.value}}catch(t){s=true;l=t}finally{try{if(!e&&a.return!=null){a.return()}}finally{if(s){throw l}}}const d=Array.from(this.childNodes);this.view=t.instantiate(n.document,t.h(r,f,d));const h=this.view.render();if(!B(h))throw new Error("Root element of a web-component must be a 'template' element");if(h.hasAttributes())throw new Error("Root element of a web-component must not have any attributes");u.appendChild(h.content)}this.view.attach(this.shadowRoot);this.childObserver.observe(this,{childList:true})}disconnectedCallback(){this.childObserver.disconnect();this.view.unmount()}attributeChangedCallback(t,e,n){if(this.view!=null){if(i!=null&&t in i)this.view.update({[i[t]]:n});else this.view.update({[t]:n})}}destroy(){this.view.destroy()}handleChildMutations(t){var e=true;var n=false;var r=undefined;try{for(var s=t[Symbol.iterator](),o;!(e=(o=s.next()).done);e=true){const t=o.value;if(t.type==="childList"){this.updateChildren(t);break}}}catch(t){n=true;r=t}finally{try{if(!e&&s.return!=null){s.return()}}finally{if(n){throw r}}}}updateChildren(t){if(this.waitingChildren){this.waitingChildren=false;const t=Array.from(this.childNodes);this.expectedRemove=t;this.view.update(null,t)}else{const e=this.expectedRemove.length;if(e!==t.removedNodes.length){this.waitingChildren=true;this.updateChildren(t);return}for(let n=0;n<e;n++){const e=this.expectedRemove[n];const r=t.removedNodes[n];if(e!==r){this.waitingChildren=true;this.updateChildren(t);return}}this.waitingChildren=true;this.expectedRemove=null}}});const X=(e,n,r={})=>{K(n);return t.decorator(t=>{if("customElements"in e){const s=Q(e,t,n,r);e.customElements.define(n,s);return s}return null})};const Y=()=>{const e=t.getGlobal();if(!("window"in e))throw new Error('"window" not found in global scope');return e.window};const Z=(...t)=>{if(t.length===1){const e=Y();return X(e,t[0])}else if(t.length===2){if(typeof t[0]==="string"){const e=Y();return X(e,t[0],t[1])}else return X(t[0],t[1])}else return X(t[0],t[1],t[2])};exports.cssModules=p;exports.withUniqIds=C;exports.withRefs=F;exports.withStore=z;exports.connect=H;exports.bindActions=W;exports.webComponent=Z;
