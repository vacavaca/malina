"use strict";Object.defineProperty(exports,"__esModule",{value:true});function r(r){return r&&typeof r==="object"&&"default"in r?r["default"]:r}var t=require("malina-decorator");var p=require("malina-util");var y=require("malina");var a=r(require("path-to-regexp"));function o(r){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){o=function(r){return typeof r}}else{o=function(r){return r&&typeof Symbol==="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r}}return o(r)}function u(r,t,e){if(t in r){Object.defineProperty(r,t,{value:e,enumerable:true,configurable:true,writable:true})}else{r[t]=e}return r}function d(t){for(var r=1;r<arguments.length;r++){var e=arguments[r]!=null?arguments[r]:{};var n=Object.keys(e);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(e).filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))}n.forEach(function(r){u(t,r,e[r])})}return t}function i(r,t){if(r==null)return{};var e={};var n=Object.keys(r);var o,u;for(u=0;u<n.length;u++){o=n[u];if(t.indexOf(o)>=0)continue;e[o]=r[o]}return e}function l(r,t){if(r==null)return{};var e=i(r,t);var n,o;if(Object.getOwnPropertySymbols){var u=Object.getOwnPropertySymbols(r);for(o=0;o<u.length;o++){n=u[o];if(t.indexOf(n)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(r,n))continue;e[n]=r[n]}}return e}var e=function r(n){return{push:function r(t,e){n.push(t,e)},replace:function r(t,e){n.replace(t,e)},forward:function r(){n.forward()},back:function r(){n.back()}}};var n=function r(t){return{history:t,control:e(t)}};var c=Symbol("update");var f=Symbol("subscription");var s=p.compose(t.withHooks({create:function r(o){return function(r,t,e){o();var n=t.router;t[f]=n.history.listen(e[c])}},destroy:function r(n){return function(r,t,e){if(f in t)t[f]();n()}}}),t.withActions(u({},c,function(r){return function(){return{location:r}}})));var v=t.mapState(function(r){return d({router:r.router.control,location:r.location||r.router.history.location},p.omit(["history","router"],r))});var h=Symbol("router");var m=p.compose(t.getContext(function(r){return h in r?{router:r[h]}:{}}),t.withContext(function(r){if(r==null||!("history"in r)&&!("router"in r))throw new Error("History object must be provided to the top-level routing view");if("history"in r&&!("router"in r)){var t=n(r.history);return u({},h,t)}else return{}}));var b=p.compose(m,v);var g=p.compose(s,m,v);var w=new Map;var x=1e4;var O=function r(t,e){var n=Object.keys(e);if(!n.every(function(r){var t=e[r];return o(t)!=="object"&&typeof t!=="function"}))return null;n.sort();return"".concat(t).concat(n.map(function(r){return"".concat(r,":").concat(e[r])}).join(","))};var j=function r(t,e){var n=O(t,e);if(w.has(n))return w.get(n);else{var o=[];var u=a(t,o,e);var i={regexp:u,keys:o};if(w.size<x)w.set(n,i);return i}};var S=function r(t,e){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var o=j(e,n),u=o.regexp,i=o.keys;var a=u.exec(t);if(!a)return null;var l=a.slice(1);var c=i.reduce(function(r,t,e){return((r[t.name]=l[e]||null)||true)&&r},{});return c};var k=function r(t,e){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var o=n.hash?t.hash:t.pathname;if(n.hash&&!o.startsWith("#"))o="#".concat(o);if(!n.hash&&!o.startsWith("/"))o="/".concat(o);return S(o,e,n)};var P=Symbol("route");var E=y.view(function(r,t){var e=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var n=e[0];if(e.length>1)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");var o=k(r.location,r.path,d({},r.options,{hash:!!r.hash}));return n instanceof Function?n(o):n},u({},P,true));var R=p.compose(t.withState(u({},P,true)),g)(E);var A=function s(v){var h=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return function(r){var t=y.isViewNode(r);var e=t&&r.tag.state!=null;var n=null;if(e){var o=r.tag.state;n=o instanceof Function?o(r.attrs):o;e=n[P]}if(e){var u=r.attrs;var i=r.children;var a=k(v,u.path,d({},u.options,{hash:!!u.hash}));if(a==null)return null;if(i.length>1){if(h)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(i)){return p.flatten(i.map(s(v))).filter(function(r){return r!=null})}else return s(v)(i)}else if(i.length===1){var l=i[0];var c=l instanceof Function?l(a):l;if(Array.isArray(c)){return p.flatten(c.map(s(v))).filter(function(r){return r!=null})}else return s(v)(c)}else return null}else if(!y.isTextNode(r)){var f=p.flatten(r.children.map(s(v))).filter(function(r){return r!=null});return y.h(r.tag,r.attrs,f)}else return r}};var C=g(y.view(function(r,t,e){if(e.length===0)return null;var n=e.map(A(r.location,true)).filter(function(r){return r!=null});if(n.length===0)return null;if(n.length>1)throw new Error("Root element must be defined inside Switch node");return n[0]}));var q={to:null,target:null,replace:false,state:{}};var K={};K.handleClick=function(l){return function(r){var t=r.router,e=r.to,n=r.target,o=r.replace,u=r.state;if(e==null)return;var i=!!(l.metaKey||l.altKey||l.ctrlKey||l.shiftKey);if(!l.defaultPrevented&&l.button===0&&(!n||n==="_self")&&!i){l.preventDefault();var a=o?t.replace:t.push;a(e,u)}}};var F=b(y.view(function(r,t,e){var n=r.to,o=l(r,["to"]);return y.h("a",d({href:n,onClick:t.handleClick},p.omit(["router","replace","state"],o)),e)},q,K));exports.Switch=C;exports.Route=R;exports.match=k;exports.Link=F;exports.withRouter=b;exports.connectRouter=g;
