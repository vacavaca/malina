"use strict";Object.defineProperty(exports,"__esModule",{value:true});function t(t){return t&&typeof t==="object"&&"default"in t?t["default"]:t}var e=require("malina-decorator");var r=require("malina-util");var n=require("malina");var o=t(require("path-to-regexp"));function i(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function s(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};var n=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))}n.forEach(function(e){i(t,e,r[e])})}return t}function l(t,e){if(t==null)return{};var r={};var n=Object.keys(t);var o,i;for(i=0;i<n.length;i++){o=n[i];if(e.indexOf(o)>=0)continue;r[o]=t[o]}return r}function c(t,e){if(t==null)return{};var r=l(t,e);var n,o;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(o=0;o<i.length;o++){n=i[o];if(e.indexOf(n)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,n))continue;r[n]=t[n]}}return r}const u=t=>({push(e,r){t.push(e,r)},replace(e,r){t.replace(e,r)},forward(){t.forward()},back(){t.back()}});const a=t=>({history:t,control:u(t)});const f=Symbol.for("__malina_router_update");const h=Symbol.for("__malina_router_subscription");const p=r.compose(e.withHooks({create:t=>(e,r,n)=>{t();const o=r.router;r[h]=o.history.listen(n[f])},destroy:t=>(e,r,n)=>{if(h in r)r[h]();t()}}),e.withActions({[f]:t=>()=>({location:t})}));const y=e.mapState(t=>s({router:t.router.control,location:t.location||t.router.history.location},r.omit(["history","router"],t)));const m=e.mapState(t=>s({router:t.router.control},r.omit(["history","router"],t)));const b=Symbol.for("__malina_router");const d=r.compose(e.getContext(t=>b in t?{router:t[b]}:{}),e.withContext(t=>{if(t==null||!("history"in t)&&!("router"in t))throw new Error("History object must be provided to the top-level routing view");if("history"in t&&!("router"in t)){const e=a(t.history);return{[b]:e}}else return{}}));const w=r.compose(d,m);const v=r.compose(p,d,y);const g=new Map;const O=1e4;const j=(t,e)=>{const r=Object.keys(e);if(!r.every(t=>{const r=e[t];return typeof r!=="object"&&typeof r!=="function"}))return null;r.sort();return`${t}${r.map(t=>`${t}:${e[t]}`).join(",")}`};const x=(t,e)=>{const r=j(t,e);if(g.has(r))return g.get(r);else{const n=[];const i=o(t,n,e);const s={regexp:i,keys:n};if(g.size<O)g.set(r,s);return s}};const _=(t,e,r={})=>{const n=x(e,r),o=n.regexp,i=n.keys;const s=o.exec(t);if(!s)return null;const l=s.slice(1);const c=i.reduce((t,e,r)=>((t[e.name]=l[r]||null)||true)&&t,{});return c};const S=(t,e,r={})=>{let n=r.hash?t.hash:t.pathname;if(r.hash&&!n.startsWith("#"))n=`#${n}`;if(!r.hash&&!n.startsWith("/"))n=`/${n}`;return _(n,e,r)};const k=Symbol.for("__malina_route");const P=n.view((t,e,r=[])=>{const n=r[0];if(r.length>1)throw new Error("You must provide only one child to the Route, it can be a render function or a jsx node");const o=S(t.location,t.path,s({},t.options,{hash:!!t.hash}));return n instanceof Function?n(o):n},{[k]:true});const E=r.compose(e.withState({[k]:true}),v)(P);const $=(t,e=false)=>o=>{const i=n.isViewNode(o);let l=i&&o.tag.state!=null;let c=null;if(l){const t=o.tag.state;c=t instanceof Function?t(o.attrs):t;l=c[k]}if(l){const n=o.attrs;const i=o.children;const l=S(t,n.path,s({},n.options,{hash:!!n.hash}));if(l==null)return null;if(i.length>1){if(e)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(i)){return r.flatten(i.map($(t))).filter(t=>t!=null)}else return $(t)(i)}else if(i.length===1){const e=i[0];const n=e instanceof Function?e(l):e;if(Array.isArray(n)){return r.flatten(n.map($(t))).filter(t=>t!=null)}else return $(t)(n)}else return null}else if(n.isElementNode(o)){const e=r.flatten(o.children.map($(t))).filter(t=>t!=null);return n.h(o.tag,o.attrs,e)}else return o};const A=v(n.view((t,e,r)=>{if(r.length===0)return null;const n=r.map($(t.location,true)).filter(t=>t!=null);if(n.length===0)return null;if(n.length>1)throw new Error("Only one root node is allowed inside Switch");return n[0]}));const C={to:null,target:null,replace:false,state:{}};const R={};R.handleClick=(t=>({router:e,to:r,target:n,replace:o,state:i})=>{if(r==null)return;const s=!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);if(!t.defaultPrevented&&t.button===0&&(!n||n==="_self")&&!s){t.preventDefault();const n=o?e.replace:e.push;n(r,i)}});var q=w(n.view((t,e,o)=>{let i=t.to,l=c(t,["to"]);return n.h("a",s({href:i,onClick:e.handleClick},r.omit(["router","replace","state"],l)),o)},C,R));exports.Switch=A;exports.Route=E;exports.match=S;exports.Link=q;exports.withRouter=w;exports.connectRouter=v;
