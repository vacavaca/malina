"use strict";Object.defineProperty(exports,"__esModule",{value:true});function t(t){return t&&typeof t==="object"&&"default"in t?t["default"]:t}var e=require("malina");var r=require("malina-util");var o=t(require("path-to-regexp"));function n(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function s(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);if(e)o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable});r.push.apply(r,o)}return r}function i(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};if(e%2){s(r,true).forEach(function(e){n(t,e,r[e])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(t,Object.getOwnPropertyDescriptors(r))}else{s(r).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}}return t}function c(t,e){if(t==null)return{};var r={};var o=Object.keys(t);var n,s;for(s=0;s<o.length;s++){n=o[s];if(e.indexOf(n)>=0)continue;r[n]=t[n]}return r}function a(t,e){if(t==null)return{};var r=c(t,e);var o,n;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(n=0;n<s.length;n++){o=s[n];if(e.indexOf(o)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,o))continue;r[o]=t[o]}}return r}const l=t=>({push(e,r){t.push(e,r)},replace(e,r){t.replace(e,r)},forward(){t.forward()},back(){t.back()}});const u=t=>({history:t,control:l(t)});const f=Symbol.for("__malina_router_update");const h=Symbol.for("__malina_router_subscription");const p=r.compose(e.withLifecycle({create:t=>{const e=t.state.router;t.state[h]=e.history.listen(t.actions[f])},destroy:t=>{if(h in t.state)t.state[h]()}}),e.withActions({[f]:t=>()=>({location:t})}));const y=e.withLifecycle({create:t=>{t.state=i({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})},update:t=>{t.state=i({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})}});const w=e.withLifecycle({create:t=>{t.state=i({},t.state||{},{router:t.state.router.control})},update:t=>{t.state=i({},t.state||{},{router:t.state.router.control})}});const d=Symbol.for("__malina_router");const b=(t=null)=>r.compose(e.getContext(t=>d in t?{router:t[d]}:{}),e.withContext(({state:e})=>{if(e==null||!(t in e)&&!("router"in e))throw new Error("History object must be provided to the top-level routing view");if(t in e&&!("router"in e)){const r=u(e[t]);e.router=r;return{[d]:r}}else return{}}));const m=(t="history")=>r.compose(b(t),w);const v=(t="history")=>r.compose(b(t),p,y);const g=new Map;const O=1e4;const j=(t,e)=>{const r=Object.keys(e);if(!r.every(t=>{const r=e[t];return typeof r!=="object"&&typeof r!=="function"}))return null;r.sort();return`${t}${r.map(t=>`${t}:${e[t]}`).join(",")}`};const x=(t,e)=>{const r=j(t,e);if(g.has(r))return g.get(r);else{const n=[];const s=o(t,n,e);const i={regexp:s,keys:n};if(g.size<O)g.set(r,i);return i}};const _=(t,e,r={})=>{const o=x(e,r),n=o.regexp,s=o.keys;const i=n.exec(t);if(!i)return null;const c=i.slice(1);const a=s.reduce((t,e,r)=>((t[e.name]=c[r]||null)||true)&&t,{});return a};const P=(t,e,r={})=>{let o=r.hash?t.hash:t.pathname;if(r.hash&&!o.startsWith("#"))o=`#${o}`;if(!r.hash&&!o.startsWith("/"))o=`/${o}`;return _(o,e,r)};const k=Symbol.for("__malina_route");const S=e.view(e.withTemplate(({state:t,children:r=[]})=>{const o=r[0];if(r.length>1)throw new Error("You must provide only one child to the Route, it can be a render function or a jsx node");const n=P(t.location,t.path,i({},t.options,{hash:!!t.hash}));return e.h(e.Id,{},o instanceof Function?o(n):o)}),e.withActions({[k]:()=>({[k]:true})}),v());const E=t=>e.isViewNode(t)&&t.tag.is(S);const A=(t,o=false)=>n=>{let s=E(n);if(s){const e=n.attrs;const s=n.children;const c=P(t,e.path,i({},e.options,{hash:!!e.hash}));if(c==null)return null;if(s.length>1){if(o)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(s)){return r.flatten(s.map(A(t))).filter(t=>t!=null)}else return A(t)(s)}else if(s.length===1){const e=s[0];const o=e instanceof Function?e(c):e;if(Array.isArray(o)){return r.flatten(o.map(A(t))).filter(t=>t!=null)}else return A(t)(o)}else return null}else if(e.isElementNode(n)){const o=r.flatten(n.children.map(A(t))).filter(t=>t!=null);return e.h(n.tag,n.attrs,o)}else return n};const $=e.view(e.withTemplate(({state:t,children:e})=>{if(e.length===0)return null;const r=e.map(A(t.location,true)).filter(t=>t!=null);if(r.length===0)return null;if(r.length>1)throw new Error("Only one root node is allowed inside Switch");return r[0]}),v());const C={to:null,target:null,replace:false,state:{},view:"a"};const D=["router","to","replace","state","view"];const R=t=>({state:{router:e,to:r,target:o,replace:n,state:s}})=>{if(r==null)return;const i=!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);if(!t.defaultPrevented&&t.button===0&&(!o||o==="_self")&&!i){t.preventDefault();const o=n?e.replace:e.push;o(r,s)}};var K=e.view(e.withTemplate(t=>{let o=t.state,n=o.to,s=o.view,c=a(o,["to","view"]),l=t.actions,u=t.children;return e.h(s,i({href:n,onClick:l.handleClick},r.omit([D],c)),u)}),e.withState(C),e.withActions({handleClick:R}),m());exports.Switch=$;exports.Route=S;exports.match=P;exports.Link=K;exports.withRouter=m;exports.connectRouter=v;
