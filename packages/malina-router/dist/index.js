"use strict";Object.defineProperty(exports,"__esModule",{value:true});function t(t){return t&&typeof t==="object"&&"default"in t?t["default"]:t}var e=require("malina-decorator");var r=require("malina-util");var n=require("malina");var o=t(require("path-to-regexp"));function s(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function i(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};var n=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))}n.forEach(function(e){s(t,e,r[e])})}return t}function a(t,e){if(t==null)return{};var r={};var n=Object.keys(t);var o,s;for(s=0;s<n.length;s++){o=n[s];if(e.indexOf(o)>=0)continue;r[o]=t[o]}return r}function l(t,e){if(t==null)return{};var r=a(t,e);var n,o;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(o=0;o<s.length;o++){n=s[o];if(e.indexOf(n)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,n))continue;r[n]=t[n]}}return r}const c=t=>({push(e,r){t.push(e,r)},replace(e,r){t.replace(e,r)},forward(){t.forward()},back(){t.back()}});const u=t=>({history:t,control:c(t)});const f=Symbol.for("__malina_router_update");const h=Symbol.for("__malina_router_subscription");const p=r.compose(e.withLifecycle({create:t=>{const e=t.state.router;t.state[h]=e.history.listen(t.actions[f])},destroy:t=>{if(h in t.state)t.state[h]()}}),e.withActions({[f]:t=>()=>({location:t})}));const y=e.withLifecycle({create:t=>{t.state=i({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})},update:t=>{t.state=i({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})}});const d=e.withLifecycle({create:t=>{t.state=i({},t.state||{},{router:t.state.router.control})},update:t=>{t.state=i({},t.state||{},{router:t.state.router.control})}});const m=Symbol.for("__malina_router");const w=(t=null)=>r.compose(e.getContext(t=>m in t?{router:t[m]}:{}),e.withContext(({state:e})=>{if(e==null||!(t in e)&&!("router"in e))throw new Error("History object must be provided to the top-level routing view");if(t in e&&!("router"in e)){const r=u(e[t]);e.router=r;return{[m]:r}}else return{}}));const b=(t="history")=>r.compose(w(t),d);const v=(t="history")=>r.compose(w(t),p,y);const g=new Map;const O=1e4;const j=(t,e)=>{const r=Object.keys(e);if(!r.every(t=>{const r=e[t];return typeof r!=="object"&&typeof r!=="function"}))return null;r.sort();return`${t}${r.map(t=>`${t}:${e[t]}`).join(",")}`};const x=(t,e)=>{const r=j(t,e);if(g.has(r))return g.get(r);else{const n=[];const s=o(t,n,e);const i={regexp:s,keys:n};if(g.size<O)g.set(r,i);return i}};const _=(t,e,r={})=>{const n=x(e,r),o=n.regexp,s=n.keys;const i=o.exec(t);if(!i)return null;const a=i.slice(1);const l=s.reduce((t,e,r)=>((t[e.name]=a[r]||null)||true)&&t,{});return l};const k=(t,e,r={})=>{let n=r.hash?t.hash:t.pathname;if(r.hash&&!n.startsWith("#"))n=`#${n}`;if(!r.hash&&!n.startsWith("/"))n=`/${n}`;return _(n,e,r)};const S=Symbol.for("__malina_route");const P=n.view(e.withTemplate(({state:t,children:e=[]})=>{const r=e[0];if(e.length>1)throw new Error("You must provide only one child to the Route, it can be a render function or a jsx node");const n=k(t.location,t.path,i({},t.options,{hash:!!t.hash}));return r instanceof Function?r(n):r}),e.withActions({[S]:()=>({[S]:true})}),v());const A=t=>n.isViewNode(t)&&t.tag.is(P);const E=(t,e=false)=>o=>{let s=A(o);if(s){const n=o.attrs;const s=o.children;const a=k(t,n.path,i({},n.options,{hash:!!n.hash}));if(a==null)return null;if(s.length>1){if(e)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(s)){return r.flatten(s.map(E(t))).filter(t=>t!=null)}else return E(t)(s)}else if(s.length===1){const e=s[0];const n=e instanceof Function?e(a):e;if(Array.isArray(n)){return r.flatten(n.map(E(t))).filter(t=>t!=null)}else return E(t)(n)}else return null}else if(n.isElementNode(o)){const e=r.flatten(o.children.map(E(t))).filter(t=>t!=null);return n.h(o.tag,o.attrs,e)}else return o};const $=n.view(e.withTemplate(({state:t,children:e})=>{if(e.length===0)return null;const r=e.map(E(t.location,true)).filter(t=>t!=null);if(r.length===0)return null;if(r.length>1)throw new Error("Only one root node is allowed inside Switch");return r[0]}),v());const C={to:null,target:null,replace:false,state:{}};const R=t=>({state:{router:e,to:r,target:n,replace:o,state:s}})=>{if(r==null)return;const i=!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);if(!t.defaultPrevented&&t.button===0&&(!n||n==="_self")&&!i){t.preventDefault();const n=o?e.replace:e.push;n(r,s)}};var q=n.view(e.withTemplate(t=>{let e=t.state,o=e.to,s=l(e,["to"]),a=t.actions,c=t.children;return n.h("a",i({href:o,onClick:a.handleClick},r.omit(["router","replace","state"],s)),c)}),e.withState(C),e.withActions({handleClick:R}),b());exports.Switch=$;exports.Route=P;exports.match=k;exports.Link=q;exports.withRouter=b;exports.connectRouter=v;
