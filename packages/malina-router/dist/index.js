"use strict";Object.defineProperty(exports,"__esModule",{value:true});function t(t){return t&&typeof t==="object"&&"default"in t?t["default"]:t}var e=require("malina-decorator");var r=require("malina-util");var n=require("malina");var o=t(require("path-to-regexp"));function s(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function i(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};var n=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))}n.forEach(function(e){s(t,e,r[e])})}return t}function l(t,e){if(t==null)return{};var r={};var n=Object.keys(t);var o,s;for(s=0;s<n.length;s++){o=n[s];if(e.indexOf(o)>=0)continue;r[o]=t[o]}return r}function c(t,e){if(t==null)return{};var r=l(t,e);var n,o;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(o=0;o<s.length;o++){n=s[o];if(e.indexOf(n)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,n))continue;r[n]=t[n]}}return r}const u=t=>({push(e,r){t.push(e,r)},replace(e,r){t.replace(e,r)},forward(){t.forward()},back(){t.back()}});const a=t=>({history:t,control:u(t)});const f=Symbol("update");const h=Symbol("subscription");const p=r.compose(e.withHooks({create:t=>(e,r,n)=>{t();const o=r.router;r[h]=o.history.listen(n[f])},destroy:t=>(e,r,n)=>{if(h in r)r[h]();t()}}),e.withActions({[f]:t=>()=>({location:t})}));const y=e.mapState(t=>i({router:t.router.control,location:t.location||t.router.history.location},r.omit(["history","router"],t)));const m=e.mapState(t=>i({router:t.router.control},r.omit(["history","router"],t)));const b=Symbol("router");const d=r.compose(e.getContext(t=>b in t?{router:t[b]}:{}),e.withContext(t=>{if(t==null||!("history"in t)&&!("router"in t))throw new Error("History object must be provided to the top-level routing view");if("history"in t&&!("router"in t)){const e=a(t.history);return{[b]:e}}else return{}}));const w=r.compose(d,m);const v=r.compose(p,d,y);const g=new Map;const O=1e4;const x=(t,e)=>{const r=Object.keys(e);if(!r.every(t=>{const r=e[t];return typeof r!=="object"&&typeof r!=="function"}))return null;r.sort();return`${t}${r.map(t=>`${t}:${e[t]}`).join(",")}`};const j=(t,e)=>{const r=x(t,e);if(g.has(r))return g.get(r);else{const n=[];const s=o(t,n,e);const i={regexp:s,keys:n};if(g.size<O)g.set(r,i);return i}};const S=(t,e,r={})=>{const n=j(e,r),o=n.regexp,s=n.keys;const i=o.exec(t);if(!i)return null;const l=i.slice(1);const c=s.reduce((t,e,r)=>((t[e.name]=l[r]||null)||true)&&t,{});return c};const k=(t,e,r={})=>{let n=r.hash?t.hash:t.pathname;if(r.hash&&!n.startsWith("#"))n=`#${n}`;if(!r.hash&&!n.startsWith("/"))n=`/${n}`;return S(n,e,r)};const P=Symbol("route");const E=n.view((t,e,r=[])=>{const n=r[0];if(r.length>1)throw new Error("You must provide only one child to the Route, it can be a render function or a jsx node");const o=k(t.location,t.path,i({},t.options,{hash:!!t.hash}));return n instanceof Function?n(o):n},{[P]:true});const $=r.compose(e.withState({[P]:true}),v)(E);const A=(t,e=false)=>o=>{const s=n.isViewNode(o);let l=s&&o.tag.state!=null;let c=null;if(l){const t=o.tag.state;c=t instanceof Function?t(o.attrs):t;l=c[P]}if(l){const n=o.attrs;const s=o.children;const l=k(t,n.path,i({},n.options,{hash:!!n.hash}));if(l==null)return null;if(s.length>1){if(e)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(s)){return r.flatten(s.map(A(t))).filter(t=>t!=null)}else return A(t)(s)}else if(s.length===1){const e=s[0];const n=e instanceof Function?e(l):e;if(Array.isArray(n)){return r.flatten(n.map(A(t))).filter(t=>t!=null)}else return A(t)(n)}else return null}else if(!n.isTextNode(o)){const e=r.flatten(o.children.map(A(t))).filter(t=>t!=null);return n.h(o.tag,o.attrs,e)}else return o};const C=v(n.view((t,e,r)=>{if(r.length===0)return null;const n=r.map(A(t.location,true)).filter(t=>t!=null);if(n.length===0)return null;if(n.length>1)throw new Error("Only one root node is allowed inside Switch");return n[0]}));const R={to:null,target:null,replace:false,state:{}};const q={};q.handleClick=(t=>({router:e,to:r,target:n,replace:o,state:s})=>{if(r==null)return;const i=!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);if(!t.defaultPrevented&&t.button===0&&(!n||n==="_self")&&!i){t.preventDefault();const n=o?e.replace:e.push;n(r,s)}});var K=w(n.view((t,e,o)=>{let s=t.to,l=c(t,["to"]);return n.h("a",i({href:s,onClick:e.handleClick},r.omit(["router","replace","state"],l)),o)},R,q));exports.Switch=C;exports.Route=$;exports.match=k;exports.Link=K;exports.withRouter=w;exports.connectRouter=v;
