"use strict";Object.defineProperty(exports,"__esModule",{value:true});function t(t){return t&&typeof t==="object"&&"default"in t?t["default"]:t}var e=require("malina-decorator");var r=require("malina-util");var o=require("malina");var n=t(require("path-to-regexp"));function s(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function i(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);if(e)o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable});r.push.apply(r,o)}return r}function c(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};if(e%2){i(r,true).forEach(function(e){s(t,e,r[e])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(t,Object.getOwnPropertyDescriptors(r))}else{i(r).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}}return t}function a(t,e){if(t==null)return{};var r={};var o=Object.keys(t);var n,s;for(s=0;s<o.length;s++){n=o[s];if(e.indexOf(n)>=0)continue;r[n]=t[n]}return r}function l(t,e){if(t==null)return{};var r=a(t,e);var o,n;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(n=0;n<s.length;n++){o=s[n];if(e.indexOf(o)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,o))continue;r[o]=t[o]}}return r}const u=t=>({push(e,r){t.push(e,r)},replace(e,r){t.replace(e,r)},forward(){t.forward()},back(){t.back()}});const f=t=>({history:t,control:u(t)});const h=Symbol.for("__malina_router_update");const p=Symbol.for("__malina_router_subscription");const y=r.compose(e.withLifecycle({create:t=>{const e=t.state.router;t.state[p]=e.history.listen(t.actions[h])},destroy:t=>{if(p in t.state)t.state[p]()}}),e.withActions({[h]:t=>()=>({location:t})}));const w=e.withLifecycle({create:t=>{t.state=c({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})},update:t=>{t.state=c({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})}});const d=e.withLifecycle({create:t=>{t.state=c({},t.state||{},{router:t.state.router.control})},update:t=>{t.state=c({},t.state||{},{router:t.state.router.control})}});const b=Symbol.for("__malina_router");const m=(t=null)=>r.compose(e.getContext(t=>b in t?{router:t[b]}:{}),e.withContext(({state:e})=>{if(e==null||!(t in e)&&!("router"in e))throw new Error("History object must be provided to the top-level routing view");if(t in e&&!("router"in e)){const r=f(e[t]);e.router=r;return{[b]:r}}else return{}}));const v=(t="history")=>r.compose(m(t),d);const g=(t="history")=>r.compose(m(t),y,w);const O=new Map;const j=1e4;const x=(t,e)=>{const r=Object.keys(e);if(!r.every(t=>{const r=e[t];return typeof r!=="object"&&typeof r!=="function"}))return null;r.sort();return`${t}${r.map(t=>`${t}:${e[t]}`).join(",")}`};const _=(t,e)=>{const r=x(t,e);if(O.has(r))return O.get(r);else{const o=[];const s=n(t,o,e);const i={regexp:s,keys:o};if(O.size<j)O.set(r,i);return i}};const P=(t,e,r={})=>{const o=_(e,r),n=o.regexp,s=o.keys;const i=n.exec(t);if(!i)return null;const c=i.slice(1);const a=s.reduce((t,e,r)=>((t[e.name]=c[r]||null)||true)&&t,{});return a};const k=(t,e,r={})=>{let o=r.hash?t.hash:t.pathname;if(r.hash&&!o.startsWith("#"))o=`#${o}`;if(!r.hash&&!o.startsWith("/"))o=`/${o}`;return P(o,e,r)};const S=Symbol.for("__malina_route");const E=o.view(e.withTemplate(({state:t,children:e=[]})=>{const r=e[0];if(e.length>1)throw new Error("You must provide only one child to the Route, it can be a render function or a jsx node");const n=k(t.location,t.path,c({},t.options,{hash:!!t.hash}));return o.h(o.Id,{},r instanceof Function?r(n):r)}),e.withActions({[S]:()=>({[S]:true})}),g());const A=t=>o.isViewNode(t)&&t.tag.is(E);const $=(t,e=false)=>n=>{let s=A(n);if(s){const o=n.attrs;const s=n.children;const i=k(t,o.path,c({},o.options,{hash:!!o.hash}));if(i==null)return null;if(s.length>1){if(e)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(s)){return r.flatten(s.map($(t))).filter(t=>t!=null)}else return $(t)(s)}else if(s.length===1){const e=s[0];const o=e instanceof Function?e(i):e;if(Array.isArray(o)){return r.flatten(o.map($(t))).filter(t=>t!=null)}else return $(t)(o)}else return null}else if(o.isElementNode(n)){const e=r.flatten(n.children.map($(t))).filter(t=>t!=null);return o.h(n.tag,n.attrs,e)}else return n};const C=o.view(e.withTemplate(({state:t,children:e})=>{if(e.length===0)return null;const r=e.map($(t.location,true)).filter(t=>t!=null);if(r.length===0)return null;if(r.length>1)throw new Error("Only one root node is allowed inside Switch");return r[0]}),g());const D={to:null,target:null,replace:false,state:{},view:"a"};const R=["router","to","replace","state","view"];const q=t=>({state:{router:e,to:r,target:o,replace:n,state:s}})=>{if(r==null)return;const i=!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);if(!t.defaultPrevented&&t.button===0&&(!o||o==="_self")&&!i){t.preventDefault();const o=n?e.replace:e.push;o(r,s)}};var K=o.view(e.withTemplate(t=>{let e=t.state,n=e.to,s=e.view,i=l(e,["to","view"]),a=t.actions,u=t.children;return o.h(s,c({href:n,onClick:a.handleClick},r.omit([R],i)),u)}),e.withState(D),e.withActions({handleClick:q}),v());exports.Switch=C;exports.Route=E;exports.match=k;exports.Link=K;exports.withRouter=v;exports.connectRouter=g;
