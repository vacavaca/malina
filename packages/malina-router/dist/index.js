"use strict";Object.defineProperty(exports,"__esModule",{value:true});function t(t){return t&&typeof t==="object"&&"default"in t?t["default"]:t}var e=require("malina-decorator");var r=require("malina-util");var o=require("malina");var n=t(require("path-to-regexp"));function s(t,e,r){if(e in t){Object.defineProperty(t,e,{value:r,enumerable:true,configurable:true,writable:true})}else{t[e]=r}return t}function i(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};var o=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){o=o.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))}o.forEach(function(e){s(t,e,r[e])})}return t}function a(t,e){if(t==null)return{};var r={};var o=Object.keys(t);var n,s;for(s=0;s<o.length;s++){n=o[s];if(e.indexOf(n)>=0)continue;r[n]=t[n]}return r}function l(t,e){if(t==null)return{};var r=a(t,e);var o,n;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(n=0;n<s.length;n++){o=s[n];if(e.indexOf(o)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,o))continue;r[o]=t[o]}}return r}const c=t=>({push(e,r){t.push(e,r)},replace(e,r){t.replace(e,r)},forward(){t.forward()},back(){t.back()}});const u=t=>({history:t,control:c(t)});const f=Symbol.for("__malina_router_update");const h=Symbol.for("__malina_router_subscription");const p=r.compose(e.withLifecycle({create:t=>{const e=t.state.router;t.state[h]=e.history.listen(t.actions[f])},destroy:t=>{if(h in t.state)t.state[h]()}}),e.withActions({[f]:t=>()=>({location:t})}));const y=e.withLifecycle({create:t=>{t.state=i({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})},update:t=>{t.state=i({},t.state||{},{router:t.state.router.control,location:t.state.location||t.state.router.history.location})}});const w=e.withLifecycle({create:t=>{t.state=i({},t.state||{},{router:t.state.router.control})},update:t=>{t.state=i({},t.state||{},{router:t.state.router.control})}});const d=Symbol.for("__malina_router");const m=(t=null)=>r.compose(e.getContext(t=>d in t?{router:t[d]}:{}),e.withContext(({state:e})=>{if(e==null||!(t in e)&&!("router"in e))throw new Error("History object must be provided to the top-level routing view");if(t in e&&!("router"in e)){const r=u(e[t]);e.router=r;return{[d]:r}}else return{}}));const b=(t="history")=>r.compose(m(t),w);const v=(t="history")=>r.compose(m(t),p,y);const g=new Map;const O=1e4;const j=(t,e)=>{const r=Object.keys(e);if(!r.every(t=>{const r=e[t];return typeof r!=="object"&&typeof r!=="function"}))return null;r.sort();return`${t}${r.map(t=>`${t}:${e[t]}`).join(",")}`};const x=(t,e)=>{const r=j(t,e);if(g.has(r))return g.get(r);else{const o=[];const s=n(t,o,e);const i={regexp:s,keys:o};if(g.size<O)g.set(r,i);return i}};const _=(t,e,r={})=>{const o=x(e,r),n=o.regexp,s=o.keys;const i=n.exec(t);if(!i)return null;const a=i.slice(1);const l=s.reduce((t,e,r)=>((t[e.name]=a[r]||null)||true)&&t,{});return l};const k=(t,e,r={})=>{let o=r.hash?t.hash:t.pathname;if(r.hash&&!o.startsWith("#"))o=`#${o}`;if(!r.hash&&!o.startsWith("/"))o=`/${o}`;return _(o,e,r)};const S=Symbol.for("__malina_route");const P=o.view(e.withTemplate(({state:t,children:e=[]})=>{const r=e[0];if(e.length>1)throw new Error("You must provide only one child to the Route, it can be a render function or a jsx node");const n=k(t.location,t.path,i({},t.options,{hash:!!t.hash}));return o.h(o.Id,{},r instanceof Function?r(n):r)}),e.withActions({[S]:()=>({[S]:true})}),v());const A=t=>o.isViewNode(t)&&t.tag.is(P);const E=(t,e=false)=>n=>{let s=A(n);if(s){const o=n.attrs;const s=n.children;const a=k(t,o.path,i({},o.options,{hash:!!o.hash}));if(a==null)return null;if(s.length>1){if(e)throw new Error("You must provide ony one child to Route it can be a render function or a jsx node");if(Array.isArray(s)){return r.flatten(s.map(E(t))).filter(t=>t!=null)}else return E(t)(s)}else if(s.length===1){const e=s[0];const o=e instanceof Function?e(a):e;if(Array.isArray(o)){return r.flatten(o.map(E(t))).filter(t=>t!=null)}else return E(t)(o)}else return null}else if(o.isElementNode(n)){const e=r.flatten(n.children.map(E(t))).filter(t=>t!=null);return o.h(n.tag,n.attrs,e)}else return n};const $=o.view(e.withTemplate(({state:t,children:e})=>{if(e.length===0)return null;const r=e.map(E(t.location,true)).filter(t=>t!=null);if(r.length===0)return null;if(r.length>1)throw new Error("Only one root node is allowed inside Switch");return r[0]}),v());const C={to:null,target:null,replace:false,state:{},view:"a"};const R=["router","to","replace","state","view"];const q=t=>({state:{router:e,to:r,target:o,replace:n,state:s}})=>{if(r==null)return;const i=!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey);if(!t.defaultPrevented&&t.button===0&&(!o||o==="_self")&&!i){t.preventDefault();const o=n?e.replace:e.push;o(r,s)}};var K=o.view(e.withTemplate(t=>{let e=t.state,n=e.to,s=e.view,a=l(e,["to","view"]),c=t.actions,u=t.children;return o.h(s,i({href:n,onClick:c.handleClick},r.omit([R],a)),u)}),e.withState(C),e.withActions({handleClick:q}),b());exports.Switch=$;exports.Route=P;exports.match=k;exports.Link=K;exports.withRouter=b;exports.connectRouter=v;
