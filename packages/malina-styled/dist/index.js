"use strict";Object.defineProperty(exports,"__esModule",{value:true});function e(e){return e&&typeof e==="object"&&"default"in e?e["default"]:e}var t=require("malina-util");var s=require("malina");var i=e(require("stylis"));var r=require("malina-decorator");class l{constructor(e){this.index=[];this.map=new Map;this.compare=e}get size(){return this.map.size}has(e){return this.map.has(e)}get(e){return this.map.get(e)}set(e,t,s=null){if(!this.has(e)){const t=s!==null?s:this.insertPoint(e);this.index.splice(t,0,e)}this.map.set(e,t)}delete(e,s=null){if(this.has(e)){let i=s!==null?s:t.binarySearch(e,this.index,this.compare);let r=0;while(this.index[i+r]!==e&&this.index[i-r]!==e)r+=1;i=this.index[i+r]===e?i+r:i-r;this.index.splice(i,1)}this.map.delete(e)}insertPoint(e){const s=t.binarySearch(e,this.index,this.compare);return s>=0?s:-s-1}lastKey(){return this.index[this.index.length-1]}last(){return this.get(this.lastKey())}*values(){var e=true;var t=false;var s=undefined;try{for(var i=this.keys()[Symbol.iterator](),r;!(e=(r=i.next()).done);e=true){const e=r.value;yield this.map.get(e)}}catch(e){t=true;s=e}finally{try{if(!e&&i.return!=null){i.return()}}finally{if(t){throw s}}}}*keys(){let e=0;for(;e<this.index.length;e++){const t=this.index.length;yield this.index[e];const s=this.index.length;e-=t-s}}*keysAfter(e){const s=t.binarySearch(e,this.index,this.compare);const i=s>=0?s+1:-s;let r=i;for(;r<this.index.length;r++){const e=this.index.length;yield this.index[r];const t=this.index.length;r-=e-t}}*valuesAfter(e){var t=true;var s=false;var i=undefined;try{for(var r=this.keysAfter(e)[Symbol.iterator](),l;!(t=(l=r.next()).done);t=true){const e=l.value;yield this.map.get(e)}}catch(e){s=true;i=e}finally{try{if(!t&&r.return!=null){r.return()}}finally{if(s){throw i}}}}*[Symbol.iterator](){var e=true;var t=false;var s=undefined;try{for(var i=this.keys()[Symbol.iterator](),r;!(e=(r=i.next()).done);e=true){const e=r.value;yield[e,this.map.get(e)]}}catch(e){t=true;s=e}finally{try{if(!e&&i.return!=null){i.return()}}finally{if(t){throw s}}}}}class n{constructor(e){this.injector=e;this.mainStyles=new l;this.mediaStyles=new l;this.skippedMainStyles=new Map;this.skippedMediaStyles=new Map}add(e){var t=true;var s=false;var i=undefined;try{for(var r=e[Symbol.iterator](),l;!(t=(l=r.next()).done);t=true){const e=l.value;if(!this.injector.useMediaStyles||!e.isMedia())this.addMainStyle(e);else this.addMediaStyle(e)}}catch(e){s=true;i=e}finally{try{if(!t&&r.return!=null){r.return()}}finally{if(s){throw i}}}}update(e){var t=true;var s=false;var i=undefined;try{for(var r=e[Symbol.iterator](),l;!(t=(l=r.next()).done);t=true){const e=l.value;if(!this.injector.useMediaStyles||!e.isMedia())this.updateMainStyle(e);else this.updateMediaStyle(e)}}catch(e){s=true;i=e}finally{try{if(!t&&r.return!=null){r.return()}}finally{if(s){throw i}}}}delete(e){var t=true;var s=false;var i=undefined;try{for(var r=e[Symbol.iterator](),l;!(t=(l=r.next()).done);t=true){const e=l.value;if(this.mainStyles.has(e))this.deleteMainStyle(e);else if(this.skippedMainStyles.has(e))this.skippedMainStyles.delete(e);else if(this.mediaStyles.has(e))this.deleteMediaStyle(e);else if(this.skippedMediaStyles.has(e))this.skippedMediaStyles.delete(e)}}catch(e){s=true;i=e}finally{try{if(!t&&r.return!=null){r.return()}}finally{if(s){throw i}}}}addMainStyle(e){if(this.mainStyles.has(e.id)||this.skippedMainStyles.has(e.id))return;const t=this.mainStyles.insertPoint(e.id);const i=this.injector.insertMainStyle(e,t);if(i){this.mainStyles.set(e.id,e,t);this.skippedMainStyles.delete(e.id)}else{this.skippedMainStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}updateMainStyle(e,t){if(this.mainStyles.has(e.id)&&this.mainStyles.get(e.id).rules===e.rules)return;if(this.skippedMainStyles.has(e.id)&&this.skippedMainStyles.get(e.id).rules===e.rules)return;this.injector.deleteMainStyle(t,1);const i=this.injector.insertMainStyle(e,t);if(i){this.mainStyles.set(e.id,e,t);this.skippedMainStyles.delete(e.id)}else{this.skippedMainStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}deleteMainStyle(e,t=null){if(this.mainStyles.has(e)){this.injector.deleteMainStyle(t,1);this.mainStyles.delete(e,t)}else if(this.skippedMainStyles.has(e))this.skippedMainStyles.delete(e)}addMediaStyle(e){if(this.mediaStyles.has(e.id)||this.skippedMediaStyles.has(e.id))return;const t=this.injector.insertMediaStyle(e);if(t){this.mediaStyles.set(e.id,e);this.skippedMediaStyles.delete(e.id)}else{this.skippedMediaStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}updateMediaStyle(e){if(this.mediaStyles.has(e.id)&&this.mediaStyles.get(e.id).rules===e.rules)return;if(this.skippedMediaStyles.has(e.id)&&this.skippedMediaStyles.get(e.id).rules===e.rules)return;this.injector.deleteMediaStyle(e.id);const t=this.injector.insertMediaStyle(e);if(t){this.mediaStyles.set(e.id,e);this.skippedMediaStyles.delete(e.id)}else{this.skippedMediaStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}deleteMediaStyle(e,t=null){if(this.mediaStyles.has(e)){this.injector.deleteMediaStyle(e);this.mediaStyles.delete(e,t)}else if(this.skippedMediaStyles.has(e))this.addMainStyle.skippedMediaStyles.delete(e)}}const a=e=>{if(e.sheet)return e.sheet;const t=document.styleSheets.length;for(let s=0;s<t;s+=1){const t=document.styleSheets[s];if(t.ownerNode===e)return t}throw new Error("Stylesheet not found for tag")};class o{constructor(){this.document=null;this.styleElement=null;this.stylesheet=null;this.mediaStyleElements={};this.mediaStylesheets={};this.useMediaStyles=false;this.clients=new Map;this.updater=new n(this)}createMediaStyleElement(e,t){const s=document.createElement("style");s.setAttribute("media",t);document.head.appendChild(s);this.mediaStyleElements[e]=s;this.mediaStylesheets[e]=a(s)}hasMediaStyleElement(e){return e in this.mediaStyleElements}getMediaStyleElement(e){return this.mediaStyleElements[e]}deleteMediaStyleElement(e){this.mediaStyleElements[e].remove();delete this.mediaStyleElements[e];delete this.mediaStylesheets[e]}getMediaStylesheet(e){return this.mediaStylesheets[e]}mount(e,t){if(this.clients.has(e))return;if(this.document===null){this.document=t;this.styleElement=t.createElement("style");t.head.appendChild(this.styleElement);this.stylesheet=a(this.styleElement);this.useMediaStyles=!("insertRule"in this.stylesheet)}this.clients.set(e,new Map)}isMounted(e){return this.clients.has(e)}update(e,t){if(!this.clients.has(e))throw new Error("Unknown style client");const s=new Map;const i=[];const r=[];const l=[];var n=true;var a=false;var o=undefined;try{for(var h=t[Symbol.iterator](),d;!(n=(d=h.next()).done);n=true){const e=d.value;let t=true;var u=true;var c=false;var y=undefined;try{for(var f=this.clients.keys()[Symbol.iterator](),m;!(u=(m=f.next()).done);u=true){const s=m.value;if(this.clients.get(s).has(e.id)){t=false;break}}}catch(e){c=true;y=e}finally{try{if(!u&&f.return!=null){f.return()}}finally{if(c){throw y}}}if(t)i.push(e);else r.push(e);s.set(e.id,e)}}catch(e){a=true;o=e}finally{try{if(!n&&h.return!=null){h.return()}}finally{if(a){throw o}}}var p=true;var S=false;var v=undefined;try{for(var g=this.clients.get(e)[Symbol.iterator](),M;!(p=(M=g.next()).done);p=true){const e=M.value;if(!s.has(e.id))l.push(e)}}catch(e){S=true;v=e}finally{try{if(!p&&g.return!=null){g.return()}}finally{if(S){throw v}}}this.clients.set(e,s);this.updater.add(i);this.updater.update(r);this.updater.delete(l)}destroy(e){if(!this.clients.has(e))return;this.update(e,[]);this.clients.delete(e);if(this.clients.size===0){this.destroyElements();this.document=null;this.styleElement=null;this.stylesheet=null;this.mediaStyleElements={};this.mediaStylesheets={};this.useMediaStyles=false}}insertMainStyle(e,t){if(!e.rules)return true;return this.insertStyle(this.stylesheet,e.selector,e.rules,t)}deleteMainStyle(e,t){const s=e;for(let e=s;e>s-t;e-=1)this.stylesheet.deleteRule(e)}insertMediaStyle(e){if(e.parsedRule.rules.length===0)return;if(!this.hasMediaStyleElement(e.id))this.createMediaStyleElement(e.id,e.atRule);const t=this.getMediaStylesheet(e.id);let s=true;for(const i in e.parsedRule.rules){const r=e.parsedRule.rules[i];s=this.insertStyle(t,r.selector,r.getStyle(),i);if(!s)break}if(!s)this.deleteMediaStyleElement(e.id);return s}deleteMediaStyle(e){this.deleteMediaStyleElement(e)}insertStyle(e,t,s,i){if(!s)return true;const r=e.cssRules.length;try{const l=i<=r?i:r;if("insertRule"in e)e.insertRule(`${t}{${s}}`,l);else if("addRule"in e)e.addRule(t,s);return true}catch(e){return false}}destroyElements(){this.styleElement.remove();for(var e=0,t=Object.values(this.mediaStyleElements);e<t.length;e++){const s=t[e];s.remove()}}}function h(e){for(var t=e.length|0,s=t|0,i=0,r;t>=4;){r=e.charCodeAt(i)&255|(e.charCodeAt(++i)&255)<<8|(e.charCodeAt(++i)&255)<<16|(e.charCodeAt(++i)&255)<<24,r=1540483477*(r&65535)+((1540483477*(r>>>16)&65535)<<16),r^=r>>>24,r=1540483477*(r&65535)+((1540483477*(r>>>16)&65535)<<16),s=1540483477*(s&65535)+((1540483477*(s>>>16)&65535)<<16)^r,t-=4,++i}switch(t){case 3:s^=(e.charCodeAt(i+2)&255)<<16;case 2:s^=(e.charCodeAt(i+1)&255)<<8;case 1:s^=e.charCodeAt(i)&255,s=1540483477*(s&65535)+((1540483477*(s>>>16)&65535)<<16)}s^=s>>>13;s=1540483477*(s&65535)+((1540483477*(s>>>16)&65535)<<16);return(s^s>>>15)>>>0}class d{constructor(e){this.selector=e;this.rules=[];this.style=null}getStyle(){if(this.style!==null)return this.style;else return this.rules.map(e=>`${e.selector}{${e.style}}`).join("")}setStyle(e){this.style=e;return this}}const u="{";const c="}";var y=e=>{const t=[];let s=0;let i=null;let r=null;for(let l=0;l<e.length;l++){const n=e[l];if(n===u){if(r===null)r=e.slice(s,l).trim();else{const n=new d(r);t.push(n);i=n;r=e.slice(s,l).trim()}s=l+1}else if(n===c){if(r!==null){const n=e.slice(s,l).trim();const a=new d(r).setStyle(n);if(i!==null)i.rules.push(a);else t.push(a);r=null}else i=null;s=l+1}}return t};const f=(e,t)=>{let s="";for(let i=0;i<`${e}`.length-`${t}`.length;i++)s+="0";s+=`${t}`;return s};class m{constructor(e,t,s,i,r){this.parentSelector=e;this.selector=t.trim();this.rules=s.trim();this.parsedRule=i;this.atRuleIdentifier=null;this.atRule=null;if(this.selector.startsWith("@")){const e=/@(\S*)\s+(.*)\s*(;|{|$)/g;const t=e.exec(this.selector);this.atRuleIdentifier=t[1];this.atRule=t[2]}this.id=`${r}${this.isAtRule()?`${this.parentSelector}${this.selector}`:`${this.selector}`}`}static parse(e,t){const s=new i({global:true,cascade:true,keyframe:true,prefix:true,compress:true,preserve:false});const r=s(`.${e}`,t);const l=y(r);return l.map((t,s)=>new m(e,t.selector,t.getStyle(),t,f(l.length,s)))}isAtRule(){return this.atRuleIdentifier!=null}isMedia(){return this.atRuleIdentifier==="media"}toString(){return`${this.selector}{${this.rules}}`}}class p{constructor(){this.list=[];this.selectors={}}add(e){this.list.push(e);if(!(e.selector in this.selectors))this.selectors[e.selector]=[];this.selectors[e.selector].push(e)}addAll(e){var t=true;var s=false;var i=undefined;try{for(var r=e[Symbol.iterator](),l;!(t=(l=r.next()).done);t=true){const e=l.value;this.add(e)}}catch(e){s=true;i=e}finally{try{if(!t&&r.return!=null){r.return()}}finally{if(s){throw i}}}}has(e){return e in this.selectors}[Symbol.iterator](){return this.list[Symbol.iterator]()}}const S=Symbol.for("__malina_styled.injector");const v=Symbol.for("__malina_styled.list");const g=Symbol.for("__malina_styled.original");const M=r.compose(r.getContext(e=>S in e?{[S]:e[S]}:{}),r.withContext(({state:e})=>{if(!(S in e)){const t=new o;e[S]=t;return{[S]:t}}return{}}));const w=(e,t,s)=>{let i=t;let r=1;while(i in e&&e[i]!==s){i=`${t}_${r}`;r+=1}return i};const b=e=>{const t={};for(const s in e)t[s[0]==="$"&&s[1]!=="$"?s.slice(1):s]=e[s];return t};const x=e=>{const t={};for(const s in e){if(s[0]==="$"&&s[1]==="$")t[s.slice(1)]=e[s];else if(s[0]!=="$")t[s]=e[s]}return t};const k="123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ";const E=e=>{var t="";while(e){var s=e%58;e=Math.floor(e/58);t=k[s].toString()+t}return t};const $=(e,t)=>i=>{if(s.isViewNode(i)){if(i.tag.isStyled){const r=i.tag.factory(b(i.attrs));if(r.length===0){const r=x(i.attrs);return s.h(i.tag.tag,r,i.children.map($(e,t)))}const l=h(r);const n=w(t,`v${i.tag.id}_${E(l)}`,r);if(!(n in t)){t[n]=r;const s=i.tag.parse(n,r);e.addAll(s)}const a=x(i.attrs);a.class=[a.class||"",n].filter(e=>e.length>0).join(" ");return s.h(i.tag.tag,a,i.children.map($(e,t)))}else return s.h(i.tag,i.attrs,i.children.map($(e,t)))}else if(s.isElementNode(i))return s.h(i.tag,i.attrs,i.children.map($(e,t)));else return i};const j=r.mapTemplate(e=>({state:t})=>{const s=e();t[g]={};t[v]=new p;return $(t[v],t[g])(s)});const R=r.withState(()=>({[v]:new p,[g]:{}}));const A=r.withLifecycle({mount:e=>{const t=e.state[S];t.mount(e,e.element.ownerDocument);t.update(e,e.state[v])},update:e=>{const t=e.state[S];if(!t.isMounted(e))return;t.update(e,e.state[v])},destroy:e=>{const t=e.state[S];if(!t.isMounted(e))return;t.destroy(e)}});var _=e=>r.compose(R,r.withTemplate(e),j,M,A);const C=1e3;const q=(e,i)=>{let r=null;const l=s.view(_(({state:t,children:l})=>{if(r==null)r=q(e,i);return s.h(r,t,l)}));l.isStyled=true;l.tag=e;l.factory=i;l.parse=t.memoize(m.parse,C);return l};var I=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","big","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","marquee","menu","menuitem","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","param","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr","circle","clipPath","defs","ellipse","foreignObject","g","image","line","linearGradient","marker","mask","path","pattern","polygon","polyline","radialGradient","rect","stop","svg","text","tspan"];const z=100;const P=e=>{const t=e.join("");return()=>t};const N=(e,s)=>t.memoize(t=>{let i="";let r=true;let l=0;while(l<e.length){if(r)i+=e[l];else{const e=s[l];i+=e instanceof Function?e(t):`${e}`}r=l>=s.length||!r;if(r)l+=1}return i},z,t.shallowEqual);const T=(e,t)=>t.length>0?N(e,t):P(e);const F=(...e)=>t=>e.map(e=>e(t)).join("");const G=e=>(t,...s)=>{if(e==null)throw new Error("Nothing to extend");if(!e.isStyled)throw new Error("Styled views can only extend other styled views");return q(e.tag,F(e.factory,T(t,s)))};var K=true;var O=false;var D=undefined;try{for(var L=I[Symbol.iterator](),U;!(K=(U=L.next()).done);K=true){const e=U.value;G[e]=((t,...s)=>q(e,T(t,s)))}}catch(e){O=true;D=e}finally{try{if(!K&&L.return!=null){L.return()}}finally{if(O){throw D}}}const V=(...e)=>s.view(_(...e));const W=(...e)=>t=>{const s=e[0]instanceof Function?e[0](t):t[e[0]];if(e.length===2)return s?e[1]:"";else if(e.length===3)return s===e[1]?e[2]:"";else return""};exports.styledTemplate=V;exports.only=W;exports.withStyledTemplate=_;exports.styled=G;
