"use strict";Object.defineProperty(exports,"__esModule",{value:true});function e(e){return e&&typeof e==="object"&&"default"in e?e["default"]:e}var t=require("malina-util");var s=require("malina");var i=e(require("stylis"));var l=require("malina-decorator");class r{constructor(e){this.index=[];this.map=new Map;this.compare=e}get size(){return this.map.size}has(e){return this.map.has(e)}get(e){return this.map.get(e)}set(e,t,s=null){if(!this.has(e)){const t=s!==null?s:this.insertPoint(e);this.index.splice(t,0,e)}this.map.set(e,t)}delete(e,s=null){if(this.has(e)){let i=s!==null?s:t.binarySearch(e,this.index,this.compare);let l=0;while(this.index[i+l]!==e&&this.index[i-l]!==e)l+=1;i=this.index[i+l]===e?i+l:i-l;this.index.splice(i,1)}this.map.delete(e)}insertPoint(e){const s=t.binarySearch(e,this.index,this.compare);return s>=0?s:-s-1}lastKey(){return this.index[this.index.length-1]}last(){return this.get(this.lastKey())}*values(){var e=true;var t=false;var s=undefined;try{for(var i=this.keys()[Symbol.iterator](),l;!(e=(l=i.next()).done);e=true){const e=l.value;yield this.map.get(e)}}catch(e){t=true;s=e}finally{try{if(!e&&i.return!=null){i.return()}}finally{if(t){throw s}}}}*keys(){let e=0;for(;e<this.index.length;e++){const t=this.index.length;yield this.index[e];const s=this.index.length;e-=t-s}}*keysAfter(e){const s=t.binarySearch(e,this.index,this.compare);const i=s>=0?s+1:-s;let l=i;for(;l<this.index.length;l++){const e=this.index.length;yield this.index[l];const t=this.index.length;l-=e-t}}*valuesAfter(e){var t=true;var s=false;var i=undefined;try{for(var l=this.keysAfter(e)[Symbol.iterator](),r;!(t=(r=l.next()).done);t=true){const e=r.value;yield this.map.get(e)}}catch(e){s=true;i=e}finally{try{if(!t&&l.return!=null){l.return()}}finally{if(s){throw i}}}}*[Symbol.iterator](){var e=true;var t=false;var s=undefined;try{for(var i=this.keys()[Symbol.iterator](),l;!(e=(l=i.next()).done);e=true){const e=l.value;yield[e,this.map.get(e)]}}catch(e){t=true;s=e}finally{try{if(!e&&i.return!=null){i.return()}}finally{if(t){throw s}}}}}class n{constructor(e){this.injector=e;this.mainStyles=new r;this.mediaStyles=new r;this.skippedMainStyles=new Map;this.skippedMediaStyles=new Map}add(e){var t=true;var s=false;var i=undefined;try{for(var l=e[Symbol.iterator](),r;!(t=(r=l.next()).done);t=true){const e=r.value;if(!this.injector.useMediaStyles||!e.isMedia())this.addMainStyle(e);else this.addMediaStyle(e)}}catch(e){s=true;i=e}finally{try{if(!t&&l.return!=null){l.return()}}finally{if(s){throw i}}}}update(e){var t=true;var s=false;var i=undefined;try{for(var l=e[Symbol.iterator](),r;!(t=(r=l.next()).done);t=true){const e=r.value;if(!this.injector.useMediaStyles||!e.isMedia())this.updateMainStyle(e);else this.updateMediaStyle(e)}}catch(e){s=true;i=e}finally{try{if(!t&&l.return!=null){l.return()}}finally{if(s){throw i}}}}delete(e){var t=true;var s=false;var i=undefined;try{for(var l=e[Symbol.iterator](),r;!(t=(r=l.next()).done);t=true){const e=r.value;if(this.mainStyles.has(e))this.deleteMainStyle(e);else if(this.skippedMainStyles.has(e))this.skippedMainStyles.delete(e);else if(this.mediaStyles.has(e))this.deleteMediaStyle(e);else if(this.skippedMediaStyles.has(e))this.skippedMediaStyles.delete(e)}}catch(e){s=true;i=e}finally{try{if(!t&&l.return!=null){l.return()}}finally{if(s){throw i}}}}addMainStyle(e){if(this.mainStyles.has(e.id)||this.skippedMainStyles.has(e.id))return;const t=this.mainStyles.insertPoint(e.id);const i=this.injector.insertMainStyle(e,t);if(i){this.mainStyles.set(e.id,e,t);this.skippedMainStyles.delete(e.id)}else{this.skippedMainStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}updateMainStyle(e,t){if(this.mainStyles.has(e.id)&&this.mainStyles.get(e.id).rules===e.rules)return;if(this.skippedMainStyles.has(e.id)&&this.skippedMainStyles.get(e.id).rules===e.rules)return;this.injector.deleteMainStyle(t,1);const i=this.injector.insertMainStyle(e,t);if(i){this.mainStyles.set(e.id,e,t);this.skippedMainStyles.delete(e.id)}else{this.skippedMainStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}deleteMainStyle(e,t=null){if(this.mainStyles.has(e)){this.injector.deleteMainStyle(t,1);this.mainStyles.delete(e,t)}else if(this.skippedMainStyles.has(e))this.skippedMainStyles.delete(e)}addMediaStyle(e){if(this.mediaStyles.has(e.id)||this.skippedMediaStyles.has(e.id))return;const t=this.injector.insertMediaStyle(e);if(t){this.mediaStyles.set(e.id,e);this.skippedMediaStyles.delete(e.id)}else{this.skippedMediaStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}updateMediaStyle(e){if(this.mediaStyles.has(e.id)&&this.mediaStyles.get(e.id).rules===e.rules)return;if(this.skippedMediaStyles.has(e.id)&&this.skippedMediaStyles.get(e.id).rules===e.rules)return;this.injector.deleteMediaStyle(e.id);const t=this.injector.insertMediaStyle(e);if(t){this.mediaStyles.set(e.id,e);this.skippedMediaStyles.delete(e.id)}else{this.skippedMediaStyles.set(e.id,e);s.warn(`Incorrect css:\n${e}`)}}deleteMediaStyle(e,t=null){if(this.mediaStyles.has(e)){this.injector.deleteMediaStyle(e);this.mediaStyles.delete(e,t)}else if(this.skippedMediaStyles.has(e))this.addMainStyle.skippedMediaStyles.delete(e)}}const a=e=>{if(e.sheet)return e.sheet;const t=document.styleSheets.length;for(let s=0;s<t;s+=1){const t=document.styleSheets[s];if(t.ownerNode===e)return t}throw new Error("Stylesheet not found for tag")};class d{constructor(){this.document=null;this.styleElement=null;this.stylesheet=null;this.mediaStyleElements={};this.mediaStylesheets={};this.useMediaStyles=false;this.clients=new Map;this.updater=new n(this)}createMediaStyleElement(e,t){const s=document.createElement("style");s.setAttribute("media",t);document.head.appendChild(s);this.mediaStyleElements[e]=s;this.mediaStylesheets[e]=a(s)}hasMediaStyleElement(e){return e in this.mediaStyleElements}getMediaStyleElement(e){return this.mediaStyleElements[e]}deleteMediaStyleElement(e){this.mediaStyleElements[e].remove();delete this.mediaStyleElements[e];delete this.mediaStylesheets[e]}getMediaStylesheet(e){return this.mediaStylesheets[e]}mount(e,t){if(this.clients.has(e))return;if(this.document===null){this.document=t;this.styleElement=t.createElement("style");t.head.appendChild(this.styleElement);this.stylesheet=a(this.styleElement);this.useMediaStyles=!("insertRule"in this.stylesheet)}this.clients.set(e,new Map)}update(e,t){const s=new Map;const i=[];const l=[];const r=[];var n=true;var a=false;var d=undefined;try{for(var o=t[Symbol.iterator](),h;!(n=(h=o.next()).done);n=true){const e=h.value;let t=true;var u=true;var c=false;var y=undefined;try{for(var f=this.clients.keys()[Symbol.iterator](),m;!(u=(m=f.next()).done);u=true){const s=m.value;if(this.clients.get(s).has(e.id)){t=false;break}}}catch(e){c=true;y=e}finally{try{if(!u&&f.return!=null){f.return()}}finally{if(c){throw y}}}if(t)i.push(e);else l.push(e);s.set(e.id,e)}}catch(e){a=true;d=e}finally{try{if(!n&&o.return!=null){o.return()}}finally{if(a){throw d}}}var p=true;var S=false;var v=undefined;try{for(var M=this.clients.get(e)[Symbol.iterator](),g;!(p=(g=M.next()).done);p=true){const e=g.value;if(!s.has(e.id))r.push(e)}}catch(e){S=true;v=e}finally{try{if(!p&&M.return!=null){M.return()}}finally{if(S){throw v}}}this.clients.set(e,s);this.updater.add(i);this.updater.update(l);this.updater.delete(r)}destroy(e){if(!this.clients.has(e))return;this.update(e,[]);this.clients.delete(e);if(this.clients.size===0){this.destroyElements();this.document=null;this.styleElement=null;this.stylesheet=null;this.mediaStyleElements={};this.mediaStylesheets={};this.useMediaStyles=false}}insertMainStyle(e,t){if(!e.rules)return true;return this.insertStyle(this.stylesheet,e.selector,e.rules,t)}deleteMainStyle(e,t){const s=e;for(let e=s;e>s-t;e-=1)this.stylesheet.deleteRule(e)}insertMediaStyle(e){if(e.parsedRule.rules.length===0)return;if(!this.hasMediaStyleElement(e.id))this.createMediaStyleElement(e.id,e.atRule);const t=this.getMediaStylesheet(e.id);let s=true;for(const i in e.parsedRule.rules){const l=e.parsedRule.rules[i];s=this.insertStyle(t,l.selector,l.getStyle(),i);if(!s)break}if(!s)this.deleteMediaStyleElement(e.id);return s}deleteMediaStyle(e){this.deleteMediaStyleElement(e)}insertStyle(e,t,s,i){if(!s)return true;const l=e.cssRules.length;try{const r=i<=l?i:l;if("insertRule"in e)e.insertRule(`${t}{${s}}`,r);else if("addRule"in e)e.addRule(t,s);return true}catch(e){return false}}destroyElements(){this.styleElement.remove();for(var e=0,t=Object.values(this.mediaStyleElements);e<t.length;e++){const s=t[e];s.remove()}}}function o(e){for(var t=e.length|0,s=t|0,i=0,l;t>=4;){l=e.charCodeAt(i)&255|(e.charCodeAt(++i)&255)<<8|(e.charCodeAt(++i)&255)<<16|(e.charCodeAt(++i)&255)<<24,l=1540483477*(l&65535)+((1540483477*(l>>>16)&65535)<<16),l^=l>>>24,l=1540483477*(l&65535)+((1540483477*(l>>>16)&65535)<<16),s=1540483477*(s&65535)+((1540483477*(s>>>16)&65535)<<16)^l,t-=4,++i}switch(t){case 3:s^=(e.charCodeAt(i+2)&255)<<16;case 2:s^=(e.charCodeAt(i+1)&255)<<8;case 1:s^=e.charCodeAt(i)&255,s=1540483477*(s&65535)+((1540483477*(s>>>16)&65535)<<16)}s^=s>>>13;s=1540483477*(s&65535)+((1540483477*(s>>>16)&65535)<<16);return(s^s>>>15)>>>0}class h{constructor(e){this.selector=e;this.rules=[];this.style=null}getStyle(){if(this.style!==null)return this.style;else return this.rules.map(e=>`${e.selector}{${e.style}}`).join("")}setStyle(e){this.style=e;return this}}const u="{";const c="}";var y=e=>{const t=[];let s=0;let i=null;let l=null;for(let r=0;r<e.length;r++){const n=e[r];if(n===u){if(l===null)l=e.slice(s,r).trim();else{const n=new h(l);t.push(n);i=n;l=e.slice(s,r).trim()}s=r+1}else if(n===c){if(l!==null){const n=e.slice(s,r).trim();const a=new h(l).setStyle(n);if(i!==null)i.rules.push(a);else t.push(a);l=null}else i=null;s=r+1}}return t};class f{constructor(e,t,s,i){this.parentSelector=e;this.selector=t.trim();this.rules=s.trim();this.parsedRule=i;this.atRuleIdentifier=null;this.atRule=null;if(this.selector.startsWith("@")){const e=/@(\S*)\s+(.*)\s*(;|{|$)/g;const t=e.exec(this.selector);this.atRuleIdentifier=t[1];this.atRule=t[2]}this.id=this.isAtRule()?`${this.parentSelector}${this.selector}`:this.selector}static parse(e,t){const s=new i({global:true,cascade:true,keyframe:true,prefix:true,compress:true,preserve:false});const l=s(`.${e}`,t);const r=y(l);return r.map(t=>new f(e,t.selector,t.getStyle(),t))}isAtRule(){return this.atRuleIdentifier!=null}isMedia(){return this.atRuleIdentifier==="media"}toString(){return`${this.selector}{${this.rules}}`}}class m{constructor(){this.list=[];this.selectors={}}add(e){this.list.push(e);if(!(e.selector in this.selectors))this.selectors[e.selector]=[];this.selectors[e.selector].push(e)}addAll(e){var t=true;var s=false;var i=undefined;try{for(var l=e[Symbol.iterator](),r;!(t=(r=l.next()).done);t=true){const e=r.value;this.add(e)}}catch(e){s=true;i=e}finally{try{if(!t&&l.return!=null){l.return()}}finally{if(s){throw i}}}}has(e){return e in this.selectors}[Symbol.iterator](){return this.list[Symbol.iterator]()}}const p=Symbol.for("__malina_styled.injector");const S=Symbol.for("__malina_styled.list");const v=Symbol.for("__malina_styled.original");const M=l.compose(l.getContext(e=>p in e?{[p]:e[p]}:{}),l.withContext(({state:e})=>{if(!(p in e)){const t=new d;e[p]=t;return{[p]:t}}return{}}));const g=(e,t,s)=>{let i=t;let l=1;while(i in e&&e[i]!==s){i=`${t}_${l}`;l+=1}return i};const w=e=>{const t={};for(const s in e)t[s[0]==="$"&&s[1]!=="$"?s.slice(1):s]=e[s];return t};const b=e=>{const t={};for(const s in e){if(s[0]==="$"&&s[1]==="$")t[s.slice(1)]=e[s];else if(s[0]!=="$")t[s]=e[s]}return t};const x="123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ";const k=e=>{var t="";while(e){var s=e%58;e=Math.floor(e/58);t=x[s].toString()+t}return t};const E=(e,t)=>i=>{if(s.isViewNode(i)){if(i.tag.isStyled){const l=i.tag.factory(w(i.attrs));if(l.length===0){const l=b(i.attrs);return s.h(i.tag.tag,l,i.children.map(E(e,t)))}const r=o(l);const n=g(t,`v${i.tag.id}_${k(r)}`,l);if(!(n in t)){t[n]=l;const s=i.tag.parse(n,l);e.addAll(s)}const a=b(i.attrs);a.class=[a.class||"",n].filter(e=>e.length>0).join(" ");return s.h(i.tag.tag,a,i.children.map(E(e,t)))}else return i}else if(s.isElementNode(i))return s.h(i.tag,i.attrs,i.children.map(E(e,t)));else return i};const $=l.mapTemplate(e=>({state:t})=>{const s=e();t[v]={};t[S]=new m;return E(t[S],t[v])(s)});const j=l.withState(()=>({[S]:new m,[v]:{}}));const R=l.withLifecycle({mount:e=>{const t=e.state[p];t.mount(e,e.element.ownerDocument);t.update(e,e.state[S])},update:e=>{const t=e.state[p];t.update(e,e.state[S])},destroy:e=>{const t=e.state[p];t.destroy(e)}});var A=e=>l.compose(j,l.withTemplate(e),$,M,R);const _=1e3;const C=(e,i)=>{let l=null;const r=s.view(A(({state:t,children:r})=>{if(l==null)l=C(e,i);return s.h(l,t,r)}));r.isStyled=true;r.tag=e;r.factory=i;r.parse=t.memoize(f.parse,_);return r};var q=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","big","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","marquee","menu","menuitem","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","param","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr","circle","clipPath","defs","ellipse","foreignObject","g","image","line","linearGradient","marker","mask","path","pattern","polygon","polyline","radialGradient","rect","stop","svg","text","tspan"];const I=100;const z=e=>{const t=e.join("");return()=>t};const P=(e,s)=>t.memoize(t=>{let i="";let l=true;let r=0;while(r<e.length){if(l)i+=e[r];else i+=s[r](t);l=r>=s.length||!l;if(l)r+=1}return i},I,t.shallowEqual);const N=(e,t)=>t.length>0?P(e,t):z(e);const T=(...e)=>t=>e.map(e=>e(t)).join("");const G=e=>(t,...s)=>{if(e==null)throw new Error("Nothing to extend");if(!e.isStyled)throw new Error("Styled views can only extend other styled views");return C(e.tag,T(e.factory,N(t,s)))};var K=true;var O=false;var D=undefined;try{for(var F=q[Symbol.iterator](),L;!(K=(L=F.next()).done);K=true){const e=L.value;G[e]=((t,...s)=>C(e,N(t,s)))}}catch(e){O=true;D=e}finally{try{if(!K&&F.return!=null){F.return()}}finally{if(O){throw D}}}const V=(...e)=>s.view(A(...e));const W=(e,t)=>s=>{const i=e instanceof Function?e(s):s[e];return i?t:""};exports.styledTemplate=V;exports.only=W;exports.withStyledTemplate=A;exports.styled=G;
